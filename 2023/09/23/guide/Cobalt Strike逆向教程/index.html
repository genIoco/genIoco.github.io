

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon/favicon.jpg">
  <link rel="icon" href="/img/favicon/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="BadWolf">
  <meta name="keywords" content="">
  
    <meta name="description" content="您是否常常为找不到Cobalt Strike破解版而苦恼呢？您是否仍在担忧Cobalt Strike破解版的安全性呢？快来学习一下Cobalt Strike逆向破解教程教程，通过此教程您将学到Cobalt Strike破解流程，从此安全无忧。">
<meta property="og:type" content="article">
<meta property="og:title" content="Cobalt Strike逆向教程">
<meta property="og:url" content="https://genioco.github.io/2023/09/23/Guide/Cobalt%20Strike%E9%80%86%E5%90%91%E6%95%99%E7%A8%8B/index.html">
<meta property="og:site_name" content="BadWolf&#39;s Blog">
<meta property="og:description" content="您是否常常为找不到Cobalt Strike破解版而苦恼呢？您是否仍在担忧Cobalt Strike破解版的安全性呢？快来学习一下Cobalt Strike逆向破解教程教程，通过此教程您将学到Cobalt Strike破解流程，从此安全无忧。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/8a776b37618f4990abefd61d2ab58d32.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/14852ed34e6f48069ce5162217b3ad71.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/e44e20aa44d44027974fbee2b8d87006.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/556abfe27a664bc6a376a732f2739e42.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/6346e5d49f404931a3bd0bd7952732d1.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/5178070bacb24a1da37b620dd854da16.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/62474be440794507bd87fcd9aa15a89d.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/1f023f4446a14303aadd97df9a9f7e30.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/ee04d9451809402fbc27dd0d9f59bc97.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/530af4d201444ae885f315e4babfb698.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/42014d01b09b4d358fe3556db4c48a03.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/902974f11ef84eb39e6df3d8eb0481c5.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/a8342b6d47a64d68a96b2aedaf612f77.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/85b0d2f85b1c4abebb68f3bf7d413372.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/7350b52f29f540b8a901b4f91a8e34c3.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/f88598e8b22041e6a03550162a9ed235.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/20f2654a7eb54883ad6bd2121166d99e.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/4e9ee1f5215c40508cebb47d5c5a4a8d.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/512b4089f6b247acbd37768a994efc7a.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/5fffa0d83154442b985bf6dec1f937e5.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/7310a58f963742eaa3ef060a02ca4802.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/6947b419be274e609d2fc65c34b9b722.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/f3129d96b1a54cf1bcea5e199381936e.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/9dbc77ded89e4b41936944bfe9235ab2.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/abeca3947c3d49c7b35c2f1a7380fd3a.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/b049dbd0acdd4abfb4634b2c525ec167.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/d58ce23f370140c98c77a60c1cbdf327.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/9c7718b9bd1945cfb05e7bb60689d760.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/cf7834605e184a28830e99e302b29b3b.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/4139400d240b4f54b0906f85d6945ed2.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/3aebebb4b2a448f7ba2e177da3a3e36c.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/a16d9639fbf64560a5801f936478cfca.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/b41fc02727784cd5b677b5277eee2743.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/c265299c704d404dbe21bcddd98e0841.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/direct/43ae1d75ef6b465fafda059e48ca944e.png">
<meta property="article:published_time" content="2023-09-23T08:30:00.000Z">
<meta property="article:modified_time" content="2024-07-12T02:00:00.000Z">
<meta property="article:author" content="BadWolf">
<meta property="article:tag" content="教程">
<meta property="article:tag" content="Cobalt Strike">
<meta property="article:tag" content="逆向破解">
<meta property="article:tag" content="渗透工具">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/direct/8a776b37618f4990abefd61d2ab58d32.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Cobalt Strike逆向教程 - BadWolf&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/js/shubiao.css">
<link rel="stylesheet" href="/js/scroll.css">
<link rel="stylesheet" href="/js/gradient.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"genioco.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":80,"cursorChar":"|","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"839133d5bbdb7688edec52dfcde2a75b","google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?839133d5bbdb7688edec52dfcde2a75b";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>BadWolf&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Cobalt Strike逆向教程"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        BadWolf
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-09-23 16:30" pubdate>
          2023年9月23日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          64 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Cobalt Strike逆向教程</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    <!-- compatible with older versions-->
                    本文最后更新于：2024年7月12日 上午
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <meta name="referrer" content="no-referrer">



<h2 id="工具准备"><a href="#工具准备" class="headerlink" title="工具准备"></a>工具准备</h2><p>​		这里采用的是Cobalt Strike 4.7原版进行逆向教程（因为我没找到最新版的原版程序），Cobalt Strike 4.7原版sha256校验码如下，其他版本校验码请访问校验码官网校验地址：<a target="_blank" rel="noopener" href="https://verify.cobaltstrike.com/">https://verify.cobaltstrike.com/</a></p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm">cobaltstrike.jar sha<span class="hljs-number">256</span>:<br><br><span class="hljs-keyword">c</span><span class="hljs-number">1</span>cda<span class="hljs-number">82</span>b<span class="hljs-number">39</span>fda<span class="hljs-number">2</span>f<span class="hljs-number">77</span><span class="hljs-keyword">c</span><span class="hljs-number">811</span>f<span class="hljs-number">42</span>a<span class="hljs-number">7</span>a<span class="hljs-number">55987</span>adf<span class="hljs-number">37e06</span>a<span class="hljs-number">522</span>ed<span class="hljs-number">6</span>f<span class="hljs-number">28900</span>d<span class="hljs-number">77</span>bbd<span class="hljs-number">4409</span>f<br></code></pre></td></tr></table></figure>

<p>windows可使用以下命令获取校验码</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">certutil -hashfile 文件 [md5|<span class="hljs-type">sha1</span>|<span class="hljs-type">sha256</span>]<br></code></pre></td></tr></table></figure>

<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="反编译程序"><a href="#反编译程序" class="headerlink" title="反编译程序"></a>反编译程序</h3><p>​		我们原版获取到的<code>Cobalt_Strike</code>原版程序都是客户端与服务端合并在一起的，安装的使用重新进行解压，首先我们先将客户端程序提取出来。将<code>cs_bin</code>目录下的<code>Cobalt_Strike_4.7.jar</code>反编译并将反编译后的文件放在<code>cs_src</code>文件夹中，最终也是生成一个jar文件，不同的是此时jar文件中的<code>class</code>文件全部被反编译为<code>java</code>源程序文件。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java -cp java-decompiler<span class="hljs-selector-class">.jar</span> org<span class="hljs-selector-class">.jetbrains</span><span class="hljs-selector-class">.java</span><span class="hljs-selector-class">.decompiler</span><span class="hljs-selector-class">.main</span><span class="hljs-selector-class">.decompiler</span><span class="hljs-selector-class">.ConsoleDecompiler</span> -dgs=true cs_bin\Cobalt_Strike_4.<span class="hljs-number">7</span><span class="hljs-selector-class">.jar</span> cs_src<br></code></pre></td></tr></table></figure>

<p>使用压缩软件直接解压反编译后的<code>jar</code>文件，其目录结构如下</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">E:.<br>│  cobaltstrike-client<span class="hljs-selector-class">.jar</span><br>│  cobaltstrike-client<span class="hljs-selector-class">.md5</span><br>│  cobaltstrike-client<span class="hljs-selector-class">.next</span><span class="hljs-selector-class">.md5</span><br>│  TeamServerImage<br>│  TeamServerImage<span class="hljs-selector-class">.md5</span><br>│  TeamServerImage<span class="hljs-selector-class">.next</span><span class="hljs-selector-class">.md5</span><br>│<br>├─cszip<br>│      CSExtract<span class="hljs-selector-class">.java</span><br>│<br>└─META-INF<br>        MANIFEST.MF<br></code></pre></td></tr></table></figure>

<p>​		看到<code>TeamServerImage</code>是不是有点眼熟呢？<code>TeamServerImage</code>正是服务端的程序，<code>CSExtract.java</code>执行了一些解压操作，这里不做重点；反编译<code>cobaltstrike-client.jar</code>。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java -cp java-decompiler<span class="hljs-selector-class">.jar</span> org<span class="hljs-selector-class">.jetbrains</span><span class="hljs-selector-class">.java</span><span class="hljs-selector-class">.decompiler</span><span class="hljs-selector-class">.main</span><span class="hljs-selector-class">.decompiler</span><span class="hljs-selector-class">.ConsoleDecompiler</span> -dgs=true cs_src\Cobalt_Strike_4.<span class="hljs-number">7</span>\cobaltstrike-client<span class="hljs-selector-class">.jar</span> cs_src\cs_client_src\<br></code></pre></td></tr></table></figure>

<p>​		打开idea，新建项目，创建好后，在项目根目录创建<code>decompiled_src</code>和<code>lib</code>文件夹，分别存放上一步反编译后的<code>cobaltstrike-client.jar</code>和原始未反编译的<code>cobaltstrike-client.jar</code>，将反编译后的<code>cobaltstrike-client.jar</code>解压，项目最终目录结构如下：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">│  .gitignore<br>│  CobaltStrikeCrack.iml<br>│<br>├─.idea<br>│      misc.<span class="hljs-keyword">xml</span><br><span class="hljs-title">│      modules</span>.<span class="hljs-keyword">xml</span><br><span class="hljs-title">│      vcs</span>.<span class="hljs-keyword">xml</span><br><span class="hljs-title">│      workspace</span>.<span class="hljs-keyword">xml</span><br><span class="hljs-title">│</span><br><span class="hljs-title">├─decompiled_src</span><br>│  │  cobaltstrike-client.jar<br>│  │<br>│  └─cobaltstrike-client<br>│      <br>├─lib<br>│      cobaltstrike-client.jar<br>│<br>└─src<br></code></pre></td></tr></table></figure>

<h3 id="添加项目依赖"><a href="#添加项目依赖" class="headerlink" title="添加项目依赖"></a>添加项目依赖</h3><p>选择<code>File-&gt;Project Structure-&gt;Modules</code>对<code>Dependencies</code>进行设置，点击+号选择<code>JARs or Directories...</code></p>
<p><img src="https://img-blog.csdnimg.cn/direct/8a776b37618f4990abefd61d2ab58d32.png" srcset="/img/loading.gif" lazyload alt="image-20230923172941606"></p>
<p>选择<code>lib</code>中的<code>cobaltstrike-client.jar</code>，点击ok，确定<code>export</code>打勾，点击ok，程序反编译完成。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/14852ed34e6f48069ce5162217b3ad71.png" srcset="/img/loading.gif" lazyload alt="image-20230923173025005"></p>
<h3 id="构建工件"><a href="#构建工件" class="headerlink" title="构建工件"></a>构建工件</h3><p>打开<code>lib-&gt;META-INF-&gt;MANIFEST.MF</code>，可以看到Main Class，复制<code>aggressor.Aggressor</code></p>
<p><img src="https://img-blog.csdnimg.cn/direct/e44e20aa44d44027974fbee2b8d87006.png" srcset="/img/loading.gif" lazyload alt="image-20230923202619073"></p>
<p>进入<code>File-&gt;Project Structure-&gt;Artifacts—&gt;JAR—&gt;From modules with dependencies</code>。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/556abfe27a664bc6a376a732f2739e42.png" srcset="/img/loading.gif" lazyload alt="image-20230923202314413"></p>
<p>在<code>Main Class</code>处内填写上面获得的主类名称，点击ok。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/6346e5d49f404931a3bd0bd7952732d1.png" srcset="/img/loading.gif" lazyload alt="image-20230923202341832"></p>
<p>​		此时<code>src</code>目录下生成<code>META-INF</code>配置，打开<code>MANIFEST.MF</code>，将<code>decompiled_src/cobaltstrike-client/META-INF/MANIFEST.MF</code>的内容复制粘贴覆盖，至此工件构建配置完成。</p>
<h3 id="源码编译测试"><a href="#源码编译测试" class="headerlink" title="源码编译测试"></a>源码编译测试</h3><p>进入<code>ecompiled_src/cobaltstrike-client/aggressor/Aggressor.java</code>，右键选择<code>Refactor-&gt;Copy File</code>，在<code>src</code>目录中新建相同路径，即可将<code>Aggressor.java</code>至我们的项目中。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/5178070bacb24a1da37b620dd854da16.png" srcset="/img/loading.gif" lazyload alt="image-20230923203008559"></p>
<p>此时，可以通过<code>Build—&gt;Build Artifacts—&gt;Build</code>进行工件编译，点击<code>Run-&gt;Profile-&gt;Edit Configurations...</code>设置运行参数。</p>
<p>点击+号，选择<code>JAR Application</code>，名字自己定义；<code>Path to JAR</code>选项目生成的<code>jar</code>文件；<code>VM options</code>设置为<code>-XX:+AggressiveHeap -XX:+UseParallelGC</code>。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/62474be440794507bd87fcd9aa15a89d.png" srcset="/img/loading.gif" lazyload alt="image-20230923204356838"></p>
<p>此时，直接运行项目不报错，且弹框输出<code>Your authorization file is not vaild.</code>，证明项目运行成功。</p>
<h2 id="密钥文件生成"><a href="#密钥文件生成" class="headerlink" title="密钥文件生成"></a>密钥文件生成</h2><p>各版本key：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs subunit">27, <span class="hljs-string">-27</span>, <span class="hljs-string">-66</span>, 82, <span class="hljs-string">-58</span>, 37, 92, 51, 85, <span class="hljs-string">-114</span>, <span class="hljs-string">-118</span>, 28, <span class="hljs-string">-74</span>, 103, <span class="hljs-string">-53</span>, 6,        // 4.0 key<br><span class="hljs-string">-128</span>, <span class="hljs-string">-29</span>, 42, 116, 32, 96, <span class="hljs-string">-72</span>, <span class="hljs-string">-124</span>, 65, <span class="hljs-string">-101</span>, <span class="hljs-string">-96</span>, <span class="hljs-string">-63</span>, 113, <span class="hljs-string">-55</span>, <span class="hljs-string">-86</span>, 118,  // 4.1 key<br><span class="hljs-string">-78</span>, 13, 72, 122, <span class="hljs-string">-35</span>, <span class="hljs-string">-44</span>, 113, 52, 24, <span class="hljs-string">-14</span>, <span class="hljs-string">-43</span>, <span class="hljs-string">-93</span>, <span class="hljs-string">-82</span>, 2, <span class="hljs-string">-89</span>, <span class="hljs-string">-96</span>,       // 4.2 key<br>58, 68, 37, 73, 15, 56, <span class="hljs-string">-102</span>, <span class="hljs-string">-18</span>, <span class="hljs-string">-61</span>, 18, <span class="hljs-string">-67</span>, <span class="hljs-string">-41</span>, 88, <span class="hljs-string">-83</span>, 43, <span class="hljs-string">-103</span>, 	    // 4.3 key<br>94, <span class="hljs-string">-104</span>, 25, 74, 1, <span class="hljs-string">-58</span>, <span class="hljs-string">-76</span>, <span class="hljs-string">-113</span>, <span class="hljs-string">-91</span>, <span class="hljs-string">-126</span>, <span class="hljs-string">-90</span>, <span class="hljs-string">-87</span>, <span class="hljs-string">-4</span>, <span class="hljs-string">-69</span>, <span class="hljs-string">-110</span>, <span class="hljs-string">-42</span>,   // 4.4 key<br><span class="hljs-string">-13</span>, <span class="hljs-string">-114</span>, <span class="hljs-string">-77</span>, <span class="hljs-string">-47</span>, <span class="hljs-string">-93</span>, 53, <span class="hljs-string">-78</span>, 82, <span class="hljs-string">-75</span>, <span class="hljs-string">-117</span>, <span class="hljs-string">-62</span>, <span class="hljs-string">-84</span>, <span class="hljs-string">-34</span>, <span class="hljs-string">-127</span>, <span class="hljs-string">-75</span>, 66, // 4.5 key<br><span class="hljs-string">-122</span>, 56, <span class="hljs-string">-75</span>, 17, <span class="hljs-string">-32</span>, 91, 85, 123, <span class="hljs-string">-7</span>, 112, <span class="hljs-string">-60</span>, 24, 53, 109, 68, <span class="hljs-string">-12</span>         // 4.7 key<br><span class="hljs-string">-118</span>, 9, <span class="hljs-string">-22</span>, <span class="hljs-string">-51</span>, <span class="hljs-string">-53</span>, 27, 95, 70, <span class="hljs-string">-99</span>, <span class="hljs-string">-54</span>, 53, 124, <span class="hljs-string">-9</span>, <span class="hljs-string">-7</span>, <span class="hljs-string">-26</span>, 74          // 4.8 key<br>// 4.9 key<br></code></pre></td></tr></table></figure>

<p><strong>cobaltstrike.auth</strong>认证密钥文件，rsa加密，大端存放，解密内容：</p>
<p>4.7</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs subunit"><span class="hljs-string">-54</span>, <span class="hljs-string">-2</span>, <span class="hljs-string">-64</span>, <span class="hljs-string">-45</span>, //文件头<br>0, <span class="hljs-string">-54</span>,	//后续长度<br>1, <span class="hljs-string">-55</span>, <span class="hljs-string">-61</span>, 127, // 证书有效时间，永久有效<br>23, 80, 101, <span class="hljs-string">-22</span>, // watermask<br>47, // 版本号 47<br>16, 27, <span class="hljs-string">-27</span>, <span class="hljs-string">-66</span>, 82, <span class="hljs-string">-58</span>, 37, 92, 51, 85, <span class="hljs-string">-114</span>, <span class="hljs-string">-118</span>, 28, <span class="hljs-string">-74</span>, 103, <span class="hljs-string">-53</span>, 6,        // 4.0 key<br>16, <span class="hljs-string">-128</span>, <span class="hljs-string">-29</span>, 42, 116, 32, 96, <span class="hljs-string">-72</span>, <span class="hljs-string">-124</span>, 65, <span class="hljs-string">-101</span>, <span class="hljs-string">-96</span>, <span class="hljs-string">-63</span>, 113, <span class="hljs-string">-55</span>, <span class="hljs-string">-86</span>, 118,  // 4.1 key<br>16, <span class="hljs-string">-78</span>, 13, 72, 122, <span class="hljs-string">-35</span>, <span class="hljs-string">-44</span>, 113, 52, 24, <span class="hljs-string">-14</span>, <span class="hljs-string">-43</span>, <span class="hljs-string">-93</span>, <span class="hljs-string">-82</span>, 2, <span class="hljs-string">-89</span>, <span class="hljs-string">-96</span>,       // 4.2 key<br>16, 58, 68, 37, 73, 15, 56, <span class="hljs-string">-102</span>, <span class="hljs-string">-18</span>, <span class="hljs-string">-61</span>, 18, <span class="hljs-string">-67</span>, <span class="hljs-string">-41</span>, 88, <span class="hljs-string">-83</span>, 43, <span class="hljs-string">-103</span>, 	    // 4.3 key<br>16, 94, <span class="hljs-string">-104</span>, 25, 74, 1, <span class="hljs-string">-58</span>, <span class="hljs-string">-76</span>, <span class="hljs-string">-113</span>, <span class="hljs-string">-91</span>, <span class="hljs-string">-126</span>, <span class="hljs-string">-90</span>, <span class="hljs-string">-87</span>, <span class="hljs-string">-4</span>, <span class="hljs-string">-69</span>, <span class="hljs-string">-110</span>, <span class="hljs-string">-42</span>,   // 4.4 key<br>16, <span class="hljs-string">-13</span>, <span class="hljs-string">-114</span>, <span class="hljs-string">-77</span>, <span class="hljs-string">-47</span>, <span class="hljs-string">-93</span>, 53, <span class="hljs-string">-78</span>, 82, <span class="hljs-string">-75</span>, <span class="hljs-string">-117</span>, <span class="hljs-string">-62</span>, <span class="hljs-string">-84</span>, <span class="hljs-string">-34</span>, <span class="hljs-string">-127</span>, <span class="hljs-string">-75</span>, 66, // 4.5 key<br>0, 0, 0, 24, // watermask length<br>105, 100, 118, 121, 85, 97, 77, 68, 75, 117, 98, 87, 87, 52, 84, 76, 51, 105, 80, 106, 66, 119, 61, 61, // watermask ascii base64<br>16, <span class="hljs-string">-71</span>, <span class="hljs-string">-86</span>, 51, 8, 10, 90, <span class="hljs-string">-112</span>, 49, 62, <span class="hljs-string">-15</span>, <span class="hljs-string">-99</span>, <span class="hljs-string">-64</span>, 98, 125, 46, <span class="hljs-string">-95</span>, <br>28, <br>115, 53, 57, 108, 53, 105, 113, 49, 101, 106, 90, 51, 79, 81, 100, 47, 115, 103, 118, 78, 97, 103, 61, 61, 113, <span class="hljs-string">-112</span>, <span class="hljs-string">-42</span>, 104, <br>16, // 4.7 sleeve key length<br><span class="hljs-string">-122</span>, 56, <span class="hljs-string">-75</span>, 17, <span class="hljs-string">-32</span>, 91, 85, 123, <span class="hljs-string">-7</span>, 112, <span class="hljs-string">-60</span>, 24, 53, 109, 68, <span class="hljs-string">-12</span> // key<br></code></pre></td></tr></table></figure>

<h3 id="CobaltStrike-client破解"><a href="#CobaltStrike-client破解" class="headerlink" title="CobaltStrike client破解"></a>CobaltStrike client破解</h3><ul>
<li><p>在<code>aggressor/Aggressor.main</code>中调用<code>License.checkLicenseGUI(new Authorization());</code>开始证书验证。</p>
</li>
<li><p>&#96;&#96;Authorization<code>类中是</code>cobaltstrike.auth<code>文件的处理，读取文件内容,创建</code>AuthCrypto类<code>，对</code>cobaltstrike.auth<code>进行MD5验证，并使用</code>RSA&#x2F;ECB&#x2F;PKCS1Padding&#96;进行RSA解密。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/1f023f4446a14303aadd97df9a9f7e30.png" srcset="/img/loading.gif" lazyload alt="image-20231002131410814"></p>
</li>
<li><p>调用<code>AuthCrypto().decrypt</code>对内容进行处理：</p>
<p><img src="https://img-blog.csdnimg.cn/direct/ee04d9451809402fbc27dd0d9f59bc97.png" srcset="/img/loading.gif" lazyload alt="image-20231002131104667"></p>
</li>
<li><p>前四个字节证书文件头，在<code>common.AutoCrypto.decrypt</code>进行验证（-889274181为3.x版本；-889274157为4.x版本），读取后两个字节作为<code>auth</code>长度，存入<code>var6</code>中并返回。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/530af4d201444ae885f315e4babfb698.png" srcset="/img/loading.gif" lazyload alt="image-20231002131134484"></p>
</li>
<li><p>从解密数据中获取<code>watermark</code>、版本号以及watermarkHash，并跳过之前版本的密钥。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/42014d01b09b4d358fe3556db4c48a03.png" srcset="/img/loading.gif" lazyload alt="image-20231002132300627"></p>
</li>
<li><p>获取过期时间，29999999表示永久证书，并将key传入<code>SleevedResource.Setup</code>进行数据解密。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/902974f11ef84eb39e6df3d8eb0481c5.png" srcset="/img/loading.gif" lazyload alt="image-20231002132514771"></p>
</li>
<li><p>在<code>Authorization</code>类中调用<code>SleevedResource.Setup</code>方法对<code>arrayOfByte6</code>进行处理。在<code>this.A.registerKey</code>中把key设定为AES、HmacSHA256解密的秘钥，在<code>this.A</code>中的<code>this.A.decrypt(var3)</code>进行解密调用，解密的内容为<code>/sleeve/</code>中的dll文件：</p>
<p><img src="https://img-blog.csdnimg.cn/direct/a8342b6d47a64d68a96b2aedaf612f77.png" srcset="/img/loading.gif" lazyload alt="image-20231002132855178"></p>
<p><img src="https://img-blog.csdnimg.cn/direct/85b0d2f85b1c4abebb68f3bf7d413372.png" srcset="/img/loading.gif" lazyload alt="image-20231002132738793"></p>
<ul>
<li>整个密钥文件内容分析流程到此结束，可以知道比较关键的内容就是证书有效时间和解密key，解密key只能通过分析正版的auth文件获取。</li>
</ul>
</li>
</ul>
<p>可以直接使用使用大佬的代码生成密钥文件。</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs subunit">import javax.crypto.BadPaddingException;<br>import javax.crypto.Cipher;<br>import javax.crypto.IllegalBlockSizeException;<br>import javax.crypto.NoSuchPaddingException;<br>import java.io.*;<br>import java.security.*;<br><br>public class RSAKeyPairGenerator &#123;<br>    private PrivateKey privateKey;<br>    private PublicKey publicKey;<br><br>    public RSAKeyPairGenerator() throws NoSuchAlgorithmException &#123;<br>        KeyPairGenerator keyGen = KeyPairGenerator.getInstance(&quot;RSA&quot;);<br>        keyGen.initialize(2048);<br>        KeyPair pair = keyGen.generateKeyPair();<br>        this.privateKey = pair.getPrivate();<br>        this.publicKey = pair.getPublic();<br>    &#125;<br><br>    // 将byte 写入文件<br>    public void byte2File(String path, byte[] data) throws IOException &#123;<br>        File f = new File(path);<br>        f.getParentFile().mkdirs();<br><br>        FileOutputStream fos = new FileOutputStream(f);<br>        fos.write(data);<br>        fos.flush();<br>        fos.close();<br>    &#125;<br><br>    public PrivateKey getPrivateKey() &#123;<br>        return privateKey;<br>    &#125;<br><br>    public PublicKey getPublicKey() &#123;<br>        return publicKey;<br>    &#125;<br><br>    // 加密数据<br>    public byte[] encryptPri(byte[] data, PrivateKey privateKey) throws BadPaddingException, IllegalBlockSizeException, InvalidKeyException, NoSuchPaddingException, NoSuchAlgorithmException &#123;<br>        Cipher cipher = Cipher.getInstance(&quot;RSA/ECB/PKCS1Padding&quot;);<br>        cipher.init(Cipher.ENCRYPT_MODE, this.privateKey);<br>        return cipher.doFinal(data);<br>    &#125;<br><br>    public static void main(String[] args) throws NoSuchAlgorithmException, IOException, IllegalBlockSizeException, InvalidKeyException, NoSuchPaddingException, BadPaddingException &#123;<br>        RSAKeyPairGenerator PairGenerator = new RSAKeyPairGenerator();<br>        //byte[] data = &#123;<span class="hljs-string">-54</span>, <span class="hljs-string">-2</span>, <span class="hljs-string">-64</span>, <span class="hljs-string">-45</span>, 0, 77, 1, <span class="hljs-string">-55</span>, <span class="hljs-string">-61</span>, 127, 0, 0, 0, 1, 43, 16, 58, 68, 37, 73, 15, 56, <span class="hljs-string">-102</span>, <span class="hljs-string">-18</span>, <span class="hljs-string">-61</span>, 18, <span class="hljs-string">-67</span>, <span class="hljs-string">-41</span>, 88, <span class="hljs-string">-83</span>, 43, <span class="hljs-string">-103</span> &#125;;<br>        // byte[] data =&#123;<br>        //         <span class="hljs-string">-54</span>, <span class="hljs-string">-2</span>, <span class="hljs-string">-64</span>, <span class="hljs-string">-45</span>,<br>        //         0, 77, 1, <span class="hljs-string">-55</span>, <span class="hljs-string">-61</span>,<br>        //         127,<br>        //         0, 0, 0, 1,<br>        //         43,<br>        //         16, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20,<br>        //         16, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20,<br>        //         16, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20,<br>        //         16, 58, 68, 37, 73, 15, 56, <span class="hljs-string">-102</span>, <span class="hljs-string">-18</span>, <span class="hljs-string">-61</span>, 18, <span class="hljs-string">-67</span>, <span class="hljs-string">-41</span>, 88, <span class="hljs-string">-83</span>, 43, <span class="hljs-string">-103</span><br>        // &#125;; // 4.3<br>        byte[] data=&#123;<br>                <span class="hljs-string">-54</span>, <span class="hljs-string">-2</span>, <span class="hljs-string">-64</span>, <span class="hljs-string">-45</span>,<br>                0, <span class="hljs-string">-54</span>,<br>                1, <span class="hljs-string">-55</span>, <span class="hljs-string">-61</span>, 127,<br>                23, 80, 101, <span class="hljs-string">-22</span>,<br>                47,<br>                16, 27, <span class="hljs-string">-27</span>, <span class="hljs-string">-66</span>, 82, <span class="hljs-string">-58</span>, 37, 92, 51, 85, <span class="hljs-string">-114</span>, <span class="hljs-string">-118</span>, 28, <span class="hljs-string">-74</span>, 103, <span class="hljs-string">-53</span>, 6,<br>                16, <span class="hljs-string">-128</span>, <span class="hljs-string">-29</span>, 42, 116, 32, 96, <span class="hljs-string">-72</span>, <span class="hljs-string">-124</span>, 65, <span class="hljs-string">-101</span>, <span class="hljs-string">-96</span>, <span class="hljs-string">-63</span>, 113, <span class="hljs-string">-55</span>, <span class="hljs-string">-86</span>, 118,<br>                16, <span class="hljs-string">-78</span>, 13, 72, 122, <span class="hljs-string">-35</span>, <span class="hljs-string">-44</span>, 113, 52, 24, <span class="hljs-string">-14</span>, <span class="hljs-string">-43</span>, <span class="hljs-string">-93</span>, <span class="hljs-string">-82</span>, 2, <span class="hljs-string">-89</span>, <span class="hljs-string">-96</span>,<br>                16, 58, 68, 37, 73, 15, 56, <span class="hljs-string">-102</span>, <span class="hljs-string">-18</span>, <span class="hljs-string">-61</span>, 18, <span class="hljs-string">-67</span>, <span class="hljs-string">-41</span>, 88, <span class="hljs-string">-83</span>, 43, <span class="hljs-string">-103</span>,<br>                16, 94, <span class="hljs-string">-104</span>, 25, 74, 1, <span class="hljs-string">-58</span>, <span class="hljs-string">-76</span>, <span class="hljs-string">-113</span>, <span class="hljs-string">-91</span>, <span class="hljs-string">-126</span>, <span class="hljs-string">-90</span>, <span class="hljs-string">-87</span>, <span class="hljs-string">-4</span>, <span class="hljs-string">-69</span>, <span class="hljs-string">-110</span>, <span class="hljs-string">-42</span>,<br>                16, <span class="hljs-string">-13</span>, <span class="hljs-string">-114</span>, <span class="hljs-string">-77</span>, <span class="hljs-string">-47</span>, <span class="hljs-string">-93</span>, 53, <span class="hljs-string">-78</span>, 82, <span class="hljs-string">-75</span>, <span class="hljs-string">-117</span>, <span class="hljs-string">-62</span>, <span class="hljs-string">-84</span>, <span class="hljs-string">-34</span>, <span class="hljs-string">-127</span>, <span class="hljs-string">-75</span>, 66,<br>                0, 0, 0, 24,<br>                105, 100, 118, 121, 85, 97, 77, 68, 75, 117, 98, 87, 87, 52, 84, 76, 51, 105, 80, 106, 66, 119, 61, 61,<br>                16, <span class="hljs-string">-71</span>, <span class="hljs-string">-86</span>, 51, 8, 10, 90, <span class="hljs-string">-112</span>, 49, 62, <span class="hljs-string">-15</span>, <span class="hljs-string">-99</span>, <span class="hljs-string">-64</span>, 98, 125, 46, <span class="hljs-string">-95</span>,<br>                28, 115, 53, 57, 108, 53, 105, 113, 49, 101, 106, 90, 51, 79, 81, 100, 47, 115, 103, 118, 78, 97, 103, 61, 61, 113, <span class="hljs-string">-112</span>, <span class="hljs-string">-42</span>, 104,<br>                16, <span class="hljs-string">-122</span>, 56, <span class="hljs-string">-75</span>, 17, <span class="hljs-string">-32</span>, 91, 85, 123, <span class="hljs-string">-7</span>, 112, <span class="hljs-string">-60</span>, 24, 53, 109, 68, <span class="hljs-string">-12</span><br>        &#125;; // 4.7<br>        byte[] rsaByte = PairGenerator.encryptPri(data, PairGenerator.getPrivateKey());<br>        PairGenerator.byte2File(&quot;RSA/cobaltstrike.auth&quot;, rsaByte);<br>        PairGenerator.byte2File(&quot;RSA/authkey.private&quot;, PairGenerator.getPrivateKey().getEncoded());<br>        PairGenerator.byte2File(&quot;RSA/authkey.pub&quot;, PairGenerator.getPublicKey().getEncoded());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​		将<code>RSA</code>目录下的密钥，复制到<code>src/resources</code>目录下，同时将<code>decompiled_src/cobaltstrike-client/common/AuthCrypto.java</code>复制到<code>src/common/AuthCrypto</code>，计算<code>authkey.pub</code>的md5，并替换<code>src/common/AuthCrypto</code>第28行的数值。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">certutil</span> -hashfile authkey.pub MD5<br></code></pre></td></tr></table></figure>

<p>最后将<code>RSA/cobaltstrike.auth</code>复制到<code>out</code>文件下，和编译好的jar包同一目录。</p>
<h3 id="CobaltStrike-server-破解"><a href="#CobaltStrike-server-破解" class="headerlink" title="CobaltStrike server 破解"></a>CobaltStrike server 破解</h3><p>​		与CobaltStrike client类似，CobaltStrike server端同样需要替换<code>authkey.pub</code>文件和<code>authkey.pub</code>的MD5，由于CobaltStrike 4.7版本以后，为了防破解，CobaltStrike server端变成了二进制文件<code>TeamServerImage</code>，因此我们可以使用<code>winhex</code>或者<code>010 Editor</code>直接对二进制文件进行修改。</p>
<ul>
<li><p>修改<code>authkey.pub</code>。从CobaltStrike client中提取官方<code>resources/authkey.pub</code>，使用<code>winhex</code>或者<code>010 Editor</code>复制二进制数据并在<code>TeamServerImage</code>全局搜索（大概位置在<code>0x48F2570</code>附近），例如CobaltStrike 4.7的<code>authkey.pub</code>的数据如下，将其修改为上面自己认证的<code>authkey.pub</code>内容即可。</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">30820122300d</span>06092A8648<span class="hljs-number">86F70D0101</span>.....<br></code></pre></td></tr></table></figure>
</li>
<li><p>修改<code>authkey.pub</code>的MD5，从CobaltStrike client中的<code>/common/AuthCrypto</code>提取第28行的原始MD5数值，使用<code>winhex</code>或者<code>010 Editor</code>复制二进制数据并在<code>TeamServerImage</code>全局搜索（大概位置在0x3e08120附近），例如CobaltStrike 4.7的<code>authkey.pub</code>的数据为<code>8bb4df00c120881a1945a43e2bb2379e</code>，将其修改为上面自己认证的<code>authkey.pub</code>的MD5即可。</p>
</li>
<li><p>可以使用以下python脚本一键替换。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> argparse <span class="hljs-keyword">import</span> ArgumentParser, FileType<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> re<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">CalcMD5</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>):<br>    md5 = hashlib.md5()<br>    md5.update(data)<br>    <span class="hljs-keyword">return</span> md5.hexdigest()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ReplaceData</span>(<span class="hljs-params">data, original_data, replacement_data</span>):<br>    pos = data.find(original_data)<br>    <span class="hljs-keyword">while</span> pos != -<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(replacement_data)):<br>            data[pos+i] = replacement_data[i]<br>        pos = data.find(original_data)<br>    <span class="hljs-keyword">return</span> data<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Crack</span>(<span class="hljs-params">src, dst</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./TeamServerImage&#x27;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f1, <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./TeamServerImageCrack&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>)<span class="hljs-keyword">as</span> f2:<br>        dataSrc = src.read()<br>        dataDst = dst.read()<br>        md5Src = CalcMD5(dataSrc)<br>        md5Dst = CalcMD5(dataDst)<br>        data = <span class="hljs-built_in">bytearray</span>(f1.read())<br><br>        ReplaceData(data, md5Src.encode(), md5Dst.encode())<br>        ReplaceData(data, dataSrc, dataDst)<br>        f2.write(data)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parseArgs</span>():<br>    parser = ArgumentParser(<br>        prog=<span class="hljs-string">&#x27;crack.py&#x27;</span>, description=<span class="hljs-string">&#x27;Crack TeamServerImage&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-s&#x27;</span>, <span class="hljs-string">&#x27;--src&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">u&#x27;origin authkey.pub file&#x27;</span>,<br>                        <span class="hljs-built_in">type</span>=FileType(<span class="hljs-string">&#x27;rb&#x27;</span>), required=<span class="hljs-literal">True</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-d&#x27;</span>, <span class="hljs-string">&#x27;--dst&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">u&#x27;crack authkey.pub file&#x27;</span>,<br>                        <span class="hljs-built_in">type</span>=FileType(<span class="hljs-string">&#x27;rb&#x27;</span>), required=<span class="hljs-literal">True</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-t&#x27;</span>, <span class="hljs-string">&#x27;--target&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">u&#x27;crack TeamServerImage file&#x27;</span>,<br>                        <span class="hljs-built_in">type</span>=FileType(<span class="hljs-string">&#x27;rb&#x27;</span>), required=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> parser.parse_args()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    args = parseArgs()<br>    Crack(args.src, args.dst)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure>

<p>使用方法</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">./crack.py -s authkey_orign.<span class="hljs-keyword">pub</span> -d authkey_crack.<span class="hljs-keyword">pub</span> -t <span class="hljs-type">TeamServerImage</span><br># authkey_orign.<span class="hljs-keyword">pub</span> 官方原版公钥aythkey.<span class="hljs-keyword">pub</span><br># authkey_crack.<span class="hljs-keyword">pub</span> 子签证公钥aythkey.<span class="hljs-keyword">pub</span><br># <span class="hljs-type">TeamServerImage</span> 官方原版<span class="hljs-type">TeamServerImage</span><br># output <span class="hljs-type">TeamServerImageCrack</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>服务端程序启动方法：创建bash脚本，启动即可</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Start Cobalt Strike Team Server</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-comment"># make pretty looking messages (thanks Carlos)</span><br><span class="hljs-keyword">function</span> print_good () &#123;<br>    echo -e <span class="hljs-string">&quot;\x1B[01;32m[+]\x1B[0m $1&quot;</span><br>&#125;<br><br><span class="hljs-keyword">function</span> print_error () &#123;<br>    echo -e <span class="hljs-string">&quot;\x1B[01;31m[-]\x1B[0m $1&quot;</span><br>&#125;<br><br><span class="hljs-keyword">function</span> print_info () &#123;<br>    echo -e <span class="hljs-string">&quot;\x1B[01;34m[*]\x1B[0m $1&quot;</span><br>&#125;<br><br><span class="hljs-comment"># check that we&#x27;re r00t</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$UID</span> -ne <span class="hljs-number">0</span> ]; then<br>	print_error <span class="hljs-string">&quot;Superuser privileges are required to run the team server&quot;</span><br>	<span class="hljs-keyword">exit</span><br>fi<br><br><span class="hljs-comment"># check if java is available...</span><br><span class="hljs-keyword">if</span> [ $(command -v java) ]; then<br>	true<br><span class="hljs-keyword">else</span><br>	print_error <span class="hljs-string">&quot;java is not in \$PATH&quot;</span><br>	echo <span class="hljs-string">&quot;    is Java installed?&quot;</span><br>	<span class="hljs-keyword">exit</span><br>fi<br><br><span class="hljs-comment"># check if keytool is available...</span><br><span class="hljs-keyword">if</span> [ $(command -v keytool) ]; then<br>	true<br><span class="hljs-keyword">else</span><br>	print_error <span class="hljs-string">&quot;keytool is not in \$PATH&quot;</span><br>	echo <span class="hljs-string">&quot;    install the Java Developer Kit&quot;</span><br>	<span class="hljs-keyword">exit</span><br>fi<br><br><span class="hljs-comment"># generate a certificate</span><br>	<span class="hljs-comment"># naturally you&#x27;re welcome to replace this step with your own permanent certificate.</span><br>	<span class="hljs-comment"># just make sure you pass -Djavax.net.ssl.keyStore=&quot;/path/to/whatever&quot; and</span><br>	<span class="hljs-comment"># -Djavax.net.ssl.keyStorePassword=&quot;password&quot; to java. This is used for setting up</span><br>	<span class="hljs-comment"># an SSL server socket. Also, the SHA-1 digest of the first certificate in the store</span><br>	<span class="hljs-comment"># is printed so users may have a chance to verify they&#x27;re not being owned.</span><br><span class="hljs-keyword">if</span> [ -e ./cobaltstrike.store ]; then<br>	print_info <span class="hljs-string">&quot;Will use existing X509 certificate and keystore (for SSL)&quot;</span><br><span class="hljs-keyword">else</span><br>	print_info <span class="hljs-string">&quot;Generating X509 certificate and keystore (for SSL)&quot;</span><br>	keytool -keystore ./cobaltstrike.store -storepass <span class="hljs-number">123456</span> -keypass <span class="hljs-number">123456</span> -genkey -keyalg RSA -alias cobaltstrike -dname <span class="hljs-string">&quot;CN=Microsoft IT TLS CA 5, OU=Microsoft IT, O=Microsoft Corporation, L=Redmond, S=Washington, C=US&quot;</span><br>fi<br><br>.<span class="hljs-regexp">/TeamServerImage -Dcobaltstrike.server_port=43681 -Dcobaltstrike.server_bindto=0.0.0.0 -Djavax.net.ssl.keyStore=./</span>cobaltstrike.store -Djavax.net.ssl.keyStorePassword=<span class="hljs-number">123456</span> teamserver $*<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="CobaltStrike-4-9破解说明"><a href="#CobaltStrike-4-9破解说明" class="headerlink" title="CobaltStrike 4.9破解说明"></a>CobaltStrike 4.9破解说明</h3><p>​		在<code>CobaltStrike破解</code>中，我们介绍了<code>CobaltStrike</code>破解过程，该方法正对<code>CobaltStrike 4.9</code>之前的版本是完全成功的，但在<code>CobaltStrike 4.9 server</code>版本中<code>server</code>端加入更多验证，需要额外的一些操作，因此有了本节<code>CobaltStrike server 4.9补充破解</code>，<strong>注意，本节需要在<code>CobaltStrike</code>破解过程的基础上进行</strong>。</p>
<ul>
<li>使用IDA打开<code>TeamServerImage</code>，定位到<code>0x0000000000BC8DE7</code>，可以看到<code>Arrays_copyOfRange</code>函数的参数为256和512，表示取<code>cobaltstrike.auth</code>文件的256到512字节，通过<code>common_AuthCrypto_decrypt2</code>进行解密处理，<code>common_AuthCrypto_decrypt2</code>的解密逻辑暂时还未破解成功，因此。我们直接<code>nop</code>掉就行，直接从<code>cobaltstrike.auth</code>文件中读取解密后的内容即可。</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/direct/7350b52f29f540b8a901b4f91a8e34c3.png" srcset="/img/loading.gif" lazyload alt="image-20231023183422779"></p>
<p><img src="https://img-blog.csdnimg.cn/direct/f88598e8b22041e6a03550162a9ed235.png" srcset="/img/loading.gif" lazyload alt="image-20231023183730904"></p>
<p>​		这里我也写了一个python脚本，一键破解原版TeamServeImage：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> argparse <span class="hljs-keyword">import</span> ArgumentParser, FileType<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> re<br><br><br>authkey_b64 = <span class="hljs-string">&quot;MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAkgtvDimGFGRAs2rwqZ7EOnLJknr4LNtQwZ1n8PiXEegmnP//rdXal4VenANymQXZ1F6Ln3+98oFTWNQrxpDrau3NR5lMoELx41SxA46p/+ljNBqQ8+HMkxDlueImMbNgizI4uT9XV+UPB0mhv31v1FT+dMMKS/UKKhz/r9yoEgwmXTIfTGLUS6+GTfyvrjotN3xsJlx3aHtO1yL3bz0h4Jxz8v6DanuqBkz2K0T1r++ECqNopH0vtvWihLrmkDYm0ST+/NXLhd5djyYQuaEc9nYrip/iefs9BVFGBuKMUmSoT9+1bHp4GXWhloEq/5+w+UlYLI0pNNqVJVEgAtdiRwIDAQAB&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">CalcMD5</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>):<br>    md5 = hashlib.md5()<br>    md5.update(data)<br>    <span class="hljs-keyword">return</span> md5.hexdigest()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ReplaceData</span>(<span class="hljs-params">data, original_data, replacement_data</span>):<br>    pos = data.find(original_data)<br>    <span class="hljs-keyword">while</span> pos != -<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(replacement_data)):<br>            data[pos+i] = replacement_data[i]<br>        pos = data.find(original_data)<br>    <span class="hljs-keyword">return</span> data<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Crack</span>(<span class="hljs-params">dst</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./TeamServerImage&#x27;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f1, <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./TeamServerImageCrack&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>)<span class="hljs-keyword">as</span> f2:<br>        dataSrc = base64.b64decode(authkey_b64)<br>        dataDst = dst.read()<br>        md5Src = CalcMD5(dataSrc)<br>        md5Dst = CalcMD5(dataDst)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(dataSrc))+<span class="hljs-string">&quot; &quot;</span>+md5Src)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(dataSrc))+<span class="hljs-string">&quot; &quot;</span>+md5Dst)<br>        data = <span class="hljs-built_in">bytearray</span>(f1.read())<br><br>        ReplaceData(data, md5Src.encode(), md5Dst.encode())<br>        ReplaceData(data, dataSrc, dataDst)<br>        ReplaceData(data,<span class="hljs-string">b&quot;\xE8\x36\x1d\x00\x00&quot;</span>,<span class="hljs-string">b&quot;\x90\x90\x90\x90\x90&quot;</span>)<br>        f2.write(data)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Crack TeamServerImage success.&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parseArgs</span>():<br>    parser = ArgumentParser(<br>        prog=<span class="hljs-string">&#x27;crack.py&#x27;</span>, description=<span class="hljs-string">&#x27;Crack TeamServerImage&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-s&#x27;</span>, <span class="hljs-string">&#x27;--src&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">u&#x27;origin authkey.pub file&#x27;</span>,<br>                        <span class="hljs-built_in">type</span>=FileType(<span class="hljs-string">&#x27;rb&#x27;</span>), required=<span class="hljs-literal">False</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-d&#x27;</span>, <span class="hljs-string">&#x27;--dst&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">u&#x27;crack authkey.pub file&#x27;</span>,<br>                        <span class="hljs-built_in">type</span>=FileType(<span class="hljs-string">&#x27;rb&#x27;</span>), required=<span class="hljs-literal">True</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-t&#x27;</span>, <span class="hljs-string">&#x27;--target&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">u&#x27;crack TeamServerImage file&#x27;</span>,<br>                        <span class="hljs-built_in">type</span>=FileType(<span class="hljs-string">&#x27;rb&#x27;</span>), required=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> parser.parse_args()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    args = parseArgs()<br>    Crack(args.dst)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br><br></code></pre></td></tr></table></figure>



<ul>
<li><p>密钥文件生成代码也需要进行稍微修改</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><code class="hljs subunit">import javax.crypto.BadPaddingException;<br>import javax.crypto.Cipher;<br>import javax.crypto.IllegalBlockSizeException;<br>import javax.crypto.NoSuchPaddingException;<br>import java.io.*;<br>import java.nio.file.Files;<br>import java.nio.file.Path;<br>import java.security.*;<br>import java.security.spec.InvalidKeySpecException;<br>import java.security.spec.PKCS8EncodedKeySpec;<br>import java.security.spec.X509EncodedKeySpec;<br><br>public class RSAKeyPairGenerator &#123;<br>    private PrivateKey privateKey;<br>    private PublicKey publicKey;<br>    public boolean chunk;<br><br>    public RSAKeyPairGenerator() throws NoSuchAlgorithmException &#123;<br>        KeyPairGenerator keyGen = KeyPairGenerator.getInstance(&quot;RSA&quot;);<br>        keyGen.initialize(4096);<br>        KeyPair pair = keyGen.generateKeyPair();<br>        this.privateKey = pair.getPrivate();<br>        this.publicKey = pair.getPublic();<br>    &#125;<br><br>    public RSAKeyPairGenerator(String publicKeyPath, String privateKeyPath)<br>            throws NoSuchAlgorithmException, InvalidKeySpecException &#123;<br><br>        byte[] publicKeyByte = byteFromFile(publicKeyPath);<br>        byte[] privateKeyByte = byteFromFile(privateKeyPath);<br>        KeyFactory keyFactory = KeyFactory.getInstance(&quot;RSA&quot;);<br>        X509EncodedKeySpec publicKeySpec = new X509EncodedKeySpec(publicKeyByte);<br>        PKCS8EncodedKeySpec privateKeySpec = new PKCS8EncodedKeySpec(privateKeyByte);<br>        this.publicKey = keyFactory.generatePublic(publicKeySpec);<br>        this.privateKey = keyFactory.generatePrivate(privateKeySpec);<br><br>    &#125;<br><br>    // 将byte 写入文件<br>    public void byte2File(String path, byte[] data) throws IOException &#123;<br>        File f = new File(path);<br>        f.getParentFile().mkdirs();<br><br>        FileOutputStream fos = new FileOutputStream(f);<br>        fos.write(data);<br>        fos.flush();<br>        fos.close();<br>    &#125;<br><br>    // 从文件种读取bye<br>    public byte[] byteFromFile(String path) &#123;<br><br>        Path filePath = Path.of(path);<br><br>        try &#123;<br>            byte[] data = Files.readAllBytes(filePath);<br>            return data;<br>        &#125; catch (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        return new byte[1];<br><br>    &#125;<br><br>    public PrivateKey getPrivateKey() &#123;<br>        return privateKey;<br>    &#125;<br><br>    public PublicKey getPublicKey() &#123;<br>        return publicKey;<br>    &#125;<br><br>    public static byte[] subByte(byte[] original, int from, int to) &#123;<br>        int newLength = to - from;<br>        if (newLength &lt; 0)<br>            throw new IllegalArgumentException(from + &quot; &gt; &quot; + to);<br>        byte[] copy = new byte[newLength];<br>        System.arraycopy(original, from, copy, 0,<br>                Math.min(original.length - from, newLength));<br>        return copy;<br>    &#125;<br><br>    public static byte[] mergerByte(byte[] original1, byte[] original2) &#123;<br>        byte[] copy = new byte[original1.length + original2.length];<br>        System.arraycopy(original1, 0, copy, 0, original1.length);<br>        System.arraycopy(original2, 0, copy, original1.length, original2.length);<br>        return copy;<br>    &#125;<br><br>    // 加密数据<br>    public byte[] encryptPri(byte[] data, PrivateKey privateKey) throws BadPaddingException, IllegalBlockSizeException,<br>            InvalidKeyException, NoSuchPaddingException, NoSuchAlgorithmException, IOException &#123;<br>        Cipher cipher = Cipher.getInstance(&quot;RSA/ECB/PKCS1Padding&quot;);<br>        cipher.init(Cipher.ENCRYPT_MODE, this.privateKey);<br>        if (!this.chunk)<br>            return cipher.doFinal(data);<br>        int inputLen = data.length;<br>        int offLen = 0;<br>        ByteArrayOutputStream bops = new ByteArrayOutputStream();<br>        int i = 0;<br>        while (inputLen - offLen &gt; 0) &#123;<br>            byte[] cache;<br>            if (inputLen - offLen &gt; 245) &#123;<br>                cache = cipher.doFinal(data, offLen, 245);<br>            &#125; else &#123;<br>                cache = cipher.doFinal(data, offLen, inputLen - offLen);<br>            &#125;<br>            bops.write(cache);<br>            i++;<br>            offLen = 245 * i;<br>        &#125;<br><br>        return bops.toByteArray();<br>    &#125;<br><br>    // 解密数据<br>    public byte[] decryptPub(byte[] data, PublicKey publicKey) throws BadPaddingException, IllegalBlockSizeException,<br>            InvalidKeyException, NoSuchPaddingException, NoSuchAlgorithmException, IOException,<br>            InvalidKeySpecException &#123;<br><br>        Cipher cipher = Cipher.getInstance(&quot;RSA/ECB/PKCS1Padding&quot;);<br>        cipher.init(2, this.publicKey);<br>        return cipher.doFinal(data);<br>    &#125;<br><br>    public static void main(String[] args) throws NoSuchAlgorithmException, IOException, IllegalBlockSizeException,<br>            InvalidKeyException, NoSuchPaddingException, BadPaddingException, InvalidKeySpecException &#123;<br>        File file = new File(&quot;RSA/authkey.private&quot;);<br>        RSAKeyPairGenerator PairGenerator;<br>        if (file.exists())<br>            PairGenerator = new RSAKeyPairGenerator(&quot;RSA/authkey.pub&quot;, &quot;RSA/authkey.private&quot;);<br>        else &#123;<br>            PairGenerator = new RSAKeyPairGenerator();<br>            PairGenerator.byte2File(&quot;RSA/authkey.private&quot;,<br>                    PairGenerator.getPrivateKey().getEncoded());<br>            PairGenerator.byte2File(&quot;RSA/authkey.pub&quot;,<br>                    PairGenerator.getPublicKey().getEncoded());<br>        &#125;<br>        // byte[] data = &#123;<span class="hljs-string">-54</span>, <span class="hljs-string">-2</span>, <span class="hljs-string">-64</span>, <span class="hljs-string">-45</span>, 0, 77, 1, <span class="hljs-string">-55</span>, <span class="hljs-string">-61</span>, 127, 0, 0, 0, 1, 43,<br>        // 16, 58, 68, 37, 73, 15, 56, <span class="hljs-string">-102</span>, <span class="hljs-string">-18</span>, <span class="hljs-string">-61</span>, 18, <span class="hljs-string">-67</span>, <span class="hljs-string">-41</span>, 88, <span class="hljs-string">-83</span>, 43, <span class="hljs-string">-103</span><br>        // &#125;;<br>        // byte[] data =&#123;<br>        // <span class="hljs-string">-54</span>, <span class="hljs-string">-2</span>, <span class="hljs-string">-64</span>, <span class="hljs-string">-45</span>,<br>        // 0, 77, 1, <span class="hljs-string">-55</span>, <span class="hljs-string">-61</span>,<br>        // 127,<br>        // 0, 0, 0, 1,<br>        // 43,<br>        // 16, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20,<br>        // 16, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20,<br>        // 16, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20,<br>        // 16, 58, 68, 37, 73, 15, 56, <span class="hljs-string">-102</span>, <span class="hljs-string">-18</span>, <span class="hljs-string">-61</span>, 18, <span class="hljs-string">-67</span>, <span class="hljs-string">-41</span>, 88, <span class="hljs-string">-83</span>, 43, <span class="hljs-string">-103</span><br>        // &#125;; // 4.3<br>        // byte[] data=&#123;<br>        // <span class="hljs-string">-54</span>, <span class="hljs-string">-2</span>, <span class="hljs-string">-64</span>, <span class="hljs-string">-45</span>,<br>        // 0, <span class="hljs-string">-54</span>,<br>        // 1, <span class="hljs-string">-55</span>, <span class="hljs-string">-61</span>, 127,<br>        // 23, 80, 101, <span class="hljs-string">-22</span>,<br>        // 47,<br>        // 16, 27, <span class="hljs-string">-27</span>, <span class="hljs-string">-66</span>, 82, <span class="hljs-string">-58</span>, 37, 92, 51, 85, <span class="hljs-string">-114</span>, <span class="hljs-string">-118</span>, 28, <span class="hljs-string">-74</span>, 103, <span class="hljs-string">-53</span>, 6,<br>        // 16, <span class="hljs-string">-128</span>, <span class="hljs-string">-29</span>, 42, 116, 32, 96, <span class="hljs-string">-72</span>, <span class="hljs-string">-124</span>, 65, <span class="hljs-string">-101</span>, <span class="hljs-string">-96</span>, <span class="hljs-string">-63</span>, 113, <span class="hljs-string">-55</span>, <span class="hljs-string">-86</span>,<br>        // 118,<br>        // 16, <span class="hljs-string">-78</span>, 13, 72, 122, <span class="hljs-string">-35</span>, <span class="hljs-string">-44</span>, 113, 52, 24, <span class="hljs-string">-14</span>, <span class="hljs-string">-43</span>, <span class="hljs-string">-93</span>, <span class="hljs-string">-82</span>, 2, <span class="hljs-string">-89</span>, <span class="hljs-string">-96</span>,<br>        // 16, 58, 68, 37, 73, 15, 56, <span class="hljs-string">-102</span>, <span class="hljs-string">-18</span>, <span class="hljs-string">-61</span>, 18, <span class="hljs-string">-67</span>, <span class="hljs-string">-41</span>, 88, <span class="hljs-string">-83</span>, 43, <span class="hljs-string">-103</span>,<br>        // 16, 94, <span class="hljs-string">-104</span>, 25, 74, 1, <span class="hljs-string">-58</span>, <span class="hljs-string">-76</span>, <span class="hljs-string">-113</span>, <span class="hljs-string">-91</span>, <span class="hljs-string">-126</span>, <span class="hljs-string">-90</span>, <span class="hljs-string">-87</span>, <span class="hljs-string">-4</span>, <span class="hljs-string">-69</span>, <span class="hljs-string">-110</span>,<br>        // <span class="hljs-string">-42</span>,<br>        // 16, <span class="hljs-string">-13</span>, <span class="hljs-string">-114</span>, <span class="hljs-string">-77</span>, <span class="hljs-string">-47</span>, <span class="hljs-string">-93</span>, 53, <span class="hljs-string">-78</span>, 82, <span class="hljs-string">-75</span>, <span class="hljs-string">-117</span>, <span class="hljs-string">-62</span>, <span class="hljs-string">-84</span>, <span class="hljs-string">-34</span>, <span class="hljs-string">-127</span>,<br>        // <span class="hljs-string">-75</span>, 66,<br>        // 0, 0, 0, 24,<br>        // 105, 100, 118, 121, 85, 97, 77, 68, 75, 117, 98, 87, 87, 52, 84, 76, 51, 105,<br>        // 80, 106, 66, 119, 61, 61,<br>        // 16, <span class="hljs-string">-71</span>, <span class="hljs-string">-86</span>, 51, 8, 10, 90, <span class="hljs-string">-112</span>, 49, 62, <span class="hljs-string">-15</span>, <span class="hljs-string">-99</span>, <span class="hljs-string">-64</span>, 98, 125, 46, <span class="hljs-string">-95</span>,<br>        // 28, 115, 53, 57, 108, 53, 105, 113, 49, 101, 106, 90, 51, 79, 81, 100, 47,<br>        // 115, 103, 118, 78, 97, 103, 61, 61, 113, <span class="hljs-string">-112</span>, <span class="hljs-string">-42</span>, 104,<br>        // 16, <span class="hljs-string">-122</span>, 56, <span class="hljs-string">-75</span>, 17, <span class="hljs-string">-32</span>, 91, 85, 123, <span class="hljs-string">-7</span>, 112, <span class="hljs-string">-60</span>, 24, 53, 109, 68, <span class="hljs-string">-12</span><br>        // &#125;; // 4.7<br><br>        byte[] data = &#123;<br>                <span class="hljs-string">-54</span>, <span class="hljs-string">-2</span>, <span class="hljs-string">-64</span>, <span class="hljs-string">-45</span>,<br>                0, <span class="hljs-string">-11</span>,<br>                16, <span class="hljs-string">-1</span>, 12, <span class="hljs-string">-6</span>, 65, 7, <span class="hljs-string">-47</span>, 91, 48, 17, 61, 29, 43, <span class="hljs-string">-99</span>, <span class="hljs-string">-23</span>, 21, 109,<br>                34, <span class="hljs-string">-96</span>, 55, 34, <span class="hljs-string">-9</span>, 88, 123, <span class="hljs-string">-79</span>, 80, 106, <span class="hljs-string">-125</span>, <span class="hljs-string">-118</span>, 85, <span class="hljs-string">-85</span>, 2, <span class="hljs-string">-46</span>, 23, 65, 48, 102, <span class="hljs-string">-102</span>, <span class="hljs-string">-20</span>, <span class="hljs-string">-2</span>,<br>                <span class="hljs-string">-79</span>, <span class="hljs-string">-124</span>, <span class="hljs-string">-24</span>, <span class="hljs-string">-67</span>, <span class="hljs-string">-116</span>, 50, <span class="hljs-string">-96</span>, 4, 19, <span class="hljs-string">-57</span>, <span class="hljs-string">-125</span>, 76,<br>                49,<br>                1, <span class="hljs-string">-55</span>, <span class="hljs-string">-61</span>, 127,<br>                58, <span class="hljs-string">-34</span>, 104, <span class="hljs-string">-79</span>,<br>                0, 0, 0, 24,<br>                78, 116, 90, 79, 86, 54, 74, 122, 68, 114, 57, 81, 107, 69, 110, 88, 54, 98, 111, 98, 80, 103, 61, 61,<br>                28, 115, 53, 57, 108, 53, 105, 113, 49, 101, 106, 90, 51, 79, 81, 100, 47, 115, 103, 118, 78, 97, 103,<br>                61, 61, 113, <span class="hljs-string">-112</span>, <span class="hljs-string">-42</span>, 104,<br>                <span class="hljs-string">-6</span>, <span class="hljs-string">-89</span>, 53, <span class="hljs-string">-104</span>, <span class="hljs-string">-110</span>, 84, <span class="hljs-string">-33</span>, 40, <span class="hljs-string">-58</span>, <span class="hljs-string">-6</span>, 77, 38, <span class="hljs-string">-11</span>, <span class="hljs-string">-106</span>, <span class="hljs-string">-63</span>, 78, <span class="hljs-string">-60</span>, 85, 78, 104, 120, 7,<br>                <span class="hljs-string">-94</span>, 68, 45, <span class="hljs-string">-23</span>, <span class="hljs-string">-118</span>, 111, 91, 26, <span class="hljs-string">-125</span>, <span class="hljs-string">-52</span>, 113, <span class="hljs-string">-113</span>, 57, 90, 63, <span class="hljs-string">-124</span>, <span class="hljs-string">-88</span>, 71, <span class="hljs-string">-81</span>, 22, <span class="hljs-string">-4</span>, 6,<br>                <span class="hljs-string">-37</span>, <span class="hljs-string">-32</span>, <span class="hljs-string">-61</span>, 96, 27, <span class="hljs-string">-20</span>, <span class="hljs-string">-120</span>, 111, 70, 106, 16, 59, 88, <span class="hljs-string">-47</span>, <span class="hljs-string">-13</span>, <span class="hljs-string">-118</span>, 37, <span class="hljs-string">-48</span>, <span class="hljs-string">-103</span>, <span class="hljs-string">-128</span>, <span class="hljs-string">-47</span>, 6,<br>                25, <span class="hljs-string">-123</span>, 8, <span class="hljs-string">-126</span>, 10, <span class="hljs-string">-12</span>, 112, <span class="hljs-string">-84</span>, <span class="hljs-string">-97</span>, 126, <span class="hljs-string">-62</span>, 90, 105, <span class="hljs-string">-64</span>, <span class="hljs-string">-119</span>, <span class="hljs-string">-10</span>, 68, <span class="hljs-string">-128</span>, <span class="hljs-string">-121</span>, 95, 82,<br>                <span class="hljs-string">-110</span>, <span class="hljs-string">-25</span>, <span class="hljs-string">-31</span>, 40, <span class="hljs-string">-27</span>, 59, <span class="hljs-string">-89</span>, 71, <span class="hljs-string">-60</span>, 127, 91, <span class="hljs-string">-51</span>, <span class="hljs-string">-8</span>, 63, 9, 35, <span class="hljs-string">-55</span>, 60, 124, 49, <span class="hljs-string">-6</span>, <span class="hljs-string">-123</span>, <span class="hljs-string">-92</span>,<br>                79, <span class="hljs-string">-21</span>, 37, <span class="hljs-string">-13</span>, <span class="hljs-string">-23</span>, 76, <span class="hljs-string">-42</span>, 74, <span class="hljs-string">-111</span>, <span class="hljs-string">-4</span>, <span class="hljs-string">-24</span>,<br>                // 4, 5, 33, 0, <span class="hljs-string">-35</span>, <span class="hljs-string">-94</span>, <span class="hljs-string">-25</span>, <span class="hljs-string">-37</span>, 60, <span class="hljs-string">-88</span>, <span class="hljs-string">-64</span>, <span class="hljs-string">-15</span>,<br>                // 64, 74, <span class="hljs-string">-11</span>, <span class="hljs-string">-84</span>, <span class="hljs-string">-86</span>, <br><br>                // 120, 39, <span class="hljs-string">-110</span>, 119, // TeamServerImage header<br>                // 0, <span class="hljs-string">-56</span>,<br>                50, 66, 104, <span class="hljs-string">-29</span>, 106, 19, <span class="hljs-string">-15</span>, 10, <span class="hljs-string">-88</span>, <span class="hljs-string">-38</span>, 50, <span class="hljs-string">-113</span>, 50, <span class="hljs-string">-124</span>, <span class="hljs-string">-108</span>, 127, 107, <span class="hljs-string">-35</span>, 105, 20, <span class="hljs-string">-47</span>, 48, 68, 91, 86, 69, <span class="hljs-string">-110</span>, 6, 16, <span class="hljs-string">-97</span>, <span class="hljs-string">-124</span>, 113, <span class="hljs-string">-103</span>, <span class="hljs-string">-48</span>, <span class="hljs-string">-73</span>, 124, <span class="hljs-string">-6</span>, <span class="hljs-string">-21</span>, <span class="hljs-string">-24</span>, 66, 11, <span class="hljs-string">-104</span>, 51, 35, 59, <span class="hljs-string">-45</span>, 52, <span class="hljs-string">-122</span>, 7, 50, 80,<br><br>                1, <span class="hljs-string">-55</span>, <span class="hljs-string">-61</span>, 127,<br>                58, <span class="hljs-string">-34</span>, 104, <span class="hljs-string">-79</span>,<br>                49,<br>                0, 0, 0, 24,<br>                78, 116, 90, 79, 86, 54, 74, 122, 68, 114, 57, 81, 107, 69, 110, 88, 54, 98, 111, 98, 80, 103, 61, 61,<br>                28, 115, 53, 57, 108, 53, 105, 113, 49, 101, 106, 90, 51, 79, 81, 100, 47, 115, 103, 118, 78, 97, 103,<br>                61, 61,<br>                113, <span class="hljs-string">-112</span>, <span class="hljs-string">-42</span>, 104,<br>                16, <span class="hljs-string">-1</span>, 12, <span class="hljs-string">-6</span>, 65, 7, <span class="hljs-string">-47</span>, 91, 48, 17, 61, 29, 43, <span class="hljs-string">-99</span>, <span class="hljs-string">-23</span>, 21, 109,<br>                34, 65, <span class="hljs-string">-7</span>, <span class="hljs-string">-74</span>, 111, 41, <span class="hljs-string">-12</span>, 41, <span class="hljs-string">-53</span>, <span class="hljs-string">-85</span>, <span class="hljs-string">-120</span>, <span class="hljs-string">-19</span>, <span class="hljs-string">-60</span>, 107, <span class="hljs-string">-108</span>, 65, 65, 25, <span class="hljs-string">-84</span>, 73, 56, <span class="hljs-string">-126</span>, <span class="hljs-string">-18</span>, <span class="hljs-string">-37</span>, <span class="hljs-string">-113</span>, 38, 19, 115, <span class="hljs-string">-24</span>, <span class="hljs-string">-90</span>, <span class="hljs-string">-105</span>, <span class="hljs-string">-30</span>, 127, <span class="hljs-string">-17</span>, <span class="hljs-string">-105</span>, 87, <span class="hljs-string">-94</span>, <span class="hljs-string">-102</span>, 37, 22, <span class="hljs-string">-26</span>, 34, <br>                <br>                <br>                84, 7, 46, <span class="hljs-string">-84</span>, <span class="hljs-string">-88</span>, <span class="hljs-string">-75</span>, <span class="hljs-string">-10</span>, 30, 75, <span class="hljs-string">-45</span>, 69, <span class="hljs-string">-31</span>, 70, <span class="hljs-string">-104</span>, <span class="hljs-string">-53</span>, 91,<br>                1, <span class="hljs-string">-67</span>, <span class="hljs-string">-87</span>, 4, 6, <span class="hljs-string">-33</span>, <span class="hljs-string">-64</span>, <span class="hljs-string">-115</span>, 50, 79, <span class="hljs-string">-13</span>, 39, <span class="hljs-string">-85</span>, 44, 27, <span class="hljs-string">-33</span>, <span class="hljs-string">-54</span>, <span class="hljs-string">-112</span>, <span class="hljs-string">-21</span>, <span class="hljs-string">-56</span>, <span class="hljs-string">-84</span>, 77, <span class="hljs-string">-46</span>,<br>                <span class="hljs-string">-58</span>, <span class="hljs-string">-62</span>, <span class="hljs-string">-107</span>, 50, <span class="hljs-string">-55</span>, 56, <span class="hljs-string">-53</span>, 35, <span class="hljs-string">-56</span>, 96, 95, 86, 117, <span class="hljs-string">-107</span>, <span class="hljs-string">-103</span>, <span class="hljs-string">-1</span>, <span class="hljs-string">-89</span>, <span class="hljs-string">-58</span>, <span class="hljs-string">-92</span>, <span class="hljs-string">-63</span>, <span class="hljs-string">-6</span>, 20,<br>                91, 120, <span class="hljs-string">-26</span>, 25, 54, 17, <span class="hljs-string">-107</span>, 99, <span class="hljs-string">-4</span>, <span class="hljs-string">-109</span>, <span class="hljs-string">-39</span>, <span class="hljs-string">-89</span>, 125, <span class="hljs-string">-105</span>, <span class="hljs-string">-14</span>, <span class="hljs-string">-99</span>, <span class="hljs-string">-73</span>, <span class="hljs-string">-15</span>, 59,<br>        &#125;; // 4.9<br><br>        PairGenerator.chunk = true;<br>        System.out.println(data.length);<br>        byte[] rsaByte = PairGenerator.encryptPri(subByte(data,0,245), PairGenerator.getPrivateKey());<br>        System.out.println(rsaByte.length);<br>        PairGenerator.byte2File(&quot;RSA/cobaltstrike.auth&quot;, mergerByte(rsaByte,subByte(data, 245, 245<span class="hljs-string">+256</span>)));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://github.com/atomxw/cobaltstrike4.5_cdf">https://github.com/atomxw/cobaltstrike4.5_cdf</a></p>
<h2 id="去除反调试"><a href="#去除反调试" class="headerlink" title="去除反调试"></a>去除反调试</h2><p>​		cs的反调试代码主要就是遍历运行参数，查看是否包含<code>-javaagent:</code>，因此直接注释掉此处代码即可，可以直接全局文件内容搜索<code>-javaagent:</code>，以下为所有包含反调试代码的函数。</p>
<ul>
<li><code>aggressor.Aggressor.A(String[])</code></li>
<li><code>aggressor.dialogs.ConnectDialog.A()</code></li>
<li><code>aggressor.dialogs.ExportReportDialog.dialogAction</code></li>
<li><code>aggressor.dialogs.GoldenTicketDialog.B</code></li>
<li><code>aggressor.dialogs.PayloadGeneratorDialog.E</code></li>
<li><code>aggressor.dialogs.ScListenerDialog.C()</code></li>
<li><code>aggressor.windows.CortanaConsole.CortanaConsole</code></li>
<li><code>aggressor.windows.ScriptManager.actionPerformed</code></li>
<li><code>aggressor.windows.SOCKSBroser.actionPerformed</code></li>
<li><code>commom.BaseArtifactUtils.A</code></li>
</ul>
<h2 id="去除文件完整性验证"><a href="#去除文件完整性验证" class="headerlink" title="去除文件完整性验证"></a>去除文件完整性验证</h2><p><strong>第一次验证</strong></p>
<p>​		Aggressor首先<code>checkui</code>校验完整性，主要是对几个加密函数的完整性校验；<code>checkLicenseGUI</code>用于检测认证文件的可用性，包括证书是否合法、是否过期等。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/20f2654a7eb54883ad6bd2121166d99e.png" srcset="/img/loading.gif" lazyload alt="image-20230925155240513"></p>
<p><code>checkui</code>关键函数为<code>commom.Starter.initializeStarter</code>函数校验完整性，。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/4e9ee1f5215c40508cebb47d5c5a4a8d.png" srcset="/img/loading.gif" lazyload alt="image-20230925155440119"></p>
<p>在<code>A</code>函数中，Var5为crc校验码，var4为校验class，其实现主要是在<code>Initializer.isOK(var1, var3, var4, var5, true)</code>。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/512b4089f6b247acbd37768a994efc7a.png" srcset="/img/loading.gif" lazyload alt="image-20230925155703184"></p>
<p><code>Initializer.isFileOK(var1, var4, var5, true)</code>函数中通过获取zipfile（jar包通过zip格式压缩）也就是本jar包内的文件获取crc并比较最开始的crc来确保文件未更改。所有校验的文件包括：</p>
<ul>
<li><code>common/AuthCrypto.class</code></li>
<li><code>resources/authkey.pub</code></li>
<li><code>common/License.class</code></li>
<li><code>common/Authorization.class</code></li>
<li><code>common/SleevedResource.class</code></li>
<li><code>common/AggressorInfo.class</code></li>
<li><code>dns/SleeveSecurity.class</code></li>
<li><code>common/BaseArtifactUtils.class</code></li>
<li><code>common/BaseResourceUtils.class</code></li>
<li><code>aggressor/dialogs/PayloadGeneratorDialog.class</code></li>
</ul>
<p>​		如果对上述文件有所修改的话，请同时修改<code>initializeStarter</code>函数中的crc验证码，或者直接<code>initializeStarter</code>函数返回值设为true，一劳永逸。</p>
<p><strong>第二次验证</strong></p>
<p>​		第二次完整性验证位于<code>aggressor.ui.UseLookAndFeel.A(Class var0)</code>，这里是base64解码字符串，字符串为校验的文件名，再用crc校验进行文件的二次校验，使用反射动态调用函数<code>common.CommonUtils.validClassIntegrity()</code>，此处验证文件包括：</p>
<ul>
<li><code>common.CommonUtils</code></li>
<li><code>common.Authorization</code></li>
<li><code>common.AuthCrypto</code></li>
<li><code>common.DataParser</code></li>
<li><code>common.SleevedResource</code></li>
<li><code>dns.SleeveSecurity</code></li>
<li><code>aggressor.Aggressor</code></li>
<li><code>common.AggressorInfo</code></li>
<li><code>common.Starter</code></li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/direct/5fffa0d83154442b985bf6dec1f937e5.png" srcset="/img/loading.gif" lazyload alt="image-20230925162610451"></p>
<p>同样的，可以直接暴力注释掉。</p>
<p><strong>第三次验证</strong></p>
<p>第三次完整性验证位于<code>aggressor.Aggressor</code>，此处验证与第一次验证函数调用相同，都是调用<code>commom.Starter.initializeStarter</code>，因此无需其他修改。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/7310a58f963742eaa3ef060a02ca4802.png" srcset="/img/loading.gif" lazyload alt="image-20230925162839842"></p>
<p><strong>第四次验证</strong></p>
<p>在<code>ConnectDialog</code>处，还存在第四处完整性校验，<code>ConnectDialog</code>初始化时调用<code>initialize</code>进行校验。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/6947b419be274e609d2fc65c34b9b722.png" srcset="/img/loading.gif" lazyload alt="image-20230925161514874"></p>
<p><img src="https://img-blog.csdnimg.cn/direct/f3129d96b1a54cf1bcea5e199381936e.png" srcset="/img/loading.gif" lazyload alt="image-20230925161609042"></p>
<p>此处校验代码位于<code>commom.Starter2.A(Class var1)</code>，与第一次校验类似，同样是验证crc码，唯一不同是crc码位于<code>commom.Starter2.A(Object var1)</code>，此处验证文件包括：</p>
<ul>
<li><code>common/Starter.class</code></li>
<li><code>common/Initializer.class</code></li>
<li><code>aggressor/Aggressor.class</code></li>
<li><code>common/AggressorInfo.class</code></li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/direct/9dbc77ded89e4b41936944bfe9235ab2.png" srcset="/img/loading.gif" lazyload alt="image-20230925161955593"></p>
<h3 id="完整性验证文件列表"><a href="#完整性验证文件列表" class="headerlink" title="完整性验证文件列表"></a>完整性验证文件列表</h3><p>实际上类似的验证非常多，因此我们可以在整个项目中搜索<code>system.exit(1)</code>，查看与之相关的验证，以下罗列了部分验证位置：</p>
<ul>
<li><code>conslole.StatusBar.A(Class var0)</code></li>
<li><code>aggressor.Prefs.A(Class var0)</code></li>
<li><code>common.Helper.startHelper</code></li>
</ul>
<h3 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1702583-1-1.html">https://www.52pojie.cn/thread-1702583-1-1.html</a></p>
<h2 id="CobaltStrike-生成ShellCode"><a href="#CobaltStrike-生成ShellCode" class="headerlink" title="CobaltStrike 生成ShellCode"></a>CobaltStrike 生成ShellCode</h2><p>​		CS是使用Swing进行UI开发的，我们可以直接在<code>aggressor\dialogs</code>文件夹中直接找对话框对应操作类，例如<code>aggressor\dialogs\WindowsExecutableDialog.java</code>就是<code>Windows stage payload</code>的操作类。</p>
<p><code>dialogAction()</code>即为点击生成按钮后的触发函数，可以看到<code>dialogAction()</code>获取到架构，通过<code>ListenerUtils.getListener</code>获取监听器，之后通过<code>getPayloadStager()</code>获取payload，最后通过<code>sanveFile()</code>保存文件。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">protected</span> byte[] stager;<br><br><span class="hljs-keyword">public</span> WindowsExecutableDialog(AggressorClient var1) &#123;<br>   <span class="hljs-keyword">this</span>.client = var1;<br>&#125;<br><br><span class="hljs-keyword">public</span> void dialogAction(ActionEvent var1, Map var2) &#123;<br>   <span class="hljs-keyword">this</span>.options = var2;<br>   boolean var3 = DialogUtils.bool(var2, <span class="hljs-string">&quot;x64&quot;</span>);<br>   String var4 = DialogUtils.string(var2, <span class="hljs-string">&quot;listener&quot;</span>);<br>   ScListener var5 = ListenerUtils.getListener(<span class="hljs-keyword">this</span>.client, var4);<br>   <span class="hljs-keyword">if</span> (var5 == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">this</span>.dialog.setVisible(<span class="hljs-literal">true</span>);<br>      DialogUtils.showError(<span class="hljs-string">&quot;A listener was not selected&quot;</span>);<br>   &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">this</span>.stager = var5.getPayloadStager(var3 ? <span class="hljs-string">&quot;x64&quot;</span> : <span class="hljs-string">&quot;x86&quot;</span>);<br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.stager.length == <span class="hljs-number">0</span>) &#123;<br>         <span class="hljs-keyword">this</span>.dialog.setVisible(<span class="hljs-literal">true</span>);<br>         DialogUtils.showError(<span class="hljs-string">&quot;No &quot;</span> + (var3 ? <span class="hljs-string">&quot;x64&quot;</span> : <span class="hljs-string">&quot;x86&quot;</span>) + <span class="hljs-string">&quot; stager for &quot;</span> + var4);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>         String var6 = var2.<span class="hljs-keyword">get</span>(<span class="hljs-string">&quot;output&quot;</span>) + <span class="hljs-string">&quot;&quot;</span>;<br>         String var7 = <span class="hljs-string">&quot;&quot;</span>;<br>         <span class="hljs-keyword">if</span> (var6.indexOf(<span class="hljs-string">&quot;EXE&quot;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>            var7 = <span class="hljs-string">&quot;artifact.exe&quot;</span>;<br>         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var6.indexOf(<span class="hljs-string">&quot;DLL&quot;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>            var7 = <span class="hljs-string">&quot;artifact.dll&quot;</span>;<br>         &#125;<br><br>         SafeDialogs.saveFile((JFrame)<span class="hljs-literal">null</span>, var7, <span class="hljs-keyword">this</span>);<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>getPayloadStager()</code>方法调用<code>aggressor\DataUtils.shellcode()</code>，最终在<code>stagers\Stagers.shellcode()</code>根据监听器类型动态生成<code>Stager</code>类，例如Beacon http监听器的<code>Stager</code>类为<code>BeaconHTTPStagerX64</code>，其继承自相应的<code>GenericHTTPStager</code>，并由<code>generate() </code>生成shellcode。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">public</span> byte[] getPayloadStager(String var1) &#123;<br>   <span class="hljs-keyword">return</span> Stagers.shellcode(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.getPayload(), var1);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> byte[] <span class="hljs-title function_">shellcode</span>(<span class="hljs-params"><span class="hljs-title class_">ScListener</span> var0, <span class="hljs-title class_">String</span> var1, <span class="hljs-title class_">String</span> var2</span>) &#123;<br>   <span class="hljs-title class_">GenericStager</span> var3 = A.<span class="hljs-title function_">resolve</span>(var0, var1, var2);<br>   <span class="hljs-keyword">return</span> var3 != <span class="hljs-literal">null</span> ? var3.<span class="hljs-title function_">generate</span>() : <span class="hljs-keyword">new</span> byte[<span class="hljs-number">0</span>];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在<code>GenericHTTPStager.generate()</code>中，程序读取<code>resources/httpstager64.bin</code>，并根据监听器的host和port等值组合为Packer，最终替换到多个X、Y占位的bin文件中，最后返回bytes[] 类型的shellcode。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">   <span class="hljs-keyword">public</span> byte[] generate() &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>         InputStream var1 = CommonUtils.resource(<span class="hljs-keyword">this</span>.getStagerFile());<br>         byte[] var2 = CommonUtils.readAll(var1);<br>         String var3 = CommonUtils.bString(var2);<br>         var1.close();<br>         var3 = var3 + <span class="hljs-keyword">this</span>.getListener().getStagerHost() + <span class="hljs-string">&#x27;\u0000&#x27;</span>;<br>         Packer var4 = new Packer();<br>         var4.little();<br>         var4.addShort(<span class="hljs-keyword">this</span>.getListener().getPort());<br>         AssertUtils.TestPatchS(var2, <span class="hljs-number">4444</span>, <span class="hljs-keyword">this</span>.getPortOffset());<br>         var3 = CommonUtils.replaceAt(var3, CommonUtils.bString(var4.getBytes()), <span class="hljs-keyword">this</span>.getPortOffset());<br>         var4 = new Packer();<br>         var4.little();<br>         var4.addInt(<span class="hljs-number">1453503984</span>);<br>         AssertUtils.TestPatchI(var2, <span class="hljs-number">1453503984</span>, <span class="hljs-keyword">this</span>.getExitOffset());<br>         var3 = CommonUtils.replaceAt(var3, CommonUtils.bString(var4.getBytes()), <span class="hljs-keyword">this</span>.getExitOffset());<br>         var4 = new Packer();<br>         var4.little();<br>         var4.addShort(<span class="hljs-keyword">this</span>.getStagePreamble());<br>         AssertUtils.TestPatchS(var2, <span class="hljs-number">5555</span>, <span class="hljs-keyword">this</span>.getSkipOffset());<br>         var3 = CommonUtils.replaceAt(var3, CommonUtils.bString(var4.getBytes()), <span class="hljs-keyword">this</span>.getSkipOffset());<br>         var4 = new Packer();<br>         var4.little();<br>         var4.addInt(<span class="hljs-keyword">this</span>.getConnectionFlags());<br>         AssertUtils.TestPatchI(var2, <span class="hljs-keyword">this</span>.isSSL() ? -<span class="hljs-number">2069876224</span> : -<span class="hljs-number">2074082816</span>, <span class="hljs-keyword">this</span>.getFlagsOffset());<br>         var3 = CommonUtils.replaceAt(var3, CommonUtils.bString(var4.getBytes()), <span class="hljs-keyword">this</span>.getFlagsOffset());<br>         String var5;<br>         <span class="hljs-keyword">if</span> (CommonUtils.isin(CommonUtils.repeat(<span class="hljs-string">&quot;X&quot;</span>, <span class="hljs-number">303</span>), var3)) &#123;<br>            var5 = <span class="hljs-keyword">this</span>.getConfig().pad(<span class="hljs-keyword">this</span>.getHeaders() + <span class="hljs-string">&#x27;\u0000&#x27;</span>, <span class="hljs-number">303</span>);<br>            var3 = CommonUtils.replaceAt(var3, var5, var3.indexOf(CommonUtils.repeat(<span class="hljs-string">&quot;X&quot;</span>, <span class="hljs-number">127</span>)));<br>         &#125;<br><br>         int var6 = var3.indexOf(CommonUtils.repeat(<span class="hljs-string">&quot;Y&quot;</span>, <span class="hljs-number">79</span>), <span class="hljs-number">0</span>);<br>         var5 = <span class="hljs-keyword">this</span>.getConfig().pad(<span class="hljs-keyword">this</span>.getURI() + <span class="hljs-string">&#x27;\u0000&#x27;</span>, <span class="hljs-number">79</span>);<br>         var3 = CommonUtils.replaceAt(var3, var5, var6);<br>         <span class="hljs-keyword">return</span> CommonUtils.toBytes(var3 + <span class="hljs-keyword">this</span>.getConfig().getWatermark());<br>      &#125; <span class="hljs-keyword">catch</span> (IOException var7) &#123;<br>         MudgeSanity.logException(<span class="hljs-string">&quot;HttpStagerGeneric: &quot;</span> + <span class="hljs-keyword">this</span>.getStagerFile(), var7, <span class="hljs-literal">false</span>);<br>         <span class="hljs-keyword">return</span> new byte[<span class="hljs-number">0</span>];<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="CVE-2022-39197"><a href="#CVE-2022-39197" class="headerlink" title="CVE-2022-39197"></a>CVE-2022-39197</h2><p>CVE-2022-39197是由于xss引起的，因此我们可以才采用转义手段，将传入的字符串及进行转义，避免xss攻击。</p>
<p>修改位置<code>common.BeaconEntry.update</code></p>
<p><img src="https://img-blog.csdnimg.cn/direct/abeca3947c3d49c7b35c2f1a7380fd3a.png" srcset="/img/loading.gif" lazyload alt="image-20231001135114168"></p>
<p>提取自cs 4.8的转义代码<code>common.CommonHTMLUtils</code></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">package</span> common;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonHTMLUtils</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">potentialXSS</span><span class="hljs-params">(String var0)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (var0 == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var0.contains(<span class="hljs-string">&quot;&lt;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var0.contains(<span class="hljs-string">&quot;&gt;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var0.contains(<span class="hljs-string">&quot;&amp;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var0.contains(<span class="hljs-string">&quot;&#x27;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-function"><span class="hljs-keyword">return</span> var0.<span class="hljs-title">contains</span><span class="hljs-params">(<span class="hljs-string">&quot;\&quot;&quot;</span>)</span></span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">potentialUserNameXSS</span><span class="hljs-params">(String var0)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (var0 == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var0.contains(<span class="hljs-string">&quot;&lt;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var0.contains(<span class="hljs-string">&quot;&gt;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var0.contains(<span class="hljs-string">&quot;&amp;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-function"><span class="hljs-keyword">return</span> var0.<span class="hljs-title">contains</span><span class="hljs-params">(<span class="hljs-string">&quot;\&quot;&quot;</span>)</span></span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function">String <span class="hljs-title">escapeHtml</span><span class="hljs-params">(String var0)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (var0 == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">int</span> var1 = var0.length();<br>            <span class="hljs-keyword">int</span> var2 = (<span class="hljs-keyword">int</span>)((<span class="hljs-keyword">double</span>)var1 * <span class="hljs-number">1.3</span>);<br>            StringBuilder var3 = <span class="hljs-keyword">new</span> StringBuilder(var2);<br><br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> var4 = <span class="hljs-number">0</span>; var4 &lt; var1; ++var4) &#123;<br>                <span class="hljs-keyword">char</span> var5 = var0.charAt(var4);<br>                <span class="hljs-keyword">if</span> (var5 == <span class="hljs-string">&#x27;&lt;&#x27;</span>) &#123;<br>                    var3.append(<span class="hljs-string">&quot;&amp;lt;&quot;</span>);<br>                &#125; <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(var5 == <span class="hljs-string">&#x27;&gt;&#x27;</span>)</span> </span>&#123;<br>                    var3.append(<span class="hljs-string">&quot;&amp;gt;&quot;</span>);<br>                &#125; <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(var5 == <span class="hljs-string">&#x27;&quot;&#x27;</span>)</span> </span>&#123;<br>                    var3.append(<span class="hljs-string">&quot;&amp;quot;&quot;</span>);<br>                &#125; <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(var5 == <span class="hljs-string">&#x27;&amp;&#x27;</span>)</span> </span>&#123;<br>                    var3.append(<span class="hljs-string">&quot;&amp;amp;&quot;</span>);<br>                &#125; <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(var5 &gt;= <span class="hljs-string">&#x27; &#x27;</span> &amp;&amp; var5 != <span class="hljs-string">&#x27;\&#x27;&#x27;</span>)</span> </span>&#123;<br>                    <span class="hljs-keyword">int</span> var6 = var5 &amp; <span class="hljs-string">&#x27;\uffff&#x27;</span>;<br>                    <span class="hljs-keyword">if</span> (var6 &gt; <span class="hljs-number">127</span>) &#123;<br>                        var3.append(<span class="hljs-string">&quot;&amp;#&quot;</span>).append(var6).append(<span class="hljs-string">&#x27;;&#x27;</span>);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        var3.append(var5);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    var3.append(<span class="hljs-string">&quot;&amp;#&quot;</span>).append(var5).append(<span class="hljs-string">&#x27;;&#x27;</span>);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-function"><span class="hljs-keyword">return</span> var3.<span class="hljs-title">toString</span><span class="hljs-params">()</span></span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="参考链接-2"><a href="#参考链接-2" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2220765">https://cloud.tencent.com/developer/article/2220765</a></p>
<h2 id="CobaltStrike-profile参数介绍"><a href="#CobaltStrike-profile参数介绍" class="headerlink" title="CobaltStrike profile参数介绍"></a>CobaltStrike profile参数介绍</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>

<ul>
<li><code>set sample_name &quot;name&quot;；</code>：设置配置文件名称，此处会显示在输出的报告中。</li>
<li><code>set sleeptime &quot;45000&quot;;</code>：设置休眠时间，单位毫秒。</li>
<li><code>set jitter &quot;49&quot;;</code>：设置抖动频率，单位%。</li>
<li><code>set data_jitter &quot;100&quot;;</code>：设置请求数据抖动大小，单位字节。</li>
<li><code>set useragent &quot;agent&quot;;</code>：设置请求的UA。</li>
</ul>
<h3 id="http-get"><a href="#http-get" class="headerlink" title="http-get"></a>http-get</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>

<p>​		Beacon在执行后会通过get请求不断请求c2服务器以表明Beacon存活状态，http-get代码块中，client代表Beacon向服务器请求规则，server代表服务器向beacon端的响应规则，下面我们详细介绍个字段：</p>
<ul>
<li><p><code>set url &lt;url&gt;</code>：设置http-get通信所使用的url，如果设置多个，Beacon每次都会随机选择一个进行通信。</p>
</li>
<li><p><code>client</code>：Beacon向服务器请求规则。</p>
<ul>
<li><p><code>header</code>：设置http请求头</p>
</li>
<li><p><code>metadata</code>：设置元数据编码规则。</p>
<ul>
<li><p>CobaltStrike支持5中编码方案。RSA加密后的元数据经过编码处理后，可以方便地在网络协议中传输，CobaltStrike支持地编码方案为Base64、Base64url、Mask、NetBIOS、NetBIOSU，在<code>metadata</code>可以设置多种编码方案，每行一种，CobaltStrike会按照顺序依次进行编码。</p>
</li>
<li><p><code>prepend</code>：将指定字符串加载头部。</p>
</li>
<li><p><code>append</code>：将指定字符串附加在末尾。</p>
</li>
<li><p><code>header</code>：编码完成数据最终存放位置，例如<code>header &quot;Cookie&quot;</code>表示存放在请求头地<code>Cookie</code>字段，我们使用<code>c2lint</code>可以查看具体访问信息。实际上<code>header</code>这种关键字在CobaltStrike中被称为终止关键字，其他详细信息见终止关键字一节。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/b049dbd0acdd4abfb4634b2c525ec167.png" srcset="/img/loading.gif" lazyload alt="image-20231102161129064"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>server</code>：server代表服务器向beacon端的响应规则，配置与<code>client</code>类似，这里不展开介绍。</p>
</li>
</ul>
<h3 id="http-post"><a href="#http-post" class="headerlink" title="http-post"></a>http-post</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>

<p>​		Beacon在执行时一般会先通过http get请求与c2服务器建立连接，如果c2想要在Beacon中执行命令，会在get请求返回包中发送任务，其中包括此任务地id和任务的具体内容。Beacon在执行完任务后会通过http post请求回传结果，post请求中包括任务id和执行结果，因此在http-post规则配置中要比http-get多一个关于任务id的控制块。</p>
<ul>
<li>client<ul>
<li>id：配置任务id规则。<ul>
<li><code>parameter</code>：将数据存放在指定url参数中，例如<code>parameter &quot;id&quot;;</code>代表将任务id放在url参数中<code>?id=id</code>中。</li>
<li><code>output</code>：任务执行结果规则，例如<code>output &#123;base64;print;&#125;</code>表示将执行结果base64编码后存储在body中，<code>print</code>表示编码结束并指定数据存放位置。</li>
</ul>
</li>
</ul>
</li>
<li>server</li>
</ul>
<h3 id="其他规则"><a href="#其他规则" class="headerlink" title="其他规则"></a>其他规则</h3><h4 id="终止关键字"><a href="#终止关键字" class="headerlink" title="终止关键字"></a>终止关键字</h4><p>​		数据编码完成后由终止关键字表明后续不要其他编码并指定存放位置，CobaltStrike支持的终止关键字有：</p>
<ul>
<li><code>header &quot;header&quot;</code>：将数据存放在指定HTTP请求头中。</li>
<li><code>parameter &quot;key&quot;</code>：将数据存放在指定URL请求参数中。</li>
<li><code>print</code>：将数据存放在http body中。</li>
<li><code>uri-append</code>：将数据直接拼接到URL后面</li>
</ul>
<blockquote>
<p><code>http-get.client.metadata</code>不能使用<code>print</code>，不在范围内。</p>
<p><code>http-get.server.output</code>、<code>http-post.server.output</code>、<code>http-stager.server.output</code>只能使用<code>print</code>终止关键字。</p>
</blockquote>
<h3 id="参考链接-3"><a href="#参考链接-3" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://wbglil.gitbook.io/cobalt-strike/cobalt-strikekuo-zhan/malleable-c2">Malleable C2</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40412037/article/details/126208502">Cobalt Strike 的 Profile 文件解析</a></p>
<h2 id="Artifact-Kit安装"><a href="#Artifact-Kit安装" class="headerlink" title="Artifact Kit安装"></a>Artifact Kit安装</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>​		Artifact Kit 是一个制作免杀 EXE、DLL 和 Service EXE 的源代码框架，在 Cobalt Strike 的 <code>Help --&gt; Arsenal</code> 处可下载 Artifact Kit。</p>
<p>Cobalt Strike在生成木马时会自动调用Artifact Kit。</p>
<h3 id="食用方法"><a href="#食用方法" class="headerlink" title="食用方法"></a>食用方法</h3><ul>
<li>修改配置，在<code>/Arsenal/arsenal_kit.config</code>可以修改构建配置，默认只构建<code>artifact_kit</code>。</li>
<li>安装编译环境：<code>sudo apt-get install mingw-w64</code>。</li>
<li>构建工件：执行<code>/Arsenal/build_arsenal_kit.sh</code>，不报错的话会在<code>/Arsenal/</code>生成构建好的工件。</li>
<li>Load 加载 <code>/Arsenal/artifact/dist-peek/artifact.cna</code> 插件，之后在 <code>Attacks -&gt; Packages -&gt; Windows Executable</code> 中生成木马文件。</li>
<li>之后在<code>payloads -&gt; Windows Stager payload</code>正常生成木马即可，脚本会自动进行替换，当然可以在<code>Cobalt Strike -&gt; Script Console</code>查看到替换日志输出。</li>
</ul>
<h3 id="实验效果"><a href="#实验效果" class="headerlink" title="实验效果"></a>实验效果</h3><p>使用<code>Artifact Kit</code>生成的Stagerless马，竟然能够直接免杀火绒、360，上线直接没反应，啊这。。。。。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/d58ce23f370140c98c77a60c1cbdf327.png" srcset="/img/loading.gif" lazyload alt="image-20231029094155837"></p>
<p><img src="https://img-blog.csdnimg.cn/direct/9c7718b9bd1945cfb05e7bb60689d760.png" srcset="/img/loading.gif" lazyload alt="image-20231029101609991"></p>
<p><img src="https://img-blog.csdnimg.cn/direct/cf7834605e184a28830e99e302b29b3b.png" srcset="/img/loading.gif" lazyload alt="image-20231029101624166"></p>
<h3 id="疑似bug"><a href="#疑似bug" class="headerlink" title="疑似bug"></a>疑似bug</h3><p>​		<code>kits/artifact/build.sh</code>似乎存在bug，报错<code>语法错误：无效的算术运算符</code>，按理说官方文件不应该会出现这种问题，可能是我linux环境有问题，大家各自构建一下，不报错就没问题，如果大家遇到同样的问题，可以将下面的函数替换掉<code>kits/artifact/build.sh</code>的同名函数。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs routeros">function check_alignment () &#123;<br>   # This will check the file size <span class="hljs-keyword">and</span> <span class="hljs-built_in">print</span> an <span class="hljs-built_in">error</span> when the<br>   # size is <span class="hljs-keyword">not</span> a multiple of 4-bytes.<br>   # Same as the following command:<br>   #    ls -l dist-pipe | grep -v cna | awk <span class="hljs-string">&#x27;($5 % 4) != 0 &#123;print $5 &quot;\t&quot; $9 &quot;\t Is not 4-byte aligned.&quot;&#125;&#x27;</span><br>   <span class="hljs-attribute">files</span>=$(ls -l <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;1&#125;</span>&quot;</span> | egrep -v <span class="hljs-string">&quot;cna|total&quot;</span>)<br>   <span class="hljs-attribute">i</span>=-2;<br>   <span class="hljs-attribute">size</span>=0;<br>   <span class="hljs-attribute">file</span>=<span class="hljs-string">&quot;&quot;</span>;<br>   <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;files&#125;</span> ; <span class="hljs-keyword">do</span><br>      <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$i</span> -lt 0 ] ; then<br>         # 前两次迭代跳过<br>         <span class="hljs-attribute">i</span>=$((i + 1))<br>         continue<br>      fi<br>      <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$&#123;i&#125;</span> == 4 ] ; then<br>         <span class="hljs-attribute">size</span>=<span class="hljs-variable">$&#123;f&#125;</span><br>      elif [ <span class="hljs-variable">$&#123;i&#125;</span> == 8 ] ; then<br>         <span class="hljs-attribute">file</span>=<span class="hljs-variable">$&#123;f&#125;</span><br>         <span class="hljs-keyword">if</span> [ $((<span class="hljs-variable">$&#123;size&#125;</span> % 4)) != 0 ] ; then<br>            print_warning <span class="hljs-string">&quot;[OPSEC] <span class="hljs-variable">$&#123;f&#125;</span> is not 4-byte aligned. Check the compiler options.&quot;</span><br>         fi<br>         <span class="hljs-attribute">i</span>=-8<br>      fi<br>      <span class="hljs-attribute">i</span>=$(($i + 1))<br>   done<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CobaltStrike通信过程详解"><a href="#CobaltStrike通信过程详解" class="headerlink" title="CobaltStrike通信过程详解"></a>CobaltStrike通信过程详解</h2><p>CobaltStrike通信流程一般步骤为：</p>
<ul>
<li>使用内置公钥加密aes密钥和beacon基础信息发送至服务端</li>
<li>服务端通过私钥解密后，通过获取到的aes密钥进行后续加密通信。</li>
</ul>
<p>这里我们直接先介绍beacon使用公钥加密的数据内容。</p>
<p>当服务端收到来自beacon的数据请求时，会将原始数据发送至<code>beacon.BeaconC2.process_beacon_metadata</code>函数进行处理：</p>
<p><img src="https://img-blog.csdnimg.cn/direct/4139400d240b4f54b0906f85d6945ed2.png" srcset="/img/loading.gif" lazyload alt="image-20231203195958163"></p>
<p><code>this.getAsymmetricCrypto().decrypt(var3)</code>为私钥解密过程，跟进查看</p>
<p><img src="https://img-blog.csdnimg.cn/direct/3aebebb4b2a448f7ba2e177da3a3e36c.png" srcset="/img/loading.gif" lazyload alt="image-20231203200137114"></p>
<p>这里展示的是CS4.5版本的<code>this.getAsymmetricCrypto().decrypt(var3)</code>，因为4.5版本后，CS就没有现成的服务端源码了，基本逻辑也大差不差，问题倒不是很大，可以看到经过<code>this.cipher.doFinal</code>解密数据存放在<code>var2</code>中，后续判断<code>Magic number</code>，以及读取了后续相应内容。</p>
<p>综上所诉，CS首次通信内容格式如下所示：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs abnf">struct &#123;<br>DWORD MagicNum<span class="hljs-comment">; // Magic Num, 默认48879</span><br>DWORD DataLen<span class="hljs-comment">;  // 接下来数据长度</span><br>BYTE [<span class="hljs-number">20</span>]<span class="hljs-comment">;</span><br>DWORD ClientID<span class="hljs-comment">;</span><br>DWORD ProcessID<span class="hljs-comment">;</span><br>WORD Port<span class="hljs-comment">;</span><br>BYTE Flag<span class="hljs-comment">; // 8bit，每bit代表含义如下（/前表示该比特为0表示含义）：/ / / / hith_pric:no/yes is64:no/yes barch:x86/x64 /</span><br>BYTE MajorVersion<span class="hljs-comment">;</span><br>BYTE MinorVersion<span class="hljs-comment">;</span><br>WORD Build<span class="hljs-comment">;</span><br>BYTE Base[<span class="hljs-number">4</span>]<span class="hljs-comment">;</span><br>BYTE Gmh[<span class="hljs-number">4</span>]<span class="hljs-comment">;</span><br>BYTE Gpa[<span class="hljs-number">4</span>]<span class="hljs-comment">;</span><br>DWORD IP<span class="hljs-comment">; // 小端存放，其余为大端存放</span><br><br>BYTE [] <span class="hljs-operator">=</span><span class="hljs-string">&quot;&lt;&lt;hostname&gt;&gt;\t&lt;&lt;user&gt;&gt;\t&lt;&lt;processName&gt;&gt;&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="TeamServerImage-逆向"><a href="#TeamServerImage-逆向" class="headerlink" title="TeamServerImage 逆向"></a>TeamServerImage 逆向</h2><p>​		从CS4.5开始，CS服务端便使用Graalvm进行的加密处理，虽然Graalvm将大部分符号都进行了处理，但是函数的逻辑相对变化不大，因此我们可以通过client源代码判断部分函数特征，这里记录了原始函数对应的判断特征：</p>
<h3 id="common-AuthCrypto-decrypt"><a href="#common-AuthCrypto-decrypt" class="headerlink" title="common.AuthCrypto.decrypt"></a>common.AuthCrypto.decrypt</h3><p>在<code>common.AuthCrypto.decrypt</code>存在强特征，直接在<code>ida</code>中搜索<code>BB C0 FE CA</code>（-889274181对应的小端16进制）或<code>D3 C0 FE CA</code>（-889274157对应的小端16进制），存在<code>cmp</code>指令即为该处。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/a16d9639fbf64560a5801f936478cfca.png" srcset="/img/loading.gif" lazyload alt="image-20231203202921523"></p>
<p><img src="https://img-blog.csdnimg.cn/direct/b41fc02727784cd5b677b5277eee2743.png" srcset="/img/loading.gif" lazyload alt="image-20231203203207426"></p>
<h3 id="dns-AsymmetricCrypto-decrypt"><a href="#dns-AsymmetricCrypto-decrypt" class="headerlink" title="dns.AsymmetricCrypto.decrypt"></a>dns.AsymmetricCrypto.decrypt</h3><p>在<code>dns.AsymmetricCrypto.decrypt</code>存在<code>Magic number</code>强特征，直接在<code>ida</code>中搜索<code>EF BE 00 00</code>（48879对应的小端16进制），存在<code>cmp</code>指令即为该处。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/c265299c704d404dbe21bcddd98e0841.png" srcset="/img/loading.gif" lazyload alt="image-20231203201622035"></p>
<p><img src="https://img-blog.csdnimg.cn/direct/43ae1d75ef6b465fafda059e48ca944e.png" srcset="/img/loading.gif" lazyload alt="image-20231203201829001"></p>
<p>由于，服务端与客户端代码基本类似，因此我们可以以该函数为起点，逆向分析其他功能函数，做相应修改即可。</p>
<blockquote>
<p>实际上，存在更加简单方法，我们直接搜索替换二进制文件的RAS密钥就破解完成了，哈哈，偷鸡成功。</p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%99%E7%A8%8B%E6%96%87%E6%A1%A3/" class="category-chain-item">教程文档</a>
  
  

      </span>
    
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%B7%A5%E5%85%B7/" class="category-chain-item">工具</a>
  
  
    <span>></span>
    
  <a href="/categories/%E5%B7%A5%E5%85%B7/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7/" class="category-chain-item">渗透工具</a>
  
  

  

      </span>
    
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%80%86%E5%90%91/" class="category-chain-item">逆向</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%95%99%E7%A8%8B/" class="print-no-link">#教程</a>
      
        <a href="/tags/Cobalt-Strike/" class="print-no-link">#Cobalt Strike</a>
      
        <a href="/tags/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3/" class="print-no-link">#逆向破解</a>
      
        <a href="/tags/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7/" class="print-no-link">#渗透工具</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Cobalt Strike逆向教程</div>
      <div>https://genioco.github.io/2023/09/23/Guide/Cobalt Strike逆向教程/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>BadWolf</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年9月23日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/12/09/Guide/Openwrt%E7%BC%96%E8%AF%91%E6%95%99%E7%A8%8B/" title="Openwrt自编译教程">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Openwrt自编译教程</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/08/01/Guide/ProxmoxVE%E6%95%99%E7%A8%8B/" title="ProxmoxVE教程">
                        <span class="hidden-mobile">ProxmoxVE教程</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"genIoco/genIoco.github.io","repo-id":"R_kgDOMU-44w","category":"General","category-id":"DIC_kwDOMU-4484CgxC5","theme-light":"light","theme-dark":"dark","mapping":"og:title","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/js/DynamicRibbon.js"></script>
<script src="/js/leaves.js"></script>
<script src="/js/containsWord.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
